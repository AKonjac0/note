
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../../ADS/splay/">
      
      
        <link rel="next" href="../../general%20physics/General%20Pyhsics%20II/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.50">
    
    
      
        <title>computer organization and design - My Docs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.a40c8224.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="https://unpkg.com/katex@0/dist/katex.min.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#scpu" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="My Docs" class="md-header__button md-logo" aria-label="My Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            My Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              computer organization and design
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="blue"  aria-label="切换到暗色模式"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="切换到暗色模式" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="purple"  aria-label="切换到亮色模式"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="切换到亮色模式" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/akonjac0/note" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    Ako's Note
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../about/" class="md-tabs__link">
        
  
    
  
  About

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../ADS/Binomial%20Queue/" class="md-tabs__link">
          
  
  ADS

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="./" class="md-tabs__link">
          
  
  CO

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../general%20physics/General%20Pyhsics%20II/" class="md-tabs__link">
          
  
  General physics

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../misc/CTF/" class="md-tabs__link">
          
  
  Misc

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../my%20past/MCU/51/" class="md-tabs__link">
          
  
  My past

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../probability/martingale%20and%20stopping%20times/" class="md-tabs__link">
          
  
  Probability

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../x86asm/ASM/" class="md-tabs__link">
          
  
  X86asm

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="My Docs" class="md-nav__button md-logo" aria-label="My Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    My Docs
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/akonjac0/note" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    Ako's Note
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    ADS
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            ADS
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/Binomial%20Queue/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Binomial Queue
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/Galois%20Field/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Galois Field
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/IFI/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    IFI
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/Master%20Theorem/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Master Theorem
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/Misra-Gries/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Misra-Gries
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/NPC%20and%20Approximation%20and%20Local%20Search/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NPC and Approximation and Local Search
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/SkipList/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Skip List
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/WBLT/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    WBLT
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/amortized%20analysis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    amortized analysis
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/binet%20cauchy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Binet-Cauchy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/cardinality%20of%20sets/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cardinality of sets
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/computation%20problem/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    computation problem
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/convex/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    convex
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/error%20correction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    error correction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/external%20sorting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    external sorting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/group%20theory/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    group theory
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/linear%20programming/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    linear programming
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/parallel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    parallel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/randomized/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    randomized
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/red%20black%20tree/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    red black tree
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/scapegoat%20tree/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    scapegoat
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/searching/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    searching
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/skew%20heap/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    skew heap
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/splay/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    splay
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    CO
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            CO
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    computer organization and design
  </span>
  

      </a>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    General physics
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            General physics
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../general%20physics/General%20Pyhsics%20II/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    General Pyhsics II
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../general%20physics/Schr%C3%B6dinger%20equation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Schrödinger equation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../general%20physics/quantum%20computation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    quantum computation
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Misc
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Misc
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/CTF/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF-WriteUp
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../misc/why%20r%20ur%20head%20sharp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    why r ur head sharp
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    My past
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            My past
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1" >
        
          
          <label class="md-nav__link" for="__nav_7_1" id="__nav_7_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    MCU
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1">
            <span class="md-nav__icon md-icon"></span>
            MCU
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/MCU/51/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    51单片机
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2" >
        
          
          <label class="md-nav__link" for="__nav_7_2" id="__nav_7_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    OI
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2">
            <span class="md-nav__icon md-icon"></span>
            OI
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/0.9loop%3D1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    0.999...=1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/01%E5%BA%8F%E5%88%97/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    将复杂序列问题转换成01序列求解的优化
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/2022%E6%95%B0%E8%81%94%E6%B8%B8%E8%AE%B0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022数联游记
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/AC%E8%87%AA%E5%8A%A8%E6%9C%BA/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AC自动机
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/CF1896D/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CF1896D
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/CRT/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    中国剩余定理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/CSP-S%202021/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CSP-S 2021
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/DLX/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Dancing Links X
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/FFT/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    快速傅里叶变换 FFT
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/Fast%20IO/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Fast io
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/Game%20with%20Marbles%20%28Hard%20Version%29/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CF1914E2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/MST/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    最小生成树MST
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/NOI%20Online%202022/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NOI Online 2022
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/P1633/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    P1633
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/STL/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    STL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/Trie/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Trie
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/algorithm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    algorithm
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/cstring/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cstring
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/dp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    期望dp
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/dp%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    dp常用方法
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/dp%E8%BD%AC%E7%A7%BB/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    dp转移
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/gcd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    欧几里得&amp;扩展欧几里得
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/kruskal%E9%87%8D%E6%9E%84%E6%A0%91/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    kruskal重构树
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/manacher/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    manacher算法
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/wqs%E4%BA%8C%E5%88%86/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    wqs二分
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/xor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    异或
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E4%B8%BB%E5%B8%AD%E6%A0%91/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    主席树
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E4%BA%8C%E5%88%86/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    二分
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E4%BA%8C%E7%BA%A7%E6%8C%87%E9%92%88/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    二维数组与二级指针
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E4%BC%98%E5%85%88%E9%98%9F%E5%88%97/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    优先队列/二叉堆
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E4%BC%98%E5%8C%96dp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    斜率优化dp
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E4%BD%8D%E8%BF%90%E7%AE%97/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    进制 &amp; 位运算
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E5%80%8D%E5%A2%9E/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    倍增
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E5%87%8F%E5%B0%91%E6%97%A0%E7%94%A8%E7%8A%B6%E6%80%81/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    减少无用状态
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E5%88%86%E6%B2%BB/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    分治
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E5%8C%BA%E9%97%B4dp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    区间dp总结
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E5%8F%8C%E6%8C%87%E9%92%88/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    尺取法 two-pointers
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E5%9B%BE%E8%AE%BA/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    图论
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E5%A4%8D%E6%9D%82%E5%BA%A6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    看似错误的复杂度的渐近处理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E5%B9%B6%E6%9F%A5%E9%9B%86/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    并查集
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E6%95%B0%E5%AD%A6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    泰勒级数
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E6%9C%80%E7%9F%AD%E8%B7%AF/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    最短路
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E6%9E%84%E9%80%A0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    构造
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E6%A0%91%E5%BD%A2dp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    树形dp总结
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E6%A0%91%E7%9A%84%E7%9B%B4%E5%BE%84/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    树的直径
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E6%A0%91%E9%93%BE%E5%89%96%E5%88%86/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    树链剖分
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E6%A8%A1%E6%8B%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    模拟
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E6%AC%A7%E6%8B%89%E5%87%BD%E6%95%B0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    欧拉函数
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E7%82%B9%E5%88%86%E6%B2%BB/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    点分治
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E7%8A%B6%E5%8E%8Bdp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    状压dp总结
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E7%9F%A9%E9%98%B5%E4%B9%98%E6%B3%95/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    矩阵乘法
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E7%A6%BB%E6%95%A3%E5%8C%96_%E5%93%88%E5%B8%8C/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    离散优化
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E7%BA%BF%E6%80%A7dp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    线性dp/普通dp
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E7%BA%BF%E6%80%A7%E4%BB%A3%E6%95%B0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    线性代数
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E7%BA%BF%E6%80%A7%E7%AD%9B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    欧拉筛
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E7%BA%BF%E6%AE%B5%E6%A0%91/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    线段树
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E7%BA%BF%E6%AE%B5%E6%A0%91%E5%90%88%E5%B9%B6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    线段树合并
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E7%BB%93%E6%9E%84%E4%BD%93/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    结构体
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E7%BC%A9%E7%82%B9/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    缩点
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E7%BD%91%E7%BB%9C%E6%B5%81/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    网络流
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E8%83%8C%E5%8C%85/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    背包总结
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E8%8E%AB%E6%AF%94%E4%B9%8C%E6%96%AF%E5%8F%8D%E6%BC%94/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    莫比乌斯反演
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E8%8E%AB%E9%98%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    莫队
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E8%99%9A%E6%A0%91/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    虚树
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E8%AE%B0%E5%BF%86%E5%8C%96%E6%90%9C%E7%B4%A2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    记忆化搜索
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E8%B4%AA%E5%BF%83/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    贪心
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E9%80%86%E5%85%83/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    乘法逆元
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E9%80%92%E5%BD%92/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    递归 &amp; 递推
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E9%AB%98%E6%96%AF%E6%B6%88%E5%85%83/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    高斯消元
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/OI/%E9%AB%98%E7%B2%BE%E5%BA%A6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    高精度
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_3" >
        
          
          <label class="md-nav__link" for="__nav_7_3" id="__nav_7_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Bangumi
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_3">
            <span class="md-nav__icon md-icon"></span>
            Bangumi
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/bangumi/bangumi/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bangumi
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_4" >
        
          
          <label class="md-nav__link" for="__nav_7_4" id="__nav_7_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Python
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_4">
            <span class="md-nav__icon md-icon"></span>
            Python
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/python/Bongo%20Cat/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Python Bongo Cat
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/python/pokemon/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Python Pokemon自动刷怪
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/python/spider/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    python 爬虫总结
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../my%20past/python/tool/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Python常用库/工具
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Probability
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Probability
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../probability/martingale%20and%20stopping%20times/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    martingale and stopping times
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../probability/probability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    probability
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    X86asm
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            X86asm
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../x86asm/ASM/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    asm
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<p>自己设计的和标准的可能差的挺多, 仿真也不是特别完善, 导致可能有些 Bug 是没有发现但真实存在的</p>
<h1 id="scpu">SCPU</h1>
<h1 id="lab-4-1">Lab 4-1</h1>
<h2 id="_1">操作方法与实验步骤</h2>
<h3 id="_2">代码设计层次结构图及说明</h3>
<p><img alt="alt text" src="../../images/SCPU/image.png" /></p>
<p>SCPU 模块由 DataPath 和 SCPU_Ctrl 组成，其中 SCPU_Ctrl 模块以  inst[6:2], inst[14:12], inst[30]  作为输入，分别表示  OPcode, Fun3, Fun7 </p>
<p>DataPath 模块以 SCPU_Ctrl 的各个控制信号为输入，输出 ALU 得到的结果，输出到 RAM 的数据，以及程序指针 PC 的值</p>
<p>整体 SCPU 模块输入时钟信号  clk , 指令  inst  和 重置信号  rst  等，输出单周期 CPU 运行后的结果</p>
<h3 id="_3">源代码</h3>
<p><em>SCPU代码:</em></p>
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">SCPU</span><span class="p">(</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">clk</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">rst</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">MIO_ready</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="n">inst_in</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="n">Data_in</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="n">CPU_MIO</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="n">MemRW</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="n">PC_out</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="n">Data_out</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="n">Addr_out</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ALU_Control</span>
<span class="p">);</span>

<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ImmSel</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="n">ALUSrc_B</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">MemtoReg</span><span class="p">;</span><span class="w">   </span>
<span class="kt">wire</span><span class="w"> </span><span class="n">Jump</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="n">Branch</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="n">RegWrite</span><span class="p">;</span>
<span class="n">SCPU_ctrl</span><span class="w"> </span><span class="n">Ctrl</span><span class="p">(.</span><span class="n">OPcode</span><span class="p">(</span><span class="n">inst_in</span><span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">2</span><span class="p">]),</span><span class="w"> </span><span class="p">.</span><span class="n">Fun3</span><span class="p">(</span><span class="n">inst_in</span><span class="p">[</span><span class="mh">14</span><span class="o">:</span><span class="mh">12</span><span class="p">]),</span><span class="w"> </span><span class="p">.</span><span class="n">Fun7</span><span class="p">(</span><span class="n">inst_in</span><span class="p">[</span><span class="mh">30</span><span class="p">]),</span><span class="w"> </span>
<span class="w">    </span><span class="p">.</span><span class="n">MIO_ready</span><span class="p">(</span><span class="n">MIO_ready</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">ImmSel</span><span class="p">(</span><span class="n">ImmSel</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">ALUSrc_B</span><span class="p">(</span><span class="n">ALUSrc_B</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">MemtoReg</span><span class="p">(</span><span class="n">MemtoReg</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="p">.</span><span class="n">Jump</span><span class="p">(</span><span class="n">Jump</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Branch</span><span class="p">(</span><span class="n">Branch</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">RegWrite</span><span class="p">(</span><span class="n">RegWrite</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">MemRW</span><span class="p">(</span><span class="n">MemRW</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="p">.</span><span class="n">ALU_Control</span><span class="p">(</span><span class="n">ALU_Control</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CPU_MIO</span><span class="p">(</span><span class="n">CPU_MIO</span><span class="p">));</span>

<span class="n">DataPath</span><span class="w"> </span><span class="n">DP</span><span class="p">(.</span><span class="n">ImmSel</span><span class="p">(</span><span class="n">ImmSel</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">ALUSrc_B</span><span class="p">(</span><span class="n">ALUSrc_B</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">MemtoReg</span><span class="p">(</span><span class="n">MemtoReg</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="p">.</span><span class="n">Jump</span><span class="p">(</span><span class="n">Jump</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Branch</span><span class="p">(</span><span class="n">Branch</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">RegWrite</span><span class="p">(</span><span class="n">RegWrite</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">ALU_Control</span><span class="p">(</span><span class="n">ALU_Control</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Data_in</span><span class="p">(</span><span class="n">Data_in</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">inst_field</span><span class="p">(</span><span class="n">inst_in</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="p">.</span><span class="n">ALU_out</span><span class="p">(</span><span class="n">Addr_out</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Data_out</span><span class="p">(</span><span class="n">Data_out</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">PC_out</span><span class="p">(</span><span class="n">PC_out</span><span class="p">));</span>

<span class="k">endmodule</span>
</code></pre></div>
<p>在主体代码中进行了连线，将 SCPU_Ctrl 模块和 DataPath 模块相连接，并接好对应的输入输出</p>
<h1 id="lab-4-2">Lab 4-2</h1>
<h2 id="_4">操作方法与实验步骤</h2>
<h3 id="_5">代码设计层次结构图及说明</h3>
<p>DataPath 的结构图如下：</p>
<p><img alt="alt text" src="../../images/SCPU/image-1.png" /></p>
<p>DataPath 模块由以下子模块组成：RegFile, ALU, ImmGen</p>
<p>其中，RegFile 和 ALU 在 Lab 1 中完成，ImmGen 在本次实验中完成</p>
<p>ImmGen 模块的作用是，对于 SCPU 产生的  ImmSel  信号，根据  inst  产生对应的立即数，并送给后面的 ALU、RegFile 等模块</p>
<p>SCPU_Ctrl 模块的作用是，根据  inst  识别出指令格式，并根据不同指令产生对应的控制信号，送给 DataPath</p>
<h3 id="_6">源代码</h3>
<p><em>1. ImmGen 代码：</em></p>
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">ImmGen</span><span class="p">(</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">   </span><span class="n">ImmSel</span><span class="p">,</span><span class="w">     </span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">inst_field</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Imm_out</span>
<span class="p">);</span>

<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">ImmSel</span><span class="p">)</span>
<span class="w">      </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="o">:</span><span class="w"> </span><span class="c1">// I-type </span>
<span class="w">        </span><span class="n">Imm_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="mh">20</span><span class="p">{</span><span class="n">inst_field</span><span class="p">[</span><span class="mh">31</span><span class="p">]}},</span><span class="w"> </span><span class="n">inst_field</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">20</span><span class="p">]};</span><span class="w"> </span>

<span class="w">      </span><span class="mh">2</span><span class="mb">&#39;b01</span><span class="o">:</span><span class="w"> </span><span class="c1">// S-type</span>
<span class="w">        </span><span class="n">Imm_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="mh">20</span><span class="p">{</span><span class="n">inst_field</span><span class="p">[</span><span class="mh">31</span><span class="p">]}},</span><span class="w"> </span><span class="n">inst_field</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">25</span><span class="p">],</span><span class="w"> </span><span class="n">inst_field</span><span class="p">[</span><span class="mh">11</span><span class="o">:</span><span class="mh">7</span><span class="p">]};</span><span class="w"> </span><span class="c1">//</span>

<span class="w">      </span><span class="mh">2</span><span class="mb">&#39;b10</span><span class="o">:</span><span class="w"> </span><span class="c1">// B-type </span>
<span class="w">        </span><span class="n">Imm_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="mh">19</span><span class="p">{</span><span class="n">inst_field</span><span class="p">[</span><span class="mh">31</span><span class="p">]}},</span><span class="w"> </span><span class="n">inst_field</span><span class="p">[</span><span class="mh">31</span><span class="p">],</span><span class="w"> </span><span class="n">inst_field</span><span class="p">[</span><span class="mh">7</span><span class="p">],</span><span class="w"> </span>
<span class="w">        </span><span class="n">inst_field</span><span class="p">[</span><span class="mh">30</span><span class="o">:</span><span class="mh">25</span><span class="p">],</span><span class="w"> </span><span class="n">inst_field</span><span class="p">[</span><span class="mh">11</span><span class="o">:</span><span class="mh">8</span><span class="p">],</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">};</span><span class="w"> </span>

<span class="w">      </span><span class="mh">2</span><span class="mb">&#39;b11</span><span class="o">:</span><span class="w"> </span><span class="c1">// J-type </span>
<span class="w">        </span><span class="n">Imm_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="mh">11</span><span class="p">{</span><span class="n">inst_field</span><span class="p">[</span><span class="mh">31</span><span class="p">]}},</span><span class="w"> </span><span class="n">inst_field</span><span class="p">[</span><span class="mh">31</span><span class="p">],</span><span class="w"> </span><span class="n">inst_field</span><span class="p">[</span><span class="mh">19</span><span class="o">:</span><span class="mh">12</span><span class="p">],</span><span class="w"> </span>
<span class="w">        </span><span class="n">inst_field</span><span class="p">[</span><span class="mh">20</span><span class="p">],</span><span class="w"> </span><span class="n">inst_field</span><span class="p">[</span><span class="mh">30</span><span class="o">:</span><span class="mh">21</span><span class="p">],</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">};</span><span class="w"> </span><span class="c1">// </span>

<span class="w">    </span><span class="k">endcase</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">endmodule</span>
</code></pre></div>
<p>对于 I 型指令，将  inst[31:20]  做符号拓展即可得到最终立即数；</p>
<p>对于 S 型指令，将  inst[31:25],inst[11:7]  合并后做符号拓展即可得到最终立即数；</p>
<p>对于 B， J 型指令，将打乱的立即数部分重新拼接，合并后做符号拓展即可得到最终立即数；</p>
<p><em>2. SCPU_Ctrl 代码：</em></p>
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">SCPU_ctrls</span><span class="p">(</span>
<span class="w">  </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">       </span><span class="n">OPcode</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">       </span><span class="n">Fun3</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">             </span><span class="n">Fun7</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">             </span><span class="n">MIO_ready</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">ImmSel</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">        </span><span class="n">ALUSrc_B</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">MemtoReg</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">        </span><span class="n">Jump</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">        </span><span class="n">Branch</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">        </span><span class="n">RegWrite</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">        </span><span class="n">MemRW</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">ALU_Control</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">        </span><span class="n">CPU_MIO</span>
<span class="p">);</span>
<span class="k">initial</span><span class="w"> </span><span class="k">begin</span>
<span class="w">  </span><span class="n">ImmSel</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span>
<span class="w">  </span><span class="n">ALUSrc_B</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">  </span><span class="n">MemtoReg</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span><span class="c1">// 0: ALU result 1: Load from RAM to reg  2/3: PC4, JAL</span>
<span class="w">  </span><span class="n">Jump</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">  </span><span class="n">Branch</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">  </span><span class="n">RegWrite</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">  </span><span class="n">MemRW</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="c1">// write to / read from RAM</span>
<span class="w">  </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span>
<span class="k">end</span>
<span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>

<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">OPcode</span><span class="p">)</span>
<span class="w">    </span><span class="mh">5</span><span class="mb">&#39;b01100</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// R-type </span>
<span class="w">      </span><span class="n">ALUSrc_B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">MemtoReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span>
<span class="w">      </span><span class="n">RegWrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">      </span><span class="n">Jump</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">Branch</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="p">({</span><span class="n">Fun3</span><span class="p">,</span><span class="w"> </span><span class="n">Fun7</span><span class="p">})</span>
<span class="w">        </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span><span class="w"> </span><span class="c1">// ADD</span>
<span class="w">        </span><span class="mh">4</span><span class="mb">&#39;b0001</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0001</span><span class="p">;</span><span class="w"> </span><span class="c1">// SUB</span>
<span class="w">        </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="p">;</span><span class="w"> </span><span class="c1">// SLL</span>
<span class="w">        </span><span class="mh">4</span><span class="mb">&#39;b0100</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0011</span><span class="p">;</span><span class="w"> </span><span class="c1">// SLT</span>
<span class="w">        </span><span class="mh">4</span><span class="mb">&#39;b0110</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0100</span><span class="p">;</span><span class="w"> </span><span class="c1">// SLTU</span>
<span class="w">        </span><span class="mh">4</span><span class="mb">&#39;b1000</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0101</span><span class="p">;</span><span class="w"> </span><span class="c1">// XOR</span>
<span class="w">        </span><span class="mh">4</span><span class="mb">&#39;b1010</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0110</span><span class="p">;</span><span class="w"> </span><span class="c1">// SRL</span>
<span class="w">        </span><span class="mh">4</span><span class="mb">&#39;b1011</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0111</span><span class="p">;</span><span class="w"> </span><span class="c1">// SRA</span>
<span class="w">        </span><span class="mh">4</span><span class="mb">&#39;b1100</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b1000</span><span class="p">;</span><span class="w"> </span><span class="c1">// OR</span>
<span class="w">        </span><span class="mh">4</span><span class="mb">&#39;b1110</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b1001</span><span class="p">;</span><span class="w"> </span><span class="c1">// AND</span>
<span class="w">      </span><span class="k">endcase</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="mh">5</span><span class="mb">&#39;b00000</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// Load </span>
<span class="w">      </span><span class="n">ALUSrc_B</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">      </span><span class="n">MemtoReg</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b01</span><span class="p">;</span>
<span class="w">      </span><span class="n">RegWrite</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">      </span><span class="n">ImmSel</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span>
<span class="w">      </span><span class="n">MemRW</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="c1">// read</span>
<span class="w">      </span><span class="n">Jump</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">Branch</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span><span class="w"> </span><span class="c1">// ADD for address calculation</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="mh">5</span><span class="mb">&#39;b01000</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// Store </span>
<span class="w">      </span><span class="n">ALUSrc_B</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">      </span><span class="n">MemtoReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="p">&#39;</span><span class="n">bx</span><span class="p">;</span>
<span class="w">      </span><span class="n">RegWrite</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">ImmSel</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b01</span><span class="p">;</span>
<span class="w">      </span><span class="n">MemRW</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span><span class="w"> </span><span class="c1">// write</span>
<span class="w">      </span><span class="n">Jump</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">Branch</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span>
<span class="w">      </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span><span class="w"> </span><span class="c1">// ADD for address calculation</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="mh">5</span><span class="mb">&#39;b11000</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// Branch</span>
<span class="w">      </span><span class="n">ALUSrc_B</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">MemtoReg</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="p">&#39;</span><span class="n">bx</span><span class="p">;</span><span class="w"> </span><span class="c1">// new</span>
<span class="w">      </span><span class="n">RegWrite</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="c1">//</span>
<span class="w">      </span><span class="n">ImmSel</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b10</span><span class="p">;</span><span class="w"> </span>
<span class="w">      </span><span class="n">Branch</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">      </span><span class="n">Jump</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0001</span><span class="p">;</span><span class="w"> </span><span class="c1">// SUB for branch condition check</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="mh">5</span><span class="mb">&#39;b11011</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// JAL </span>
<span class="w">      </span><span class="n">ALUSrc_B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="p">&#39;</span><span class="n">bx</span><span class="p">;</span>
<span class="w">      </span><span class="n">MemtoReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b10</span><span class="p">;</span><span class="w"> </span><span class="c1">// PC + 4</span>
<span class="w">      </span><span class="n">RegWrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span><span class="w"> </span><span class="c1">//</span>
<span class="w">      </span><span class="n">ImmSel</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b11</span><span class="p">;</span>
<span class="w">      </span><span class="n">Branch</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">Jump</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="mh">5</span><span class="mb">&#39;b00100</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// I-type ALU</span>
<span class="w">      </span><span class="n">ALUSrc_B</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">      </span><span class="n">MemtoReg</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span>
<span class="w">      </span><span class="n">RegWrite</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">      </span><span class="n">ImmSel</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span>
<span class="w">      </span><span class="n">Jump</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">Branch</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">Fun3</span><span class="p">)</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span><span class="w"> </span><span class="c1">// ADDI</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b001</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="p">;</span><span class="w"> </span><span class="c1">// SLLI</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b010</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0011</span><span class="p">;</span><span class="w"> </span><span class="c1">// SLTI</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b011</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0100</span><span class="p">;</span><span class="w"> </span><span class="c1">// SLTIU</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b100</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0101</span><span class="p">;</span><span class="w"> </span><span class="c1">// XORI</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b101</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Fun7</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0111</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0110</span><span class="p">;</span><span class="w"> </span><span class="c1">// SRAI / SRLI</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b110</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b1000</span><span class="p">;</span><span class="w"> </span><span class="c1">// ORI</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b111</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b1001</span><span class="p">;</span><span class="w"> </span><span class="c1">// ANDI</span>
<span class="w">      </span><span class="k">endcase</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">endcase</span>
<span class="k">end</span>
<span class="k">endmodule</span>
</code></pre></div>
<p>为了支持 R 型指令(ALU), 我们添加  ALUSrc_B,ALU_Control  信号，当  ALUSrc_B=0  时选择寄存器  rs2  作为 ALU 计算的输入  B ;</p>
<p>ALU_Control  选择不同值时，ALU 会做不同的基本运算，并将结果输出</p>
<p>ALU_Control  与 Lab 1 中的 ALU 的操作值一一对应</p>
<p>同时添加  RegWrite  信号，控制 RegFile 写使能，来将 ALU 结果存到寄存器中</p>
<p>同时添加  MemtoReg  信号，控制写入寄存器的值， MemtoReg=0  表示将 ALU 结果写入寄存器</p>
<p>为了支持 I 型指令( Ld  和立即数 ALU 操作)，添加  ImmSel  信号，输入到  ImmGen  中，来选择不同类型的立即数；同时  ALUSrc_B=1  表示将立即数作为 ALU 第二个操作数  B </p>
<p>同时  Ld  指令中  MemtoReg=1  表示将内存中读取的值写入寄存器</p>
<p>为了支持  Sd  指令，添加  MemRW  信号， MemRW=1  控制内存写使能</p>
<p>为了支持  B,J  型指令，添加  Branch, Jump  信号，同时  MemtoReg=2  表示将  PC+4  写入寄存器</p>
<p><em>3. DataPath 代码：</em></p>
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">DataPaths</span><span class="p">(</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ImmSel</span><span class="p">,</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="n">ALUSrc_B</span><span class="p">,</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">MemtoReg</span><span class="p">,</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="n">Jump</span><span class="p">,</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="n">Branch</span><span class="p">,</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="n">RegWrite</span><span class="p">,</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ALU_Control</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Data_in</span><span class="p">,</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="n">clk</span><span class="p">,</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">inst_field</span><span class="p">,</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="n">rst</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg00</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg01</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg02</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg03</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg04</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg05</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg06</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg07</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg08</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg09</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg10</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg11</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg12</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg13</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg14</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg15</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg16</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg17</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg18</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg19</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg20</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg21</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg22</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg23</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg24</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg25</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg26</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg27</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg28</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg29</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg30</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg31</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ALU_out</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Data_out</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_out</span><span class="p">);</span>

<span class="kt">wire</span><span class="w"> </span><span class="n">and_2</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">and_2_out</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="n">ALU_zero</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">add_0</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ALU_A</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ALU_B</span><span class="p">;</span>
<span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC4</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_in</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ImmOut</span><span class="p">;</span>

<span class="k">assign</span><span class="w"> </span><span class="n">PC4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PC_out</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d4</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">and_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Branch</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ALU_zero</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">add_0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ImmOut</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PC_out</span><span class="p">;</span>


<span class="k">always</span><span class="w"> </span><span class="p">@</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">MemtoReg</span><span class="p">)</span>
<span class="w">        </span><span class="mh">2</span><span class="mi">&#39;d0</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALU_out</span><span class="p">;</span><span class="w"> </span><span class="c1">//</span>
<span class="w">        </span><span class="mh">2</span><span class="mi">&#39;d1</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Data_in</span><span class="p">;</span>
<span class="w">        </span><span class="mh">2</span><span class="mi">&#39;d2</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PC4</span><span class="p">;</span>
<span class="w">        </span><span class="mh">2</span><span class="mi">&#39;d3</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PC4</span><span class="p">;</span>
<span class="w">    </span><span class="k">endcase</span><span class="w">    </span>
<span class="k">end</span>

<span class="k">assign</span><span class="w"> </span><span class="n">ALU_B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALUSrc_B</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">ImmOut</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Data_out</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">and_2_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">and_2</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">add_0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">PC4</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">PC_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Jump</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">add_0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">and_2_out</span><span class="p">;</span>

<span class="n">ALU</span><span class="w"> </span><span class="n">alu</span><span class="p">(.</span><span class="n">A</span><span class="p">(</span><span class="n">ALU_A</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">B</span><span class="p">(</span><span class="n">ALU_B</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">ALU_operation</span><span class="p">(</span><span class="n">ALU_Control</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">res</span><span class="p">(</span><span class="n">ALU_out</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">zero</span><span class="p">(</span><span class="n">ALU_zero</span><span class="p">));</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">RS1</span><span class="p">,</span><span class="w"> </span><span class="n">RS2</span><span class="p">,</span><span class="w"> </span><span class="n">WT</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">RS1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst_field</span><span class="p">[</span><span class="mh">19</span><span class="o">:</span><span class="mh">15</span><span class="p">];</span>
<span class="k">assign</span><span class="w"> </span><span class="n">RS2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst_field</span><span class="p">[</span><span class="mh">24</span><span class="o">:</span><span class="mh">20</span><span class="p">];</span>
<span class="k">assign</span><span class="w"> </span><span class="n">WT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst_field</span><span class="p">[</span><span class="mh">11</span><span class="o">:</span><span class="mh">7</span><span class="p">];</span>
<span class="n">Regs</span><span class="w"> </span><span class="n">regs</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Rs1_addr</span><span class="p">(</span><span class="n">RS1</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Rs2_addr</span><span class="p">(</span><span class="n">RS2</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="p">.</span><span class="n">Wt_addr</span><span class="p">(</span><span class="n">WT</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Wt_data</span><span class="p">(</span><span class="n">reg_wt_data</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">RegWrite</span><span class="p">(</span><span class="n">RegWrite</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="p">.</span><span class="n">Rs1_data</span><span class="p">(</span><span class="n">ALU_A</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Rs2_data</span><span class="p">(</span><span class="n">Data_out</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg00</span><span class="p">(</span><span class="n">Reg00</span><span class="p">),.</span><span class="n">Reg01</span><span class="p">(</span><span class="n">Reg01</span><span class="p">),.</span><span class="n">Reg02</span><span class="p">(</span><span class="n">Reg02</span><span class="p">),.</span><span class="n">Reg03</span><span class="p">(</span><span class="n">Reg03</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg04</span><span class="p">(</span><span class="n">Reg04</span><span class="p">),.</span><span class="n">Reg05</span><span class="p">(</span><span class="n">Reg05</span><span class="p">),.</span><span class="n">Reg06</span><span class="p">(</span><span class="n">Reg06</span><span class="p">),.</span><span class="n">Reg07</span><span class="p">(</span><span class="n">Reg07</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg08</span><span class="p">(</span><span class="n">Reg08</span><span class="p">),.</span><span class="n">Reg09</span><span class="p">(</span><span class="n">Reg09</span><span class="p">),.</span><span class="n">Reg10</span><span class="p">(</span><span class="n">Reg10</span><span class="p">),.</span><span class="n">Reg11</span><span class="p">(</span><span class="n">Reg11</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg12</span><span class="p">(</span><span class="n">Reg12</span><span class="p">),.</span><span class="n">Reg13</span><span class="p">(</span><span class="n">Reg13</span><span class="p">),.</span><span class="n">Reg14</span><span class="p">(</span><span class="n">Reg14</span><span class="p">),.</span><span class="n">Reg15</span><span class="p">(</span><span class="n">Reg15</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg16</span><span class="p">(</span><span class="n">Reg16</span><span class="p">),.</span><span class="n">Reg17</span><span class="p">(</span><span class="n">Reg17</span><span class="p">),.</span><span class="n">Reg18</span><span class="p">(</span><span class="n">Reg18</span><span class="p">),.</span><span class="n">Reg19</span><span class="p">(</span><span class="n">Reg19</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg20</span><span class="p">(</span><span class="n">Reg20</span><span class="p">),.</span><span class="n">Reg21</span><span class="p">(</span><span class="n">Reg21</span><span class="p">),.</span><span class="n">Reg22</span><span class="p">(</span><span class="n">Reg22</span><span class="p">),.</span><span class="n">Reg23</span><span class="p">(</span><span class="n">Reg23</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg24</span><span class="p">(</span><span class="n">Reg24</span><span class="p">),.</span><span class="n">Reg25</span><span class="p">(</span><span class="n">Reg25</span><span class="p">),.</span><span class="n">Reg26</span><span class="p">(</span><span class="n">Reg26</span><span class="p">),.</span><span class="n">Reg27</span><span class="p">(</span><span class="n">Reg27</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg28</span><span class="p">(</span><span class="n">Reg28</span><span class="p">),.</span><span class="n">Reg29</span><span class="p">(</span><span class="n">Reg29</span><span class="p">),.</span><span class="n">Reg30</span><span class="p">(</span><span class="n">Reg30</span><span class="p">),.</span><span class="n">Reg31</span><span class="p">(</span><span class="n">Reg31</span><span class="p">));</span>

<span class="n">ImmGen</span><span class="w"> </span><span class="n">immgen</span><span class="p">(.</span><span class="n">ImmSel</span><span class="p">(</span><span class="n">ImmSel</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">inst_field</span><span class="p">(</span><span class="n">inst_field</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Imm_out</span><span class="p">(</span><span class="n">ImmOut</span><span class="p">));</span>

<span class="n">Reg</span><span class="w"> </span><span class="n">PC</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">PC_in</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">PC_out</span><span class="p">));</span>

<span class="k">endmodule</span>
</code></pre></div>
<p>在 DataPath 代码中对 ImmGen, RegFile, ALU 等模块进行了实例化，将 SCPU_Ctrl 传入的控制信号用于控制不同模块的操作</p>
<p><em>4. SCPU代码：</em></p>
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">SCPU</span><span class="p">(</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">clk</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">rst</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">MIO_ready</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">inst_in</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Data_in</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="n">CPU_MIO</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="n">MemRW</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_out</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Data_out</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Addr_out</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg00</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg01</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg02</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg03</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg04</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg05</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg06</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg07</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg08</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg09</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg10</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg11</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg12</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg13</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg14</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg15</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg16</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg17</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg18</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg19</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg20</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg21</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg22</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg23</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg24</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg25</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg26</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg27</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg28</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg29</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg30</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg31</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ALU_Control</span>
<span class="p">);</span>

<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ImmSel</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="n">ALUSrc_B</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">MemtoReg</span><span class="p">;</span><span class="w">   </span>
<span class="kt">wire</span><span class="w"> </span><span class="n">Jump</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="n">Branch</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="n">RegWrite</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">OP</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">FUN3</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="n">FUN7</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">OP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst_in</span><span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">2</span><span class="p">];</span>
<span class="k">assign</span><span class="w"> </span><span class="n">FUN3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst_in</span><span class="p">[</span><span class="mh">14</span><span class="o">:</span><span class="mh">12</span><span class="p">];</span>
<span class="k">assign</span><span class="w"> </span><span class="n">FUN7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst_in</span><span class="p">[</span><span class="mh">30</span><span class="p">];</span>
<span class="n">SCPU_ctrls</span><span class="w"> </span><span class="n">Ctrl</span><span class="p">(.</span><span class="n">OPcode</span><span class="p">(</span><span class="n">OP</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Fun3</span><span class="p">(</span><span class="n">FUN3</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Fun7</span><span class="p">(</span><span class="n">FUN7</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="p">.</span><span class="n">MIO_ready</span><span class="p">(</span><span class="n">MIO_ready</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">ImmSel</span><span class="p">(</span><span class="n">ImmSel</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">ALUSrc_B</span><span class="p">(</span><span class="n">ALUSrc_B</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">MemtoReg</span><span class="p">(</span><span class="n">MemtoReg</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="p">.</span><span class="n">Jump</span><span class="p">(</span><span class="n">Jump</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Branch</span><span class="p">(</span><span class="n">Branch</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">RegWrite</span><span class="p">(</span><span class="n">RegWrite</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">MemRW</span><span class="p">(</span><span class="n">MemRW</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">ALU_Control</span><span class="p">(</span><span class="n">ALU_Control</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">CPU_MIO</span><span class="p">(</span><span class="n">CPU_MIO</span><span class="p">));</span>

<span class="n">DataPaths</span><span class="w"> </span><span class="n">DP</span><span class="p">(.</span><span class="n">ImmSel</span><span class="p">(</span><span class="n">ImmSel</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">ALUSrc_B</span><span class="p">(</span><span class="n">ALUSrc_B</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">MemtoReg</span><span class="p">(</span><span class="n">MemtoReg</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="p">.</span><span class="n">Jump</span><span class="p">(</span><span class="n">Jump</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Branch</span><span class="p">(</span><span class="n">Branch</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">RegWrite</span><span class="p">(</span><span class="n">RegWrite</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">ALU_Control</span><span class="p">(</span><span class="n">ALU_Control</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Data_in</span><span class="p">(</span><span class="n">Data_in</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">inst_field</span><span class="p">(</span><span class="n">inst_in</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="p">.</span><span class="n">ALU_out</span><span class="p">(</span><span class="n">Addr_out</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Data_out</span><span class="p">(</span><span class="n">Data_out</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">PC_out</span><span class="p">(</span><span class="n">PC_out</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg00</span><span class="p">(</span><span class="n">Reg00</span><span class="p">),.</span><span class="n">Reg01</span><span class="p">(</span><span class="n">Reg01</span><span class="p">),.</span><span class="n">Reg02</span><span class="p">(</span><span class="n">Reg02</span><span class="p">),.</span><span class="n">Reg03</span><span class="p">(</span><span class="n">Reg03</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg04</span><span class="p">(</span><span class="n">Reg04</span><span class="p">),.</span><span class="n">Reg05</span><span class="p">(</span><span class="n">Reg05</span><span class="p">),.</span><span class="n">Reg06</span><span class="p">(</span><span class="n">Reg06</span><span class="p">),.</span><span class="n">Reg07</span><span class="p">(</span><span class="n">Reg07</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg08</span><span class="p">(</span><span class="n">Reg08</span><span class="p">),.</span><span class="n">Reg09</span><span class="p">(</span><span class="n">Reg09</span><span class="p">),.</span><span class="n">Reg10</span><span class="p">(</span><span class="n">Reg10</span><span class="p">),.</span><span class="n">Reg11</span><span class="p">(</span><span class="n">Reg11</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg12</span><span class="p">(</span><span class="n">Reg12</span><span class="p">),.</span><span class="n">Reg13</span><span class="p">(</span><span class="n">Reg13</span><span class="p">),.</span><span class="n">Reg14</span><span class="p">(</span><span class="n">Reg14</span><span class="p">),.</span><span class="n">Reg15</span><span class="p">(</span><span class="n">Reg15</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg16</span><span class="p">(</span><span class="n">Reg16</span><span class="p">),.</span><span class="n">Reg17</span><span class="p">(</span><span class="n">Reg17</span><span class="p">),.</span><span class="n">Reg18</span><span class="p">(</span><span class="n">Reg18</span><span class="p">),.</span><span class="n">Reg19</span><span class="p">(</span><span class="n">Reg19</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg20</span><span class="p">(</span><span class="n">Reg20</span><span class="p">),.</span><span class="n">Reg21</span><span class="p">(</span><span class="n">Reg21</span><span class="p">),.</span><span class="n">Reg22</span><span class="p">(</span><span class="n">Reg22</span><span class="p">),.</span><span class="n">Reg23</span><span class="p">(</span><span class="n">Reg23</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg24</span><span class="p">(</span><span class="n">Reg24</span><span class="p">),.</span><span class="n">Reg25</span><span class="p">(</span><span class="n">Reg25</span><span class="p">),.</span><span class="n">Reg26</span><span class="p">(</span><span class="n">Reg26</span><span class="p">),.</span><span class="n">Reg27</span><span class="p">(</span><span class="n">Reg27</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg28</span><span class="p">(</span><span class="n">Reg28</span><span class="p">),.</span><span class="n">Reg29</span><span class="p">(</span><span class="n">Reg29</span><span class="p">),.</span><span class="n">Reg30</span><span class="p">(</span><span class="n">Reg30</span><span class="p">),.</span><span class="n">Reg31</span><span class="p">(</span><span class="n">Reg31</span><span class="p">));</span>

<span class="k">endmodule</span>
</code></pre></div>
<p><em>5. 其他模块代码：</em></p>
<p><em>ALU</em></p>
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">ALU</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">ALU_operation</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">zero</span><span class="p">,</span><span class="w"> </span><span class="n">overflow</span><span class="w"> </span><span class="p">);</span>
<span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">A</span><span class="p">;</span>
<span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">B</span><span class="p">;</span>
<span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ALU_operation</span><span class="p">;</span>
<span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="n">zero</span><span class="p">;</span>
<span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="n">overflow</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">res_and</span><span class="p">,</span><span class="n">res_or</span><span class="p">,</span><span class="n">res_add</span><span class="p">,</span><span class="n">res_sub</span><span class="p">,</span>
<span class="w">  </span><span class="n">res_xor</span><span class="p">,</span><span class="n">res_slt</span><span class="p">,</span><span class="n">res_sltu</span><span class="p">,</span><span class="n">res_sll</span><span class="p">,</span><span class="n">res_srl</span><span class="p">,</span><span class="n">res_sra</span><span class="p">;</span>

<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="kt">bit</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">res_xor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="o">^</span><span class="n">B</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">res_and</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="o">&amp;</span><span class="n">B</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">res_or</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="o">|</span><span class="n">B</span><span class="p">;</span>

<span class="k">assign</span><span class="w"> </span><span class="n">res_add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">$signed</span><span class="p">(</span><span class="n">$signed</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">+</span><span class="n">$signed</span><span class="p">(</span><span class="n">B</span><span class="p">));</span>
<span class="k">assign</span><span class="w"> </span><span class="n">res_sub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">$signed</span><span class="p">(</span><span class="n">$signed</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">-</span><span class="n">$signed</span><span class="p">(</span><span class="n">B</span><span class="p">));</span>
<span class="k">assign</span><span class="w"> </span><span class="n">res_slt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">$signed</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">$signed</span><span class="p">(</span><span class="n">B</span><span class="p">))</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mh">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">res_sltu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">$unsigned</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">$unsigned</span><span class="p">(</span><span class="n">B</span><span class="p">))</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mh">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>

<span class="k">assign</span><span class="w"> </span><span class="kt">bit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">$unsigned</span><span class="p">(</span><span class="n">B</span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]);</span>
<span class="k">assign</span><span class="w"> </span><span class="n">res_sll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="o">&lt;&lt;</span><span class="n">B</span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
<span class="k">assign</span><span class="w"> </span><span class="n">res_srl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="o">&gt;&gt;</span><span class="n">B</span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span><span class="w">    </span>
<span class="k">assign</span><span class="w"> </span><span class="n">res_sra</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">$signed</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">&gt;&gt;&gt;</span><span class="n">$signed</span><span class="p">(</span><span class="n">B</span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]);</span>
<span class="k">always</span><span class="w"> </span><span class="p">@</span><span class="w"> </span><span class="p">(</span><span class="n">A</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">ALU_operation</span><span class="p">)</span><span class="k">begin</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">ALU_operation</span><span class="p">)</span>
<span class="w">    </span><span class="mh">4</span><span class="mi">&#39;d0</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">res</span><span class="o">=</span><span class="n">res_add</span><span class="p">;</span><span class="n">overflow</span><span class="o">=</span><span class="p">(</span><span class="n">res</span><span class="o">&lt;</span><span class="n">A</span><span class="p">);</span><span class="k">end</span>
<span class="w">    </span><span class="mh">4</span><span class="mi">&#39;d1</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">res</span><span class="o">=</span><span class="n">res_sub</span><span class="p">;</span><span class="n">overflow</span><span class="o">=</span><span class="p">(</span><span class="n">res</span><span class="o">&gt;</span><span class="n">A</span><span class="p">);</span><span class="k">end</span>
<span class="w">    </span><span class="mh">4</span><span class="mi">&#39;d2</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">res</span><span class="o">=</span><span class="n">res_sll</span><span class="p">;</span><span class="n">overflow</span><span class="o">=</span><span class="mh">0</span><span class="p">;</span><span class="k">end</span>
<span class="w">    </span><span class="mh">4</span><span class="mi">&#39;d3</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">res</span><span class="o">=</span><span class="n">res_slt</span><span class="p">;</span><span class="n">overflow</span><span class="o">=</span><span class="mh">0</span><span class="p">;</span><span class="k">end</span>
<span class="w">    </span><span class="mh">4</span><span class="mi">&#39;d4</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">res</span><span class="o">=</span><span class="n">res_sltu</span><span class="p">;</span><span class="n">overflow</span><span class="o">=</span><span class="mh">0</span><span class="p">;</span><span class="k">end</span>
<span class="w">    </span><span class="mh">4</span><span class="mi">&#39;d5</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">res</span><span class="o">=</span><span class="n">res_xor</span><span class="p">;</span><span class="n">overflow</span><span class="o">=</span><span class="mh">0</span><span class="p">;</span><span class="k">end</span>
<span class="w">    </span><span class="mh">4</span><span class="mi">&#39;d6</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">res</span><span class="o">=</span><span class="n">res_srl</span><span class="p">;</span><span class="n">overflow</span><span class="o">=</span><span class="mh">0</span><span class="p">;</span><span class="k">end</span>
<span class="w">    </span><span class="mh">4</span><span class="mi">&#39;d7</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">res</span><span class="o">=</span><span class="n">res_sra</span><span class="p">;</span><span class="n">overflow</span><span class="o">=</span><span class="mh">0</span><span class="p">;</span><span class="k">end</span>
<span class="w">    </span><span class="mh">4</span><span class="mi">&#39;d8</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">res</span><span class="o">=</span><span class="n">res_or</span><span class="p">;</span><span class="n">overflow</span><span class="o">=</span><span class="mh">0</span><span class="p">;</span><span class="k">end</span>
<span class="w">    </span><span class="mh">4</span><span class="mi">&#39;d9</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">res</span><span class="o">=</span><span class="n">res_and</span><span class="p">;</span><span class="n">overflow</span><span class="o">=</span><span class="mh">0</span><span class="p">;</span><span class="k">end</span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">res</span><span class="o">=</span><span class="mh">32&#39;h0</span><span class="p">;</span><span class="n">overflow</span><span class="o">=</span><span class="mh">0</span><span class="p">;</span><span class="k">end</span>
<span class="w">    </span><span class="k">endcase</span><span class="w">    </span>
<span class="k">end</span>
<span class="k">assign</span><span class="w"> </span><span class="n">zero</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="o">==</span><span class="mh">0</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="mh">1</span><span class="o">:</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="k">endmodule</span>
</code></pre></div>
<p><em>RegFile</em>
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">Regs</span><span class="p">(</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="n">clk</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="n">rst</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Rs1_addr</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Rs2_addr</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Wt_addr</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Wt_data</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="n">RegWrite</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Rs1_data</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Rs2_data</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg00</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg01</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg02</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg03</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg04</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg05</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg06</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg07</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg08</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg09</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg10</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg11</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg12</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg13</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg14</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg15</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg16</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg17</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg18</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg19</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg20</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg21</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg22</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg23</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg24</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg25</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg26</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg27</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg28</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg29</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg30</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg31</span>
<span class="p">);</span>
<span class="w">     </span><span class="k">integer</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">     </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
<span class="w">     </span><span class="k">initial</span><span class="w"> </span><span class="k">begin</span>
<span class="w">         </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">32</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="n">Reg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span><span class="w"> </span>
<span class="w">     </span><span class="k">end</span>


<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Reg00</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="mh">0</span><span class="p">];</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Reg01</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="mh">1</span><span class="p">];</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Reg02</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="mh">2</span><span class="p">];</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Reg03</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="mh">3</span><span class="p">];</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Reg04</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="mh">4</span><span class="p">];</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Reg05</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="mh">5</span><span class="p">];</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Reg06</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="mh">6</span><span class="p">];</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Reg07</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="mh">7</span><span class="p">];</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Reg08</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="mh">8</span><span class="p">];</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Reg09</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="mh">9</span><span class="p">];</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Reg10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="mh">10</span><span class="p">];</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Reg11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="mh">11</span><span class="p">];</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Reg12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="mh">12</span><span class="p">];</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Reg13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="mh">13</span><span class="p">];</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Reg14</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="mh">14</span><span class="p">];</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Reg15</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="mh">15</span><span class="p">];</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Reg16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="mh">16</span><span class="p">];</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Reg17</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="mh">17</span><span class="p">];</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Reg18</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="mh">18</span><span class="p">];</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Reg19</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="mh">19</span><span class="p">];</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Reg20</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="mh">20</span><span class="p">];</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Reg21</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="mh">21</span><span class="p">];</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Reg22</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="mh">22</span><span class="p">];</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Reg23</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="mh">23</span><span class="p">];</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Reg24</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="mh">24</span><span class="p">];</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Reg25</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="mh">25</span><span class="p">];</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Reg26</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="mh">26</span><span class="p">];</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Reg27</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="mh">27</span><span class="p">];</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Reg28</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="mh">28</span><span class="p">];</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Reg29</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="mh">29</span><span class="p">];</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Reg30</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="mh">30</span><span class="p">];</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Reg31</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="mh">31</span><span class="p">];</span>
<span class="w">   </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">posedge</span><span class="w"> </span><span class="n">rst</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rst</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">32</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                </span><span class="n">Reg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">            </span><span class="k">end</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">RegWrite</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">Wt_addr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">5</span><span class="mb">&#39;b0</span><span class="p">))</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                </span><span class="n">Reg</span><span class="p">[</span><span class="n">Wt_addr</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">Wt_data</span><span class="p">;</span>
<span class="w">            </span><span class="k">end</span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                </span><span class="n">Reg</span><span class="p">[</span><span class="n">Wt_addr</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="n">Wt_addr</span><span class="p">];</span>
<span class="w">            </span><span class="k">end</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Rs1_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="n">Rs1_addr</span><span class="p">];</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Rs2_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="n">Rs2_addr</span><span class="p">];</span>

<span class="k">endmodule</span>
</code></pre></div>
<em>PC</em>
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">Reg</span><span class="p">(</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="n">clk</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="n">rst</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="n">CE</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">D</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Q</span>
<span class="p">);</span>
<span class="w">    </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg</span><span class="p">;</span>
<span class="w">    </span><span class="k">initial</span><span class="w"> </span><span class="k">begin</span>
<span class="w">        </span><span class="n">Reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span><span class="w"> </span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">posedge</span><span class="w"> </span><span class="n">rst</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">rst</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="n">Reg</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span><span class="w">  </span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">CE</span><span class="p">)</span><span class="w"> </span><span class="n">Reg</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">D</span><span class="p">;</span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="n">Reg</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">Reg</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span><span class="w">    </span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">;</span>
<span class="k">endmodule</span>
</code></pre></div></p>
<h3 id="_7">仿真关键步骤说明</h3>
<p>为了仿真，我们需要建立一个仿真平台 testbench, 在里面实例化 SCPU, ROM 和 RAM 来运行仿真代码</p>
<p><em>1. testbench 代码：</em></p>
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">testbench</span><span class="p">(</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="n">clk</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="n">rst</span>
<span class="p">);</span>

<span class="w">    </span><span class="cm">/* SCPU output */</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Addr_out</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Data_out</span><span class="p">;</span><span class="w">       </span>
<span class="w">    </span><span class="kt">wire</span><span class="w">        </span><span class="n">CPU_MIO</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w">        </span><span class="n">MemRW</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_out</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/* RAM output */</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">douta</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/* ROM output */</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">spo</span><span class="p">;</span>
<span class="n">SCPU</span><span class="w"> </span><span class="n">u0</span><span class="p">(</span>
<span class="w">        </span><span class="p">.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Data_in</span><span class="p">(</span><span class="n">douta</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">MIO_ready</span><span class="p">(</span><span class="n">CPU_MIO</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">inst_in</span><span class="p">(</span><span class="n">spo</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Addr_out</span><span class="p">(</span><span class="n">Addr_out</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Data_out</span><span class="p">(</span><span class="n">Data_out</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">CPU_MIO</span><span class="p">(</span><span class="n">CPU_MIO</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">MemRW</span><span class="p">(</span><span class="n">MemRW</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC_out</span><span class="p">(</span><span class="n">PC_out</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="n">RAM_B</span><span class="w"> </span><span class="n">u1</span><span class="p">(</span>
<span class="w">        </span><span class="p">.</span><span class="n">clka</span><span class="p">(</span><span class="o">~</span><span class="n">clk</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">wea</span><span class="p">(</span><span class="n">MemRW</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">addra</span><span class="p">(</span><span class="n">Addr_out</span><span class="p">[</span><span class="mh">11</span><span class="o">:</span><span class="mh">2</span><span class="p">]),</span>
<span class="w">        </span><span class="p">.</span><span class="n">dina</span><span class="p">(</span><span class="n">Data_out</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">douta</span><span class="p">(</span><span class="n">douta</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="n">ROM_D</span><span class="w"> </span><span class="n">u2</span><span class="p">(</span>
<span class="w">        </span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">PC_out</span><span class="p">[</span><span class="mh">11</span><span class="o">:</span><span class="mh">2</span><span class="p">]),</span>
<span class="w">        </span><span class="p">.</span><span class="n">spo</span><span class="p">(</span><span class="n">spo</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
<span class="k">endmodule</span>
</code></pre></div>
<p>在 testbench 中， 实例化了 SCPU, ROM 和 RAM 并进行了接线</p>
<p><em>仿真代码：</em></p>
<p><em>ImmGen 仿真</em></p>
<p><div class="highlight"><pre><span></span><code><span class="no">`timescale</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span><span class="o">/</span><span class="mh">1</span><span class="n">ps</span>
<span class="cp">`define IMM_SEL_WIDTH 2</span>
<span class="cp">`define IMM_SEL_I   `IMM_SEL_WIDTH&#39;d0</span>
<span class="cp">`define IMM_SEL_S   `IMM_SEL_WIDTH&#39;d1</span>
<span class="cp">`define IMM_SEL_B   `IMM_SEL_WIDTH&#39;d2</span>
<span class="cp">`define IMM_SEL_J   `IMM_SEL_WIDTH&#39;d3</span>
<span class="k">module</span><span class="w"> </span><span class="n">ImmGen_tb</span><span class="p">();</span>
<span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">   </span><span class="n">ImmSel</span><span class="p">;</span>
<span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">inst_field</span><span class="p">;</span>
<span class="w"> </span><span class="kt">wire</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">Imm_out</span><span class="p">;</span>

<span class="w"> </span><span class="n">ImmGen</span><span class="w"> </span><span class="n">m0</span><span class="w"> </span><span class="p">(.</span><span class="n">ImmSel</span><span class="p">(</span><span class="n">ImmSel</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">inst_field</span><span class="p">(</span><span class="n">inst_field</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Imm_out</span><span class="p">(</span><span class="n">Imm_out</span><span class="p">));</span>

<span class="cp">`define LET_INST_BE(inst) \</span>
<span class="cp"> inst_field = inst; \</span>
<span class="cp"> #5;</span>

<span class="w"> </span><span class="k">initial</span><span class="w"> </span><span class="k">begin</span>
<span class="w">   </span><span class="n">$dumpfile</span><span class="p">(</span><span class="s">&quot;ImmGen.vcd&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">$dumpvars</span><span class="p">(</span><span class="mh">1</span><span class="p">,</span><span class="w"> </span><span class="n">ImmGen_tb</span><span class="p">);</span>

<span class="w">   </span><span class="p">#</span><span class="mh">5</span><span class="p">;</span>
<span class="w">   </span><span class="cm">/* Test for I-Type */</span>
<span class="w">   </span><span class="n">ImmSel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">`IMM_SEL_I</span><span class="p">;</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;h3E810093</span><span class="p">);</span><span class="w">   </span><span class="c1">//addi x1, x2, 1000</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;h00A14093</span><span class="p">);</span><span class="w">   </span><span class="c1">//xori x1, x2, 10</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;h00116093</span><span class="p">);</span><span class="w">   </span><span class="c1">//ori x1, x2, 1</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;h00017093</span><span class="p">);</span><span class="w">   </span><span class="c1">//andi x1, x2, 0</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;h01411093</span><span class="p">);</span><span class="w">   </span><span class="c1">//slli x1, x2, 20</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;h00515093</span><span class="p">);</span><span class="w">   </span><span class="c1">//srli x1, x2, 5</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;h41815093</span><span class="p">);</span><span class="w">   </span><span class="c1">//srai x1, x2, 24</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;hFFF12093</span><span class="p">);</span><span class="w">   </span><span class="c1">//slti x1, x2, -1</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;h3FF13093</span><span class="p">);</span><span class="w">   </span><span class="c1">//sltiu x1, x2, 1023</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;h0E910083</span><span class="p">);</span><span class="w">   </span><span class="c1">//lb x1, 233(x2)</span>

<span class="w">   </span><span class="p">#</span><span class="mh">20</span><span class="p">;</span>
<span class="w">   </span><span class="cm">/* Test for S-Type */</span>
<span class="w">   </span><span class="n">ImmSel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">`IMM_SEL_S</span><span class="p">;</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;hFE110DA3</span><span class="p">);</span><span class="w">   </span><span class="c1">//sb x1, -5(x2)</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;h00211023</span><span class="p">);</span><span class="w">   </span><span class="c1">//sh x2, 0(x2)</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;h00C0A523</span><span class="p">);</span><span class="w">   </span><span class="c1">//sw x12, 10(x1)</span>

<span class="w">   </span><span class="p">#</span><span class="mh">20</span><span class="p">;</span>
<span class="w">   </span><span class="cm">/* Test for B-Type */</span>
<span class="w">   </span><span class="n">ImmSel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">`IMM_SEL_B</span><span class="p">;</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;hFE108AE3</span><span class="p">);</span><span class="w">   </span><span class="c1">//beq x1, x1, -12</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;h00211463</span><span class="p">);</span><span class="w">   </span><span class="c1">//bne x2, x2, 8</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;h0031CA63</span><span class="p">);</span><span class="w">   </span><span class="c1">//blt x3, x3, 20</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;hFE4256E3</span><span class="p">);</span><span class="w">   </span><span class="c1">//bge x4, x4, -20</span>

<span class="w">   </span><span class="p">#</span><span class="mh">20</span><span class="p">;</span>
<span class="w">   </span><span class="cm">/* Test for J-Type */</span>
<span class="w">   </span><span class="n">ImmSel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">`IMM_SEL_J</span><span class="p">;</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;hF9DFF06F</span><span class="p">);</span><span class="w">   </span><span class="c1">//jal x0, -100</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;h3FE000EF</span><span class="p">);</span><span class="w">   </span><span class="c1">//jal x1, 1023 NOTE: does ImmGen output 1023?</span>
<span class="w">   </span><span class="p">#</span><span class="mh">50</span><span class="p">;</span><span class="w"> </span><span class="nb">$finish</span><span class="p">();</span>
<span class="w"> </span><span class="k">end</span>
<span class="k">endmodule</span>
</code></pre></div>
<em>SCPU_Ctrl 仿真</em></p>
<div class="highlight"><pre><span></span><code><span class="no">`timescale</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span><span class="o">/</span><span class="mh">1</span><span class="n">ps</span>

<span class="no">`include</span><span class="w"> </span><span class="s">&quot;Lab4_header.vh&quot;</span>

<span class="k">module</span><span class="w"> </span><span class="n">SCPU_ctrl_tb</span><span class="p">();</span>
<span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">     </span><span class="n">OPcode</span><span class="p">;</span>
<span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">     </span><span class="n">Fun3</span><span class="p">;</span>
<span class="w"> </span><span class="kt">reg</span><span class="w">           </span><span class="n">Fun7</span><span class="p">;</span>
<span class="w"> </span><span class="kt">reg</span><span class="w">           </span><span class="n">MIO_ready</span><span class="p">;</span>
<span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">ImmSel</span><span class="p">;</span>
<span class="w"> </span><span class="kt">wire</span><span class="w">          </span><span class="n">ALUSrc_B</span><span class="p">;</span>
<span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="w"> </span><span class="mh">0</span><span class="p">]</span><span class="w">   </span><span class="n">MemtoReg</span><span class="p">;</span>
<span class="w"> </span><span class="kt">wire</span><span class="w">          </span><span class="n">Jump</span><span class="p">;</span>
<span class="w"> </span><span class="kt">wire</span><span class="w">          </span><span class="n">Branch</span><span class="p">;</span>
<span class="w"> </span><span class="kt">wire</span><span class="w">          </span><span class="n">RegWrite</span><span class="p">;</span>
<span class="w"> </span><span class="kt">wire</span><span class="w">          </span><span class="n">MemRW</span><span class="p">;</span>
<span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">ALU_Control</span><span class="p">;</span>
<span class="w"> </span><span class="kt">wire</span><span class="w">          </span><span class="n">CPU_MIO</span><span class="p">;</span>

<span class="w"> </span><span class="n">SCPU_ctrls</span><span class="w"> </span><span class="n">m0</span><span class="w"> </span><span class="p">(</span>
<span class="w">   </span><span class="p">.</span><span class="n">OPcode</span><span class="p">(</span><span class="n">OPcode</span><span class="p">),</span>
<span class="w">   </span><span class="p">.</span><span class="n">Fun3</span><span class="p">(</span><span class="n">Fun3</span><span class="p">),</span>
<span class="w">   </span><span class="p">.</span><span class="n">Fun7</span><span class="p">(</span><span class="n">Fun7</span><span class="p">),</span>
<span class="w">   </span><span class="p">.</span><span class="n">MIO_ready</span><span class="p">(</span><span class="n">MIO_ready</span><span class="p">),</span>
<span class="w">   </span><span class="p">.</span><span class="n">ImmSel</span><span class="p">(</span><span class="n">ImmSel</span><span class="p">),</span>
<span class="w">   </span><span class="p">.</span><span class="n">ALUSrc_B</span><span class="p">(</span><span class="n">ALUSrc_B</span><span class="p">),</span>
<span class="w">   </span><span class="p">.</span><span class="n">MemtoReg</span><span class="p">(</span><span class="n">MemtoReg</span><span class="p">),</span>
<span class="w">   </span><span class="p">.</span><span class="n">Jump</span><span class="p">(</span><span class="n">Jump</span><span class="p">),</span>
<span class="w">   </span><span class="p">.</span><span class="n">Branch</span><span class="p">(</span><span class="n">Branch</span><span class="p">),</span>
<span class="w">   </span><span class="p">.</span><span class="n">RegWrite</span><span class="p">(</span><span class="n">RegWrite</span><span class="p">),</span>
<span class="w">   </span><span class="p">.</span><span class="n">MemRW</span><span class="p">(</span><span class="n">MemRW</span><span class="p">),</span>
<span class="w">   </span><span class="p">.</span><span class="n">ALU_Control</span><span class="p">(</span><span class="n">ALU_Control</span><span class="p">),</span>
<span class="w">   </span><span class="p">.</span><span class="n">CPU_MIO</span><span class="p">(</span><span class="n">CPU_MIO</span><span class="p">)</span>
<span class="w"> </span><span class="p">);</span>

<span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">inst_for_test</span><span class="p">;</span>

<span class="cp">`define LET_INST_BE(inst) \</span>
<span class="cp"> inst_for_test = inst; \</span>
<span class="cp"> OPcode = inst_for_test[6:2]; \</span>
<span class="cp"> Fun3 = inst_for_test[14:12]; \</span>
<span class="cp"> Fun7 = inst_for_test[30]; \</span>
<span class="cp"> #50;</span>

<span class="w"> </span><span class="k">initial</span><span class="w"> </span><span class="k">begin</span>
<span class="w">   </span><span class="n">$dumpfile</span><span class="p">(</span><span class="s">&quot;SCPU_ctrl.vcd&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="n">$dumpvars</span><span class="p">(</span><span class="mh">1</span><span class="p">,</span><span class="w"> </span><span class="n">SCPU_ctrl_tb</span><span class="p">);</span>

<span class="w">   </span><span class="p">#</span><span class="mh">5</span><span class="p">;</span>
<span class="w">   </span><span class="n">MIO_ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">   </span><span class="p">#</span><span class="mh">5</span><span class="p">;</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;h001100B3</span><span class="p">);</span><span class="w">   </span><span class="c1">//add x1, x2, x1</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;h400080B3</span><span class="p">);</span><span class="w">   </span><span class="c1">//sub x1, x1, x0</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;h002140B3</span><span class="p">);</span><span class="w">   </span><span class="c1">//xor x1, x2, x2</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;h002160B3</span><span class="p">);</span><span class="w">   </span><span class="c1">//or x1, x2, x2</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;h002170B3</span><span class="p">);</span><span class="w">   </span><span class="c1">//and x1, x2, x2</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;h002150B3</span><span class="p">);</span><span class="w">   </span><span class="c1">//srl x1, x2, x2</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;h002120B3</span><span class="p">);</span><span class="w">   </span><span class="c1">//slt x1, x2, x2</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;h3E810093</span><span class="p">);</span><span class="w">   </span><span class="c1">//addi x1, x2, 1000</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;h00A14093</span><span class="p">);</span><span class="w">   </span><span class="c1">//xori x1, x2, 10</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;h00116093</span><span class="p">);</span><span class="w">   </span><span class="c1">//ori x1, x2, 1</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;h00017093</span><span class="p">);</span><span class="w">   </span><span class="c1">//andi x1, x2, 0</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;h00515093</span><span class="p">);</span><span class="w">   </span><span class="c1">//srli x1, x2, 5</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;hFFF12093</span><span class="p">);</span><span class="w">   </span><span class="c1">//slti x1, x2, -1</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;h00812083</span><span class="p">);</span><span class="w">   </span><span class="c1">//lw x1, 8(x2)</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;h00C0A823</span><span class="p">);</span><span class="w">   </span><span class="c1">//sw x12, 16(x1)</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;hFE108AE3</span><span class="p">);</span><span class="w">   </span><span class="c1">//beq x1, x1, -12</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;hF9DFF06F</span><span class="p">);</span><span class="w">   </span><span class="c1">//jal x0, -100</span>
<span class="w">   </span><span class="no">`LET_INST_BE</span><span class="p">(</span><span class="mh">32&#39;h3FE000EF</span><span class="p">);</span><span class="w">   </span><span class="c1">//jal x1, 1023</span>

<span class="w">   </span><span class="p">#</span><span class="mh">50</span><span class="p">;</span><span class="w"> </span><span class="nb">$finish</span><span class="p">();</span>
<span class="w"> </span><span class="k">end</span>
<span class="k">endmodule</span>
</code></pre></div>
<p><em>SCPU 仿真</em></p>
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">testbench_tb</span><span class="p">();</span>

<span class="w">    </span><span class="kt">reg</span><span class="w"> </span><span class="n">clk</span><span class="p">;</span>
<span class="w">    </span><span class="kt">reg</span><span class="w"> </span><span class="n">rst</span><span class="p">;</span>
<span class="w">    </span><span class="n">testbench</span><span class="w"> </span><span class="n">m0</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst</span><span class="p">));</span>

<span class="w">    </span><span class="k">initial</span><span class="w"> </span><span class="k">begin</span>
<span class="w">        </span><span class="n">clk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">        </span><span class="n">rst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">        </span><span class="p">#</span><span class="mh">50</span><span class="p">;</span>
<span class="w">        </span><span class="n">rst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">always</span><span class="w"> </span><span class="p">#</span><span class="mh">10</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">clk</span><span class="p">;</span>

<span class="k">endmodule</span>
</code></pre></div>
<p><em>SCPU 仿真测试/下板代码</em></p>
<div class="highlight"><pre><span></span><code>    j    start            # 00
dummy:
    nop                   # 04
    nop                   # 08
    nop                   # 0C
    nop                   # 10
    nop                   # 14
    nop                   # 18
    nop                   # 1C
    j    dummy

start:
    beq  x0, x0, pass_0
    li   x31, 0
    j    dummy
pass_0:
    li   x1, -1           # x1=FFFFFFFF
    xori x3, x1, 1        # x3=FFFFFFFE
    add  x3, x3, x3       # x3=FFFFFFFC
    add  x3, x3, x3       # x3=FFFFFFF8
    add  x3, x3, x3       # x3=FFFFFFF0
    add  x3, x3, x3       # x3=FFFFFFE0
    add  x3, x3, x3       # x3=FFFFFFC0
    add  x3, x3, x3       # x3=FFFFFF80
    add  x3, x3, x3       # x3=FFFFFF00
    add  x3, x3, x3       # x3=FFFFFE00
    add  x3, x3, x3       # x3=FFFFFC00
    add  x3, x3, x3       # x3=FFFFF800
    add  x3, x3, x3       # x3=FFFFF000
    add  x3, x3, x3       # x3=FFFFE000
    add  x3, x3, x3       # x3=FFFFC000
    add  x3, x3, x3       # x3=FFFF8000
    add  x3, x3, x3       # x3=FFFF0000
    add  x3, x3, x3       # x3=FFFE0000
    add  x3, x3, x3       # x3=FFFC0000
    add  x3, x3, x3       # x3=FFF80000
    add  x3, x3, x3       # x3=FFF00000
    add  x3, x3, x3       # x3=FFE00000
    add  x3, x3, x3       # x3=FFC00000
    add  x3, x3, x3       # x3=FF800000
    add  x3, x3, x3       # x3=FF000000
    add  x3, x3, x3       # x3=FE000000
    add  x3, x3, x3       # x3=FC000000
    add  x5, x3, x3       # x5=F8000000
    add  x3, x5, x5       # x3=F0000000
    add  x4, x3, x3       # x4=E0000000
    add  x6, x4, x4       # x6=C0000000
    add  x7, x6, x6       # x7=80000000
    ori  x8, zero, 1      # x8=00000001
    ori  x28, zero, 31
    srl  x29, x7, x28     # x29=00000001
    beq  x8, x29, pass_1
    li   x31, 1
    j    dummy

pass_1:
    nop
    sub  x3, x6, x7       # x3=40000000
    sub  x4, x7, x3       # x4=40000000
    slti x9, x0, 1        # x9=00000001
    slt  x10, x3, x4
    slt  x10, x4, x3      # x10=00000000
    beq  x9, x10, dummy   # branch when x3 != x4
    srli x29, x3, 30      # x29=00000001
    beq  x29, x9, pass_2
    li   x31, 2
    j    dummy

pass_2:
    nop
# Test signed set-less-than
    slti x10, x1, 3       # x10=00000001
    slt  x11, x5, x1      # signed(0xF8000000) &lt; -1
                        # x11=00000001
    slt  x12, x1, x3      # x12=00000001
    andi x10, x10, 0xff
    and  x10, x10, x11
    and  x10, x10, x12    # x10=00000001
    li   x11, 1
    beq  x10, x11, pass_3
    li   x31, 3
    j    dummy

pass_3:
    nop
    or   x11, x7, x3      # x11=C0000000
    beq  x11, x6, pass_4
    li   x31, 4
    j    dummy

pass_4:
    nop
    li   x18, 0x20        # base addr=0x20
### uncomment instr. below when simulating on venus
    # srli x18, x7, 3     # base addr=10000000
    sw   x5, 0(x18)       # mem[0x20]=F8000000
    sw   x4, 4(x18)       # mem[0x24]=40000000
    lw   x29, 0(x18)      # x29=mem[0x20]=F8000000
    xor  x29, x29, x5     # x29=00000000
    sw   x6, 0(x18)       # mem[0x20]=C0000000
    lw   x30, 0(x18)      # x30=mem[0x20]=C0000000
    xor  x29, x29, x30    # x29=C0000000
    beq  x6, x29, pass_5
    li   x31, 5
    j    dummy

pass_5:
    li   x31, 0x666
    j    dummy
</code></pre></div>
<h2 id="_8">实验结果与分析</h2>
<h3 id="_9">仿真结果</h3>
<p><em>1. ImmGen 仿真：</em></p>
<p><img alt="" src="../../images/SCPU/image_2.png" /></p>
<p><img alt="" src="../../images/SCPU/image_3.png" /></p>
<p>ImmGen 仿真输入  4  种类型的指令，分别输出了不同的立即数</p>
<p>图中的仿真波形与标准波形一致，结果符合要求</p>
<p><em>2. SCPU_Ctrl 仿真：</em></p>
<p><img alt="" src="../../images/SCPU/image_1.png" /></p>
<p>SCPU_Ctrl 仿真输入  6  种类型的指令，分别输出了不同的控制信号</p>
<p>例如，对于第一条指令 <code>001100B3</code>, 应为 <code>add x1, x2, x1</code> 指令</p>
<p>仿真波形中  RegWrite=1 , 代表控制 RegFile 写使能</p>
<p>同时  ALUSrc_B=0 , 表示选择 RegFile 读取的  rs2  作为 ALU 的输入  B </p>
<p>同时  ALU_Control=0 , 表示进行  add  操作</p>
<p>再如，最后一条指令 <code>3FE000EF</code> 对应 <code>jal x1, 1023</code> 指令</p>
<p>此时  RegWrite=1 , 代表控制 RegFile 写使能, 将地址存到  x1  中</p>
<p>同时  Jump=1 , 表示是  J  型指令</p>
<p>经检验，对所有指令输出的控制信号正确，结果符合预期</p>
<p><em>3. SCPU 仿真：</em></p>
<p><img alt="alt text" src="../../images/SCPU/image-2.png" /></p>
<p><img alt="alt text" src="../../images/SCPU/image-3.png" /></p>
<p>由于仿真波形过长，只将开头和结尾的波形显示出来</p>
<p>可以看到结尾的仿真波形中，<code>Reg31</code> 的值变成 <code>666</code>, 说明通过了前面的测试，结果符合预期</p>
<h1 id="lab-4-3">Lab 4-3</h1>
<h2 id="_10">操作方法与实验步骤</h2>
<h3 id="_11">代码设计层次结构图及说明</h3>
<p>经过指令拓展后的完整 DataPath 图如下：</p>
<p><img alt="alt text" src="../../images/SCPU/image-4.png" /></p>
<p>图中与之前的 DataPath 主要进行了如下更改：</p>
<ol>
<li>增加了 <code>Branch</code> 信号位数，增加了多路选择器来支持不同  B  型指令</li>
<li>增加了 <code>Jump</code> 信号位数，来支持 <code>jalr</code> 指令</li>
<li>增加了 RAM 写使能的位数，以分别控制  4  个字节的写使能</li>
<li>增加了 <code>lui</code> 和 <code>auipc</code> 的路径，即增加了 ImmGen 模块的生成类型，并增加了 <code>reg_wt_data</code> 的选择类型</li>
</ol>
<h3 id="_12">源代码</h3>
<p><em>1. ImmGen 代码：</em></p>
<p><div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">ImmGen</span><span class="p">(</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">   </span><span class="n">ImmSel</span><span class="p">,</span><span class="w">     </span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">inst_field</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Imm_out</span>
<span class="p">);</span>

<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">ImmSel</span><span class="p">)</span>
<span class="w">      </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="o">:</span><span class="w"> </span><span class="c1">// I-type </span>
<span class="w">        </span><span class="n">Imm_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="mh">20</span><span class="p">{</span><span class="n">inst_field</span><span class="p">[</span><span class="mh">31</span><span class="p">]}},</span><span class="w"> </span><span class="n">inst_field</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">20</span><span class="p">]};</span><span class="w"> </span>

<span class="w">      </span><span class="mh">3</span><span class="mb">&#39;b001</span><span class="o">:</span><span class="w"> </span><span class="c1">// S-type</span>
<span class="w">        </span><span class="n">Imm_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="mh">20</span><span class="p">{</span><span class="n">inst_field</span><span class="p">[</span><span class="mh">31</span><span class="p">]}},</span><span class="w"> </span><span class="n">inst_field</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">25</span><span class="p">],</span><span class="w"> </span><span class="n">inst_field</span><span class="p">[</span><span class="mh">11</span><span class="o">:</span><span class="mh">7</span><span class="p">]};</span><span class="w"> </span><span class="c1">//</span>

<span class="w">      </span><span class="mh">3</span><span class="mb">&#39;b010</span><span class="o">:</span><span class="w"> </span><span class="c1">// B-type </span>
<span class="w">        </span><span class="n">Imm_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="mh">19</span><span class="p">{</span><span class="n">inst_field</span><span class="p">[</span><span class="mh">31</span><span class="p">]}},</span><span class="w"> </span><span class="n">inst_field</span><span class="p">[</span><span class="mh">31</span><span class="p">],</span><span class="w"> </span><span class="n">inst_field</span><span class="p">[</span><span class="mh">7</span><span class="p">],</span><span class="w"> </span><span class="n">inst_field</span><span class="p">[</span><span class="mh">30</span><span class="o">:</span><span class="mh">25</span><span class="p">],</span><span class="w"> </span><span class="n">inst_field</span><span class="p">[</span><span class="mh">11</span><span class="o">:</span><span class="mh">8</span><span class="p">],</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">};</span><span class="w"> </span>

<span class="w">      </span><span class="mh">3</span><span class="mb">&#39;b011</span><span class="o">:</span><span class="w"> </span><span class="c1">// J-type </span>
<span class="w">        </span><span class="n">Imm_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="mh">11</span><span class="p">{</span><span class="n">inst_field</span><span class="p">[</span><span class="mh">31</span><span class="p">]}},</span><span class="w"> </span><span class="n">inst_field</span><span class="p">[</span><span class="mh">31</span><span class="p">],</span><span class="w"> </span><span class="n">inst_field</span><span class="p">[</span><span class="mh">19</span><span class="o">:</span><span class="mh">12</span><span class="p">],</span><span class="w"> </span><span class="n">inst_field</span><span class="p">[</span><span class="mh">20</span><span class="p">],</span><span class="w"> </span><span class="n">inst_field</span><span class="p">[</span><span class="mh">30</span><span class="o">:</span><span class="mh">21</span><span class="p">],</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">};</span><span class="w"> </span><span class="c1">// </span>

<span class="w">      </span><span class="mh">3</span><span class="mb">&#39;b100</span><span class="o">:</span><span class="w"> </span><span class="c1">// U_type</span>
<span class="w">        </span><span class="n">Imm_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">inst_field</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">12</span><span class="p">],</span><span class="w"> </span><span class="mh">12</span><span class="mb">&#39;b0</span><span class="p">};</span><span class="w"> </span><span class="c1">// high 20 bit Imm, low 12 bit 0</span>

<span class="w">      </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">Imm_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="c1">//</span>
<span class="w">    </span><span class="k">endcase</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">endmodule</span>
</code></pre></div>
主要增加了  U  型指令</p>
<p><em>2. SCPU_Ctrl代码：</em></p>
<p><div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">SCPU_ctrls</span><span class="p">(</span>
<span class="w">  </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">       </span><span class="n">OPcode</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">       </span><span class="n">Fun3</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">             </span><span class="n">Fun7</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">             </span><span class="n">MIO_ready</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">ImmSel</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">        </span><span class="n">ALUSrc_B</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">MemtoReg</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">Jump</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">Branch</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">        </span><span class="n">RegWrite</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">        </span><span class="n">MemRW</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">WHBU</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">ALU_Control</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">        </span><span class="n">CPU_MIO</span>
<span class="p">);</span>
<span class="k">initial</span><span class="w"> </span><span class="k">begin</span>
<span class="w">  </span><span class="n">ImmSel</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">;</span>
<span class="w">  </span><span class="n">ALUSrc_B</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">  </span><span class="n">MemtoReg</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">;</span><span class="w"> </span><span class="c1">// 0: ALU result 1: Load from RAM to reg  2/3: PC4, JAL</span>
<span class="w">  </span><span class="n">MemRW</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="c1">// write to/read from RAM</span>
<span class="w">  </span><span class="n">WHBU</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">  </span><span class="n">Jump</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span>
<span class="w">  </span><span class="n">Branch</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">;</span>
<span class="w">  </span><span class="n">RegWrite</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>

<span class="w">  </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span>
<span class="w">  </span><span class="c1">//CPU_MIO   = 1&#39;b0;</span>
<span class="k">end</span>
<span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>

<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">OPcode</span><span class="p">)</span>
<span class="w">    </span><span class="mh">5</span><span class="mb">&#39;b01100</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// R-type </span>
<span class="w">      </span><span class="n">WHBU</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">ALUSrc_B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">MemtoReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">;</span>
<span class="w">      </span><span class="n">RegWrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">      </span><span class="c1">//ImmSel   = 2&#39;b00; // no imm</span>
<span class="w">      </span><span class="c1">//MemRW    = 1&#39;bx; // no read or write </span>
<span class="w">      </span><span class="n">Jump</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span>
<span class="w">      </span><span class="n">Branch</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">;</span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="p">({</span><span class="n">Fun3</span><span class="p">,</span><span class="w"> </span><span class="n">Fun7</span><span class="p">})</span>
<span class="w">        </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span><span class="w"> </span><span class="c1">// ADD</span>
<span class="w">        </span><span class="mh">4</span><span class="mb">&#39;b0001</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0001</span><span class="p">;</span><span class="w"> </span><span class="c1">// SUB</span>
<span class="w">        </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="p">;</span><span class="w"> </span><span class="c1">// SLL</span>
<span class="w">        </span><span class="mh">4</span><span class="mb">&#39;b0100</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0011</span><span class="p">;</span><span class="w"> </span><span class="c1">// SLT</span>
<span class="w">        </span><span class="mh">4</span><span class="mb">&#39;b0110</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0100</span><span class="p">;</span><span class="w"> </span><span class="c1">// SLTU</span>
<span class="w">        </span><span class="mh">4</span><span class="mb">&#39;b1000</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0101</span><span class="p">;</span><span class="w"> </span><span class="c1">// XOR</span>
<span class="w">        </span><span class="mh">4</span><span class="mb">&#39;b1010</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0110</span><span class="p">;</span><span class="w"> </span><span class="c1">// SRL</span>
<span class="w">        </span><span class="mh">4</span><span class="mb">&#39;b1011</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0111</span><span class="p">;</span><span class="w"> </span><span class="c1">// SRA</span>
<span class="w">        </span><span class="mh">4</span><span class="mb">&#39;b1100</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b1000</span><span class="p">;</span><span class="w"> </span><span class="c1">// OR</span>
<span class="w">        </span><span class="mh">4</span><span class="mb">&#39;b1110</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b1001</span><span class="p">;</span><span class="w"> </span><span class="c1">// AND</span>
<span class="w">      </span><span class="k">endcase</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="mh">5</span><span class="mb">&#39;b00000</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// Load </span>

<span class="w">      </span><span class="n">ALUSrc_B</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">      </span><span class="n">MemtoReg</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b001</span><span class="p">;</span>
<span class="w">      </span><span class="n">RegWrite</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">      </span><span class="n">ImmSel</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">;</span>
<span class="w">      </span><span class="n">MemRW</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="c1">// read</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">Fun3</span><span class="p">)</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="o">:</span><span class="w"> </span><span class="n">WHBU</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="p">;</span><span class="w"> </span><span class="c1">// LB</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b001</span><span class="o">:</span><span class="w"> </span><span class="n">WHBU</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0100</span><span class="p">;</span><span class="w"> </span><span class="c1">// LH</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b010</span><span class="o">:</span><span class="w"> </span><span class="n">WHBU</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b1000</span><span class="p">;</span><span class="w"> </span><span class="c1">// LW</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b100</span><span class="o">:</span><span class="w"> </span><span class="n">WHBU</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0011</span><span class="p">;</span><span class="w"> </span><span class="c1">// LBU</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b101</span><span class="o">:</span><span class="w"> </span><span class="n">WHBU</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0101</span><span class="p">;</span><span class="w"> </span><span class="c1">// LHU</span>
<span class="w">      </span><span class="k">endcase</span>
<span class="w">      </span><span class="n">Jump</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span>
<span class="w">      </span><span class="n">Branch</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">;</span>
<span class="w">      </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span><span class="w"> </span><span class="c1">// ADD for address calculation</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="mh">5</span><span class="mb">&#39;b01000</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// Store </span>
<span class="w">      </span><span class="n">ALUSrc_B</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">      </span><span class="c1">//MemtoReg  = 2&#39;b01;</span>
<span class="w">      </span><span class="n">MemtoReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="p">&#39;</span><span class="n">bx</span><span class="p">;</span>
<span class="w">      </span><span class="c1">//RegWrite  = 1&#39;b1;</span>
<span class="w">      </span><span class="n">RegWrite</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">ImmSel</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b001</span><span class="p">;</span>
<span class="w">      </span><span class="n">MemRW</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span><span class="w"> </span><span class="c1">// write</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">Fun3</span><span class="p">)</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="o">:</span><span class="w"> </span><span class="n">WHBU</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="p">;</span><span class="w"> </span><span class="c1">// SB</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b001</span><span class="o">:</span><span class="w"> </span><span class="n">WHBU</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0100</span><span class="p">;</span><span class="w"> </span><span class="c1">// SH</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b010</span><span class="o">:</span><span class="w"> </span><span class="n">WHBU</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b1000</span><span class="p">;</span><span class="w"> </span><span class="c1">// SW</span>
<span class="w">      </span><span class="k">endcase</span>

<span class="w">      </span><span class="n">Jump</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span>
<span class="w">      </span><span class="n">Branch</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">;</span><span class="w"> </span>
<span class="w">      </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span><span class="w"> </span><span class="c1">// ADD for address calculation</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="mh">5</span><span class="mb">&#39;b11000</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// Branch</span>
<span class="w">      </span><span class="n">WHBU</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span>
<span class="w">      </span><span class="n">ALUSrc_B</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">MemtoReg</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="p">&#39;</span><span class="n">bx</span><span class="p">;</span><span class="w"> </span><span class="c1">// new</span>
<span class="w">      </span><span class="n">RegWrite</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="c1">//</span>
<span class="w">      </span><span class="n">ImmSel</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b010</span><span class="p">;</span><span class="w"> </span>
<span class="w">      </span><span class="c1">//MemRW     = 1&#39;bx;</span>

<span class="w">      </span><span class="c1">//Branch    = 1&#39;b1;</span>
<span class="w">      </span><span class="n">Jump</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">Fun3</span><span class="p">)</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">Branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b001</span><span class="p">;</span><span class="w">  </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d1</span><span class="p">;</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="c1">// BEQ, do SUB in ALU </span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b001</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">Branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b010</span><span class="p">;</span><span class="w">  </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d1</span><span class="p">;</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="c1">// BNE</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b100</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">Branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b011</span><span class="p">;</span><span class="w">  </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d3</span><span class="p">;</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="c1">// BLT, do SLT in ALU</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b101</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">Branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b100</span><span class="p">;</span><span class="w">  </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d3</span><span class="p">;</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="c1">// BGE</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b110</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">Branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b101</span><span class="p">;</span><span class="w">  </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d4</span><span class="p">;</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="c1">// BLTU, do SLTU in ALU</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b111</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">Branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b110</span><span class="p">;</span><span class="w">  </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d4</span><span class="p">;</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="c1">// BGEU </span>
<span class="w">        </span><span class="c1">//default: begin Branch = 3&#39;b000; ALU_Control = 4&#39;d0; end</span>
<span class="w">      </span><span class="k">endcase</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="mh">5</span><span class="mb">&#39;b11011</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// JAL </span>
<span class="w">      </span><span class="n">WHBU</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span>
<span class="w">      </span><span class="c1">//ALUSrc_B = 1&#39;b1;</span>
<span class="w">      </span><span class="n">ALUSrc_B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="p">&#39;</span><span class="n">bx</span><span class="p">;</span>
<span class="w">      </span><span class="n">MemtoReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b010</span><span class="p">;</span><span class="w"> </span><span class="c1">// PC + 4</span>
<span class="w">      </span><span class="n">RegWrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span><span class="w"> </span><span class="c1">//</span>
<span class="w">      </span><span class="n">ImmSel</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b011</span><span class="p">;</span>
<span class="w">      </span><span class="c1">// MemRW = 1&#39;bx;</span>

<span class="w">      </span><span class="n">Jump</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b01</span><span class="p">;</span>
<span class="w">      </span><span class="n">Branch</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="mh">5</span><span class="mb">&#39;b00100</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// I-type ALU</span>
<span class="w">      </span><span class="n">WHBU</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span><span class="w"> </span>
<span class="w">      </span><span class="n">ALUSrc_B</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">      </span><span class="n">MemtoReg</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">;</span>
<span class="w">      </span><span class="n">RegWrite</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">      </span><span class="n">ImmSel</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">;</span>
<span class="w">      </span><span class="c1">//MemRW     = 1&#39;bx; </span>

<span class="w">      </span><span class="n">Jump</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span>
<span class="w">      </span><span class="n">Branch</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">;</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">Fun3</span><span class="p">)</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span><span class="w"> </span><span class="c1">// ADDI</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b001</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="p">;</span><span class="w"> </span><span class="c1">// SLLI</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b010</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0011</span><span class="p">;</span><span class="w"> </span><span class="c1">// SLTI</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b011</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0100</span><span class="p">;</span><span class="w"> </span><span class="c1">// SLTIU</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b100</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0101</span><span class="p">;</span><span class="w"> </span><span class="c1">// XORI</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b101</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Fun7</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0111</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0110</span><span class="p">;</span><span class="w"> </span><span class="c1">// SRAI / SRLI</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b110</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b1000</span><span class="p">;</span><span class="w"> </span><span class="c1">// ORI</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b111</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b1001</span><span class="p">;</span><span class="w"> </span><span class="c1">// ANDI</span>
<span class="w">      </span><span class="k">endcase</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="mh">5</span><span class="mb">&#39;b11001</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// I-type JALR</span>
<span class="w">      </span><span class="n">WHBU</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span>
<span class="w">      </span><span class="n">ALUSrc_B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">      </span><span class="n">MemtoReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b010</span><span class="p">;</span><span class="w"> </span><span class="c1">// PC + 4</span>
<span class="w">      </span><span class="n">RegWrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span><span class="w"> </span><span class="c1">//</span>
<span class="w">      </span><span class="n">ImmSel</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">;</span>
<span class="w">      </span><span class="c1">//MemRW    = 1&#39;b0;</span>

<span class="w">      </span><span class="n">MemRW</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="p">&#39;</span><span class="n">bx</span><span class="p">;</span>
<span class="w">      </span><span class="n">Jump</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b10</span><span class="p">;</span>
<span class="w">      </span><span class="n">Branch</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">;</span>
<span class="w">      </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d0</span><span class="p">;</span><span class="w"> </span><span class="c1">// ADD</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="mh">5</span><span class="mb">&#39;b01101</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// lui</span>
<span class="w">      </span><span class="n">WHBU</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span>
<span class="w">      </span><span class="n">ALUSrc_B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="p">&#39;</span><span class="n">bx</span><span class="p">;</span>
<span class="w">      </span><span class="n">MemtoReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b11</span><span class="p">;</span><span class="w"> </span><span class="c1">// lui_res = Imm</span>
<span class="w">      </span><span class="n">RegWrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span><span class="w"> </span><span class="c1">//</span>
<span class="w">      </span><span class="n">ImmSel</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b100</span><span class="p">;</span><span class="w"> </span><span class="c1">// U-type</span>
<span class="w">      </span><span class="c1">//MemRW    = 1&#39;b0;</span>

<span class="w">      </span><span class="n">MemRW</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="p">&#39;</span><span class="n">bx</span><span class="p">;</span>
<span class="w">      </span><span class="n">Jump</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span>
<span class="w">      </span><span class="n">Branch</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">;</span>
<span class="w">      </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="p">&#39;</span><span class="n">dx</span><span class="p">;</span><span class="w"> </span><span class="c1">// ADD</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="mh">5</span><span class="mb">&#39;b00101</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// auipc</span>
<span class="w">      </span><span class="n">WHBU</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span>
<span class="w">      </span><span class="n">ALUSrc_B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="p">&#39;</span><span class="n">bx</span><span class="p">;</span>
<span class="w">      </span><span class="n">MemtoReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b100</span><span class="p">;</span><span class="w"> </span><span class="c1">// auipc_res = PC + Imm</span>
<span class="w">      </span><span class="n">RegWrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span><span class="w"> </span><span class="c1">//</span>
<span class="w">      </span><span class="n">ImmSel</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b100</span><span class="p">;</span>
<span class="w">      </span><span class="c1">//MemRW    = 1&#39;b0;</span>

<span class="w">      </span><span class="n">MemRW</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="p">&#39;</span><span class="n">bx</span><span class="p">;</span>
<span class="w">      </span><span class="n">Jump</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span>
<span class="w">      </span><span class="n">Branch</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">;</span>
<span class="w">      </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="p">&#39;</span><span class="n">dx</span><span class="p">;</span><span class="w"> </span><span class="c1">// ADD</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">endcase</span>

<span class="w">  </span><span class="c1">//CPU_MIO = MIO_ready;</span>
<span class="k">end</span>

<span class="k">endmodule</span>
</code></pre></div>
主要增加了 <code>WHBU</code> 这个信号，用来表示  Word, Half, Byte, Unsigned  这四种  Load,Store  的状态</p>
<p>此外还增加了 <code>Branch</code>, <code>Jump</code> 位数，增加了  U  型指令</p>
<p><em>3. DataPath代码：</em></p>
<p><div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">DataPaths</span><span class="p">(</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ImmSel</span><span class="p">,</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="n">ALUSrc_B</span><span class="p">,</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">MemtoReg</span><span class="p">,</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Jump</span><span class="p">,</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Branch</span><span class="p">,</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="n">RegWrite</span><span class="p">,</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ALU_Control</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Data_in</span><span class="p">,</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="n">clk</span><span class="p">,</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">inst_field</span><span class="p">,</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="n">rst</span><span class="p">,</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">WHBU</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg00</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg01</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg02</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg03</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg04</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg05</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg06</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg07</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg08</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg09</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg10</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg11</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg12</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg13</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg14</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg15</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg16</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg17</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg18</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg19</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg20</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg21</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg22</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg23</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg24</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg25</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg26</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg27</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg28</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg29</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg30</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg31</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ALU_out</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Data_out</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_out</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">wea</span><span class="p">);</span>

<span class="kt">reg</span><span class="w"> </span><span class="n">branch</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="n">Branch_one</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">branch_out</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="n">ALU_zero</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="n">ALU_overflow</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PCAddImm</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ALU_A</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ALU_B</span><span class="p">;</span>
<span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PCAdd4</span><span class="p">;</span>
<span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_in</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ImmOut</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">LSwea</span><span class="p">;</span>

<span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">LoadData</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ReadData</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">LSwea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ImmOut</span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
<span class="k">assign</span><span class="w"> </span><span class="n">PCAdd4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PC_out</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d4</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">Branch_one</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Branch</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">PCAddImm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ImmOut</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PC_out</span><span class="p">;</span><span class="w"> </span><span class="c1">// ALU ? Adder!</span>

<span class="k">always</span><span class="w"> </span><span class="p">@</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">MemtoReg</span><span class="p">)</span>
<span class="w">        </span><span class="mh">3</span><span class="mi">&#39;d0</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALU_out</span><span class="p">;</span><span class="w"> </span><span class="c1">// ALU</span>
<span class="w">        </span><span class="mh">3</span><span class="mi">&#39;d1</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">WHBU</span><span class="p">)</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="mh">24</span><span class="p">{</span><span class="n">LoadData</span><span class="p">[</span><span class="mh">7</span><span class="p">]}},</span><span class="w"> </span><span class="n">LoadData</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]};</span><span class="w"> </span><span class="c1">// LB</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0100</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="mh">16</span><span class="p">{</span><span class="n">LoadData</span><span class="p">[</span><span class="mh">15</span><span class="p">]}},</span><span class="w"> </span><span class="n">LoadData</span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]};</span><span class="w"> </span><span class="c1">// LH</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b1000</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LoadData</span><span class="p">;</span><span class="w"> </span><span class="c1">// LW</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0011</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">24</span><span class="mb">&#39;b0</span><span class="p">,</span><span class="w"> </span><span class="n">LoadData</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]};</span><span class="w"> </span><span class="c1">// LBU</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0101</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">16</span><span class="mb">&#39;b0</span><span class="p">,</span><span class="w"> </span><span class="n">LoadData</span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]};</span><span class="w"> </span><span class="c1">// LHU</span>
<span class="w">                </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">endcase</span><span class="w"> </span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="mh">3</span><span class="mi">&#39;d2</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PCAdd4</span><span class="p">;</span><span class="w"> </span><span class="c1">// JAL</span>
<span class="w">        </span><span class="mh">3</span><span class="mi">&#39;d3</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ImmOut</span><span class="p">;</span><span class="w"> </span><span class="c1">// lui</span>
<span class="w">        </span><span class="mh">3</span><span class="mi">&#39;d4</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PCAddImm</span><span class="p">;</span><span class="w"> </span><span class="c1">// auipc</span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">    </span><span class="k">endcase</span><span class="w">      </span>
<span class="k">end</span>

<span class="k">always</span><span class="w"> </span><span class="p">@</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w">  </span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">Branch</span><span class="p">)</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b001</span><span class="o">:</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Branch_one</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">ALU_zero</span><span class="p">);</span><span class="w"> </span><span class="c1">// BEQ</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b010</span><span class="o">:</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Branch_one</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">~</span><span class="n">ALU_zero</span><span class="p">);</span><span class="w"> </span><span class="c1">// BNE</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b011</span><span class="o">:</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Branch_one</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">ALU_out</span><span class="p">[</span><span class="mh">0</span><span class="p">]);</span><span class="w"> </span><span class="c1">// BLT</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b100</span><span class="o">:</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Branch_one</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">~</span><span class="n">ALU_out</span><span class="p">[</span><span class="mh">0</span><span class="p">]);</span><span class="w"> </span><span class="c1">// BGE</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b101</span><span class="o">:</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Branch_one</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">ALU_out</span><span class="p">[</span><span class="mh">0</span><span class="p">]);</span><span class="w"> </span><span class="c1">// BLTU</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b110</span><span class="o">:</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Branch_one</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">~</span><span class="n">ALU_out</span><span class="p">[</span><span class="mh">0</span><span class="p">]);</span><span class="w"> </span><span class="c1">// BGEU </span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">    </span><span class="k">endcase</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">Jump</span><span class="p">)</span>
<span class="w">        </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="o">:</span><span class="w"> </span><span class="n">PC_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">branch_out</span><span class="p">;</span>
<span class="w">        </span><span class="mh">2</span><span class="mb">&#39;b01</span><span class="o">:</span><span class="w"> </span><span class="n">PC_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PCAddImm</span><span class="p">;</span>
<span class="w">        </span><span class="mh">2</span><span class="mb">&#39;b10</span><span class="o">:</span><span class="w"> </span><span class="n">PC_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALU_out</span><span class="p">;</span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">PC_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">    </span><span class="k">endcase</span>
<span class="k">end</span>
<span class="k">always</span><span class="w"> </span><span class="p">@</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">LSwea</span><span class="p">)</span>
<span class="w">        </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="n">LoadData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Data_in</span><span class="p">;</span>
<span class="w">            </span><span class="n">Data_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReadData</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">WHBU</span><span class="p">)</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="o">:</span><span class="w"> </span><span class="n">wea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0001</span><span class="p">;</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0100</span><span class="o">:</span><span class="w"> </span><span class="n">wea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0011</span><span class="p">;</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b1000</span><span class="o">:</span><span class="w"> </span><span class="n">wea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b1111</span><span class="p">;</span>
<span class="w">                </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">wea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">endcase</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="mh">2</span><span class="mb">&#39;b01</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="n">LoadData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">8</span><span class="mb">&#39;b0</span><span class="p">,</span><span class="w"> </span><span class="n">Data_in</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">8</span><span class="p">]};</span>
<span class="w">            </span><span class="n">Data_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">ReadData</span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">0</span><span class="p">],</span><span class="w"> </span><span class="mh">8</span><span class="mb">&#39;b0</span><span class="p">};</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">WHBU</span><span class="p">)</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="o">:</span><span class="w"> </span><span class="n">wea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="p">;</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0100</span><span class="o">:</span><span class="w"> </span><span class="n">wea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0110</span><span class="p">;</span>
<span class="w">                </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">wea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">endcase</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="mh">2</span><span class="mb">&#39;b10</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="n">LoadData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">16</span><span class="mb">&#39;b0</span><span class="p">,</span><span class="w"> </span><span class="n">Data_in</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">16</span><span class="p">]};</span>
<span class="w">            </span><span class="n">Data_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">ReadData</span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">],</span><span class="w"> </span><span class="mh">16</span><span class="mb">&#39;b0</span><span class="p">};</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">WHBU</span><span class="p">)</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="o">:</span><span class="w"> </span><span class="n">wea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0100</span><span class="p">;</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0100</span><span class="o">:</span><span class="w"> </span><span class="n">wea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b1100</span><span class="p">;</span>
<span class="w">                </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">wea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">endcase</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="mh">2</span><span class="mb">&#39;b11</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="n">LoadData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">24</span><span class="mb">&#39;b0</span><span class="p">,</span><span class="w"> </span><span class="n">Data_in</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">24</span><span class="p">]};</span>
<span class="w">            </span><span class="n">Data_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">ReadData</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">],</span><span class="w"> </span><span class="mh">24</span><span class="mb">&#39;b0</span><span class="p">};</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">WHBU</span><span class="p">)</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="o">:</span><span class="w"> </span><span class="n">wea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b1000</span><span class="p">;</span>
<span class="w">                </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">wea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">endcase</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">    </span><span class="k">endcase</span>

<span class="k">end</span>
<span class="k">assign</span><span class="w"> </span><span class="n">ALU_B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALUSrc_B</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">ImmOut</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ReadData</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">branch_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">PCAddImm</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">PCAdd4</span><span class="p">;</span>

<span class="n">ALU</span><span class="w"> </span><span class="n">alu</span><span class="p">(.</span><span class="n">A</span><span class="p">(</span><span class="n">ALU_A</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">B</span><span class="p">(</span><span class="n">ALU_B</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">ALU_operation</span><span class="p">(</span><span class="n">ALU_Control</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">res</span><span class="p">(</span><span class="n">ALU_out</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="p">.</span><span class="n">zero</span><span class="p">(</span><span class="n">ALU_zero</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">overflow</span><span class="p">(</span><span class="n">ALU_overflow</span><span class="p">));</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">RS1</span><span class="p">,</span><span class="w"> </span><span class="n">RS2</span><span class="p">,</span><span class="w"> </span><span class="n">WT</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">RS1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst_field</span><span class="p">[</span><span class="mh">19</span><span class="o">:</span><span class="mh">15</span><span class="p">];</span>
<span class="k">assign</span><span class="w"> </span><span class="n">RS2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst_field</span><span class="p">[</span><span class="mh">24</span><span class="o">:</span><span class="mh">20</span><span class="p">];</span>
<span class="k">assign</span><span class="w"> </span><span class="n">WT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst_field</span><span class="p">[</span><span class="mh">11</span><span class="o">:</span><span class="mh">7</span><span class="p">];</span>
<span class="n">Regs</span><span class="w"> </span><span class="n">regs</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Rs1_addr</span><span class="p">(</span><span class="n">RS1</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Rs2_addr</span><span class="p">(</span><span class="n">RS2</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="p">.</span><span class="n">Wt_addr</span><span class="p">(</span><span class="n">WT</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Wt_data</span><span class="p">(</span><span class="n">reg_wt_data</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">RegWrite</span><span class="p">(</span><span class="n">RegWrite</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="p">.</span><span class="n">Rs1_data</span><span class="p">(</span><span class="n">ALU_A</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Rs2_data</span><span class="p">(</span><span class="n">ReadData</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg00</span><span class="p">(</span><span class="n">Reg00</span><span class="p">),.</span><span class="n">Reg01</span><span class="p">(</span><span class="n">Reg01</span><span class="p">),.</span><span class="n">Reg02</span><span class="p">(</span><span class="n">Reg02</span><span class="p">),.</span><span class="n">Reg03</span><span class="p">(</span><span class="n">Reg03</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg04</span><span class="p">(</span><span class="n">Reg04</span><span class="p">),.</span><span class="n">Reg05</span><span class="p">(</span><span class="n">Reg05</span><span class="p">),.</span><span class="n">Reg06</span><span class="p">(</span><span class="n">Reg06</span><span class="p">),.</span><span class="n">Reg07</span><span class="p">(</span><span class="n">Reg07</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg08</span><span class="p">(</span><span class="n">Reg08</span><span class="p">),.</span><span class="n">Reg09</span><span class="p">(</span><span class="n">Reg09</span><span class="p">),.</span><span class="n">Reg10</span><span class="p">(</span><span class="n">Reg10</span><span class="p">),.</span><span class="n">Reg11</span><span class="p">(</span><span class="n">Reg11</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg12</span><span class="p">(</span><span class="n">Reg12</span><span class="p">),.</span><span class="n">Reg13</span><span class="p">(</span><span class="n">Reg13</span><span class="p">),.</span><span class="n">Reg14</span><span class="p">(</span><span class="n">Reg14</span><span class="p">),.</span><span class="n">Reg15</span><span class="p">(</span><span class="n">Reg15</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg16</span><span class="p">(</span><span class="n">Reg16</span><span class="p">),.</span><span class="n">Reg17</span><span class="p">(</span><span class="n">Reg17</span><span class="p">),.</span><span class="n">Reg18</span><span class="p">(</span><span class="n">Reg18</span><span class="p">),.</span><span class="n">Reg19</span><span class="p">(</span><span class="n">Reg19</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg20</span><span class="p">(</span><span class="n">Reg20</span><span class="p">),.</span><span class="n">Reg21</span><span class="p">(</span><span class="n">Reg21</span><span class="p">),.</span><span class="n">Reg22</span><span class="p">(</span><span class="n">Reg22</span><span class="p">),.</span><span class="n">Reg23</span><span class="p">(</span><span class="n">Reg23</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg24</span><span class="p">(</span><span class="n">Reg24</span><span class="p">),.</span><span class="n">Reg25</span><span class="p">(</span><span class="n">Reg25</span><span class="p">),.</span><span class="n">Reg26</span><span class="p">(</span><span class="n">Reg26</span><span class="p">),.</span><span class="n">Reg27</span><span class="p">(</span><span class="n">Reg27</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg28</span><span class="p">(</span><span class="n">Reg28</span><span class="p">),.</span><span class="n">Reg29</span><span class="p">(</span><span class="n">Reg29</span><span class="p">),.</span><span class="n">Reg30</span><span class="p">(</span><span class="n">Reg30</span><span class="p">),.</span><span class="n">Reg31</span><span class="p">(</span><span class="n">Reg31</span><span class="p">));</span>

<span class="n">ImmGen</span><span class="w"> </span><span class="n">immgen</span><span class="p">(.</span><span class="n">ImmSel</span><span class="p">(</span><span class="n">ImmSel</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">inst_field</span><span class="p">(</span><span class="n">inst_field</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Imm_out</span><span class="p">(</span><span class="n">ImmOut</span><span class="p">));</span>

<span class="n">Reg</span><span class="w"> </span><span class="n">PC</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">PC_in</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">PC_out</span><span class="p">));</span>

<span class="k">endmodule</span>
</code></pre></div>
主要增加了对于  B,J  型指令的选择，增加了多路选择器</p>
<p>同时对于新增的 <code>WHBU</code> 信号更改 RAM 读出，读入的信号：</p>
<p>对于读出到 RAM 的值，用 <code>ReadData</code> 存储 Reg File 读出的值，并根据偏移量使用 <code>Data_out</code> 存储移位后的值，最后传出这个值，写入到 RAM 中</p>
<p>对于读入到寄存器的值，用 <code>Data_in</code> 存储 RAM 读入的值，并进行位移得到 <code>LoadData</code>, 最后写入 RegFile 中</p>
<p>同时新增一个  4  位使能信号 <code>wea</code>, 分别控制 RAM 的  4  个字节的读写</p>
<h3 id="_13">仿真关键步骤说明</h3>
<p>仿真代码同 Lab4-2</p>
<p><em>仿真测试代码：</em></p>
<div class="highlight"><pre><span></span><code>    auipc x1, 0
    j     start            # 00
dummy:
    nop                    # 04
    nop                    # 08
    nop                    # 0C
    nop                    # 10
    nop                    # 14
    nop                    # 18
    nop                    # 1C
    j     dummy

start:
    bnez  x1, dummy
    beq   x0, x0, pass_0
    li    x31, 0
    auipc x30, 0
    j     dummy
pass_0:
    li    x31, 1
    bne   x0, x0, dummy
    bltu  x0, x0, dummy
    li    x1, -1           # x1=FFFFFFFF
    xori  x3, x1, 1        # x3=FFFFFFFE
    add   x3, x3, x3       # x3=FFFFFFFC
    add   x3, x3, x3       # x3=FFFFFFF8
    add   x3, x3, x3       # x3=FFFFFFF0
    add   x3, x3, x3       # x3=FFFFFFE0
    add   x3, x3, x3       # x3=FFFFFFC0
    add   x3, x3, x3       # x3=FFFFFF80
    add   x3, x3, x3       # x3=FFFFFF00
    add   x3, x3, x3       # x3=FFFFFE00
    add   x3, x3, x3       # x3=FFFFFC00
    add   x3, x3, x3       # x3=FFFFF800
    add   x3, x3, x3       # x3=FFFFF000
    add   x3, x3, x3       # x3=FFFFE000
    add   x3, x3, x3       # x3=FFFFC000
    add   x3, x3, x3       # x3=FFFF8000
    add   x3, x3, x3       # x3=FFFF0000
    add   x3, x3, x3       # x3=FFFE0000
    add   x3, x3, x3       # x3=FFFC0000
    add   x3, x3, x3       # x3=FFF80000
    add   x3, x3, x3       # x3=FFF00000
    add   x3, x3, x3       # x3=FFE00000
    add   x3, x3, x3       # x3=FFC00000
    add   x3, x3, x3       # x3=FF800000
    add   x3, x3, x3       # x3=FF000000
    add   x3, x3, x3       # x3=FE000000
    add   x3, x3, x3       # x3=FC000000
    add   x5, x3, x3       # x5=F8000000
    add   x3, x5, x5       # x3=F0000000
    add   x4, x3, x3       # x4=E0000000
    add   x6, x4, x4       # x6=C0000000
    add   x7, x6, x6       # x7=80000000
    ori   x8, zero, 1      # x8=00000001
    ori   x28, zero, 31
    srl   x29, x7, x28     # x29=00000001
    auipc x30, 0
    bne   x8, x29, dummy
    auipc x30, 0
    blt   x8, x7, dummy
    sra   x29, x7, x28     # x29=FFFFFFFF
    and   x29, x29, x3     # x29=x3=F0000000
    auipc x30, 0
    bne   x3, x29, dummy
    mv    x29, x8          # x29=x8=00000001
    bltu  x29, x7, pass_1  # unsigned 00000001 &lt; 80000000
    auipc x30, 0
    j     dummy

pass_1:
    nop
    li    x31, 2
    sub   x3, x6, x7       # x3=40000000
    sub   x4, x7, x3       # x4=40000000
    slti  x9, x0, 1        # x9=00000001
    slt   x10, x3, x4
    slt   x10, x4, x3      # x10=00000000
    auipc x30, 0
    beq   x9, x10, dummy   # branch when x3 != x4
    srli  x29, x3, 30      # x29=00000001
    beq   x29, x9, pass_2
    auipc x30, 0
    j     dummy

pass_2:
    nop
# Test set-less-than
    li    x31, 3
    slti  x10, x1, 3       # x10=00000001
    slt   x11, x5, x1      # signed(0xF8000000) &lt; -1
                        # x11=00000001
    slt   x12, x1, x3      # x12=00000001
    andi  x10, x10, 0xff
    and   x10, x10, x11
    and   x10, x10, x12    # x10=00000001
    auipc x30, 0
    beqz  x10, dummy
    sltu  x10, x1, x8      # unsigned FFFFFFFF &lt; 00000001 ?
    auipc x30, 0
    bnez  x10, dummy
    sltu  x10, x8, x3      # unsigned 00000001 &lt; F0000000 ?
    auipc x30, 0
    beqz  x10, dummy
    sltiu x10, x1, 3
    auipc x30, 0
    bnez  x10, dummy
    li    x11, 1
    bne   x10, x11, pass_3
    auipc x30, 0
    j     dummy

pass_3:
    nop
    li    x31, 4
    or    x11, x7, x3      # x11=C0000000
    beq   x11, x6, pass_4
    auipc x30, 0
    j     dummy

pass_4:
    nop
    li    x31, 5
    li    x18, 0x20        # base addr=00000020
### uncomment instr. below when simulating on venus
    # lui   x18, 0x10000     # base addr=10000000
    sw    x5, 0(x18)       # mem[0x20]=F8000000
    sw    x4, 4(x18)       # mem[0x24]=40000000
    lw    x27, 0(x18)      # x27=mem[0x20]=F8000000
    xor   x27, x27, x5     # x27=00000000
    sw    x6, 0(x18)       # mem[0x20]=C0000000
    lw    x28, 0(x18)      # x28=mem[0x20]=C0000000
    xor   x27, x6, x28     # x27=00000000
    auipc x30, 0
    bnez  x27, dummy
    lui   x20, 0xA0000     # x20=A0000000
    sw    x20, 8(x18)      # mem[0x28]=A0000000
    lui   x27, 0xFEDCB     # x27=FEDCB000
    srai  x27, x27, 12     # x27=FFFFEDCB
    li    x28, 8
    sll   x27, x27, x28    # x27=FFEDCB00
    ori   x27, x27, 0xff   # x27=FFEDCBFF
    lb    x29, 11(x18)     # x29=FFFFFFA0, little-endian, signed-ext
    and   x27, x27, x29    # x27=FFEDCBA0
    sw    x27, 8(x18)      # mem[0x28]=FFEDCBA0
    lhu   x27, 8(x18)      # x27=0000CBA0
    lui   x20, 0xFFFF0     # x20=FFFF0000
    and   x20, x20, x27    # x20=00000000
    auipc x30, 0
    bnez  x20, dummy       # check unsigned-ext
    li    x31, 6
    lbu   x28, 10(x18)     # x28=000000ED
    lbu   x29, 11(x18)     # x29=000000FF
    slli  x29, x29, 8      # x29=0000FF00
    or    x29, x29, x28    # x29=0000FFED
    slli  x29, x29, 16
    or    x29, x27, x29    # x29=FFEDCBA0
    lw    x28, 8(x18)      # x28=FFEDCBA0
    auipc x30, 0
    bne   x28, x29, dummy
    sw    x0, 0(x18)       # mem[0x20]=00000000
    sh    x27, 0(x18)      # mem[0x20]=0000CBA0
    li    x28, 0xD0
    sb    x28, 2(x18)      # mem[0x20]=00D0CBA0
    lw    x28, 0(x18)      # x28=00D0CBA0
    li    x29, 0x00D0CBA0
    auipc x30, 0
    bne   x28, x29, dummy
    lh    x27, 2(x18)      # x27=000000D0
    li    x28, 0xD0
    auipc x30, 0
    bne   x27, x28, dummy

pass_5:
    li    x31, 7
    auipc x30, 0
    bge   x1, x0, dummy    # -1 &gt;= 0 ?
    bge   x8, x1, pass_6   # 1 &gt;= -1 ?
    auipc x30, 0
    j     dummy

pass_6:
    auipc x30, 0
    bgeu  x0, x1, dummy    # 0 &gt;= FFFFFFFF ?
    auipc x30, 0
    bgeu  x8, x1, dummy
    auipc x20, 0
    jalr  x21, x0, pass_7  # just for test : (
    auipc x30, 0
    j     dummy

pass_7:
# jalr -&gt;
    addi  x20, x20, 8
    auipc x30, 0
    bne   x20, x21, dummy
    li    x31, 0x666
    j     dummy
</code></pre></div>
<p>在 Lab4-2 的基础上添加了拓展出的指令，同样在通过测试后进入 Dummy 循环</p>
<h2 id="_14">实验结果与分析</h2>
<h3 id="_15">仿真结果</h3>
<p><img alt="alt text" src="../../images/SCPU/image-5.png" /></p>
<p><img alt="alt text" src="../../images/SCPU/image-6.png" /></p>
<p>由于仿真波形过长，只显示开头和结尾的波形</p>
<p>可以看到，<code>Reg31</code> 的值被改为 <code>666</code>, 说明通过了前面的测试，进入了 Dummy 循环，结果符合预期</p>
<h1 id="lab-4-4">Lab 4-4</h1>
<h2 id="_16">操作方法与实验步骤</h2>
<h3 id="_17">代码设计及说明</h3>
<p><em>1. CSR寄存器及其指令</em></p>
<p>实现  5  个异常寄存器：</p>
<blockquote>
<p>mstatus: Machine Status Register，存储当前控制状态。将第  3  位的 <code>MIE</code> 置为 <code>1</code>, 表示当前已经进入异常/中断处理</p>
<p>mtvec:  Machine Trap-Vector Base-Address Register，存储中断向量表基地址</p>
<p>mcause： Machine Cause Register，存储引起这次 trap 的原因。 如果进入 trap 的原因是中断，则最高位 interrupt bit 设置为 1，若为异常则设为 0。</p>
<p>mtval： Machine Trap Value Register，存储异常的相关信息以帮助软件处理异常，曾称 mbadaddr。</p>
<p>mepc： Machine Exception Program Counter，存储 trap 触发时将要执行的指令地址，在 mret 时作为返回地址。</p>
</blockquote>
<p>以及  6  中指令：<code>csrrw,csrrs,csrrc,csrrwi,csrrsi,csrrci</code>, 来直接更改这  5  个寄存器的值</p>
<p>为此，要实现一个 CSRRegs 模块来管理这些寄存器</p>
<p><em>2. 异常中断处理</em></p>
<p>需要实现两种指令：</p>
<blockquote>
<p>ecall: 软件中断指令</p>
<p>mret: 异常中断返回指令</p>
</blockquote>
<p>同时要新增外部中断信号，实现硬件中断</p>
<p>为此，要实现一个 RV_INT 模块来实现产生输入到 CSRRegs 模块中的旁路输入，同时产生 pc 的更改信号 </p>
<p>还要更改 SCPU_Ctrl 来实现指令识别和中断信号的产生</p>
<p><em>3. trap 程序</em></p>
<p>当触发异常中断处理后，要进入 trap 程序</p>
<p>在程序中，需要读出 <code>mepc, mscause, mtval, mstatus, mtvec</code> 的值，放在某个寄存器当中。为了防止通用寄存器中的有效值丢失，选择在之前代码里未被使用的寄存器。</p>
<p>之后将 <code>mepc</code> 读出，处理 <code>mepc</code>：</p>
<p>对于异常（非法指令），<code>mepc &lt;- mepc + 4</code>。</p>
<p>对于中断，如果是软件中断 <code>ecall</code>，<code>mepc &lt;- mepc + 4</code>。</p>
<p>如果是硬件中断，<code>mepc &lt;- mepc</code>。（使用 mcause 进行区分）</p>
<p>最后调用 mret 返回到原来的程序。（此时要恢复进入处理程序所保存的信息）</p>
<h3 id="_18">源代码</h3>
<p><em>1. CSRRegs 代码：</em></p>
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">CSRRegs</span><span class="p">(</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">clk</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">rst</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">11</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">raddr</span><span class="p">,</span><span class="w">                </span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">11</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">waddr</span><span class="p">,</span><span class="w">                </span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">wdata</span><span class="p">,</span><span class="w">                </span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">csr_w</span><span class="p">,</span><span class="w">                       </span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">csr_wsc_mode</span><span class="p">,</span><span class="w">          </span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">expt_int</span><span class="p">,</span><span class="w">               </span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mepc_bypass_in</span><span class="p">,</span><span class="w">  </span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mcause_bypass_in</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mtval_bypass_in</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mstatus_bypass_in</span><span class="p">,</span><span class="w">    </span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rdata</span><span class="p">,</span><span class="w">     </span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mstatus</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mtvec</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mepc</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mcause</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mtval</span>
<span class="p">);</span>
<span class="w">    </span><span class="c1">//reg [31:0] csr [4095:0]; </span>
<span class="w">    </span><span class="k">localparam</span><span class="w"> </span><span class="n">CSR_WSC_WRITE</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span><span class="w"> </span>
<span class="w">    </span><span class="k">localparam</span><span class="w"> </span><span class="n">CSR_WSC_SET</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b01</span><span class="p">;</span><span class="w"> </span>
<span class="w">    </span><span class="k">localparam</span><span class="w"> </span><span class="n">CSR_WSC_CLEAR</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b10</span><span class="p">;</span><span class="w"> </span>

<span class="w">    </span><span class="k">localparam</span><span class="w"> </span><span class="n">CSR_MSTATUS</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">12&#39;h300</span><span class="p">;</span>
<span class="w">    </span><span class="k">localparam</span><span class="w"> </span><span class="n">CSR_MTVEC</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">12&#39;h305</span><span class="p">;</span>
<span class="w">    </span><span class="k">localparam</span><span class="w"> </span><span class="n">CSR_MEPC</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="mh">12&#39;h341</span><span class="p">;</span>
<span class="w">    </span><span class="k">localparam</span><span class="w"> </span><span class="n">CSR_MCAUSE</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">12&#39;h342</span><span class="p">;</span>
<span class="w">    </span><span class="k">localparam</span><span class="w"> </span><span class="n">CSR_MTVAL</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">12&#39;h343</span><span class="p">;</span>

<span class="w">    </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">raddr</span><span class="p">)</span>
<span class="w">            </span><span class="nl">CSR_MSTATUS:</span><span class="w"> </span><span class="n">rdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mstatus</span><span class="p">;</span>
<span class="w">            </span><span class="nl">CSR_MTVEC:</span><span class="w"> </span><span class="n">rdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mtvec</span><span class="p">;</span>
<span class="w">            </span><span class="nl">CSR_MEPC:</span><span class="w"> </span><span class="n">rdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mepc</span><span class="p">;</span>
<span class="w">            </span><span class="nl">CSR_MCAUSE:</span><span class="w"> </span><span class="n">rdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mcause</span><span class="p">;</span>
<span class="w">            </span><span class="nl">CSR_MTVAL:</span><span class="w"> </span><span class="n">rdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mtval</span><span class="p">;</span>
<span class="w">            </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">rdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span><span class="w"> </span>
<span class="w">        </span><span class="k">endcase</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">posedge</span><span class="w"> </span><span class="n">rst</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rst</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="n">mstatus</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d8</span><span class="p">;</span>
<span class="w">            </span><span class="n">mtvec</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32&#39;h7C</span><span class="p">;</span>
<span class="w">            </span><span class="n">mepc</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">            </span><span class="n">mcause</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">            </span><span class="n">mtval</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">expt_int</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>

<span class="w">                </span><span class="n">mepc</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">mepc_bypass_in</span><span class="p">;</span>
<span class="w">                </span><span class="n">mcause</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">mcause_bypass_in</span><span class="p">;</span>
<span class="w">                </span><span class="n">mtval</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">mtval_bypass_in</span><span class="p">;</span>
<span class="w">                </span><span class="n">mstatus</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">mstatus_bypass_in</span><span class="p">;</span>
<span class="w">            </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">csr_w</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">waddr</span><span class="p">)</span>
<span class="w">                    </span><span class="nl">CSR_MSTATUS:</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                        </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">csr_wsc_mode</span><span class="p">)</span>
<span class="w">                            </span><span class="nl">CSR_WSC_WRITE:</span><span class="w"> </span><span class="n">mstatus</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">wdata</span><span class="p">;</span>
<span class="w">                            </span><span class="nl">CSR_WSC_SET:</span><span class="w">   </span><span class="n">mstatus</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">mstatus</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">wdata</span><span class="p">;</span>
<span class="w">                            </span><span class="nl">CSR_WSC_CLEAR:</span><span class="w"> </span><span class="n">mstatus</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">mstatus</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">wdata</span><span class="p">;</span>
<span class="w">                            </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">mstatus</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">mstatus</span><span class="p">;</span>
<span class="w">                        </span><span class="k">endcase</span>
<span class="w">                    </span><span class="k">end</span>
<span class="w">                    </span><span class="nl">CSR_MTVEC:</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                        </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">csr_wsc_mode</span><span class="p">)</span>
<span class="w">                            </span><span class="nl">CSR_WSC_WRITE:</span><span class="w"> </span><span class="n">mtvec</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">wdata</span><span class="p">;</span>
<span class="w">                            </span><span class="nl">CSR_WSC_SET:</span><span class="w">   </span><span class="n">mtvec</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">mtvec</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">wdata</span><span class="p">;</span>
<span class="w">                            </span><span class="nl">CSR_WSC_CLEAR:</span><span class="w"> </span><span class="n">mtvec</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">mtvec</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">wdata</span><span class="p">;</span>
<span class="w">                            </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">mtvec</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">mtvec</span><span class="p">;</span>
<span class="w">                        </span><span class="k">endcase</span>
<span class="w">                    </span><span class="k">end</span>
<span class="w">                    </span><span class="nl">CSR_MEPC:</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                        </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">csr_wsc_mode</span><span class="p">)</span>
<span class="w">                            </span><span class="nl">CSR_WSC_WRITE:</span><span class="w"> </span><span class="n">mepc</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">wdata</span><span class="p">;</span>
<span class="w">                            </span><span class="nl">CSR_WSC_SET:</span><span class="w">   </span><span class="n">mepc</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">mepc</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">wdata</span><span class="p">;</span>
<span class="w">                            </span><span class="nl">CSR_WSC_CLEAR:</span><span class="w"> </span><span class="n">mepc</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">mepc</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">wdata</span><span class="p">;</span>
<span class="w">                            </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">mepc</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">mepc</span><span class="p">;</span>
<span class="w">                        </span><span class="k">endcase</span>
<span class="w">                    </span><span class="k">end</span>
<span class="w">                    </span><span class="nl">CSR_MCAUSE:</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                        </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">csr_wsc_mode</span><span class="p">)</span>
<span class="w">                            </span><span class="nl">CSR_WSC_WRITE:</span><span class="w"> </span><span class="n">mcause</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">wdata</span><span class="p">;</span>
<span class="w">                            </span><span class="nl">CSR_WSC_SET:</span><span class="w">   </span><span class="n">mcause</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">mcause</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">wdata</span><span class="p">;</span>
<span class="w">                            </span><span class="nl">CSR_WSC_CLEAR:</span><span class="w"> </span><span class="n">mcause</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">mcause</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">wdata</span><span class="p">;</span>
<span class="w">                            </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">mcause</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">mcause</span><span class="p">;</span>
<span class="w">                        </span><span class="k">endcase</span>
<span class="w">                    </span><span class="k">end</span>
<span class="w">                    </span><span class="nl">CSR_MTVAL:</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                        </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">csr_wsc_mode</span><span class="p">)</span>
<span class="w">                            </span><span class="nl">CSR_WSC_WRITE:</span><span class="w"> </span><span class="n">mtval</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">wdata</span><span class="p">;</span>
<span class="w">                            </span><span class="nl">CSR_WSC_SET:</span><span class="w">   </span><span class="n">mtval</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">mtval</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">wdata</span><span class="p">;</span>
<span class="w">                            </span><span class="nl">CSR_WSC_CLEAR:</span><span class="w"> </span><span class="n">mtval</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">mtval</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">wdata</span><span class="p">;</span>
<span class="w">                            </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">mtval</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">mtval</span><span class="p">;</span>
<span class="w">                        </span><span class="k">endcase</span>
<span class="w">                    </span><span class="k">end</span>
<span class="w">                    </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">mtval</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">mtval</span><span class="p">;</span>
<span class="w">                </span><span class="k">endcase</span>

<span class="w">            </span><span class="k">end</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">endmodule</span>
</code></pre></div>
<p>在这个模块中，主要实现了利用  6  种 CSR 指令对于寄存器进行修改；同时，当触发异常中断，使用旁路输入同时更改所有的寄存器</p>
<p><em>2. RV_INT 代码：</em></p>
<p><div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">RV_INT</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">input</span><span class="w">        </span><span class="n">clk</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w">        </span><span class="n">rst</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w">        </span><span class="n">INT</span><span class="p">,</span><span class="w">                </span>
<span class="w">    </span><span class="k">input</span><span class="w">        </span><span class="n">ecall</span><span class="p">,</span><span class="w">              </span>
<span class="w">    </span><span class="k">input</span><span class="w">        </span><span class="n">mret</span><span class="p">,</span><span class="w">               </span>
<span class="w">    </span><span class="k">input</span><span class="w">        </span><span class="n">illegal_inst</span><span class="p">,</span><span class="w">       </span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mstatus</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mtvec</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mepc</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">inst</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">pc_current</span><span class="p">,</span><span class="w">         </span>
<span class="w">    </span><span class="k">output</span><span class="w">       </span><span class="n">en</span><span class="p">,</span><span class="w">                 </span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">   </span><span class="n">expt_int</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">   </span><span class="n">pc_change</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mepc_bypass_in</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mcause_bypass_in</span><span class="p">,</span><span class="w">  </span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mtval_bypass_in</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mstatus_bypass_in</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">pc</span><span class="w">             </span>
<span class="p">);</span>


<span class="w">    </span><span class="k">localparam</span><span class="w"> </span><span class="n">MCAUSE_INT_EXTERNAL</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">32&#39;h8000000B</span><span class="p">;</span><span class="w"> </span>
<span class="w">    </span><span class="k">localparam</span><span class="w"> </span><span class="n">MCAUSE_EXC_ECALL</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">32&#39;h0000000B</span><span class="p">;</span><span class="w"> </span><span class="c1">// ECALL </span>
<span class="w">    </span><span class="k">localparam</span><span class="w"> </span><span class="n">MCAUSE_EXC_ILLEGAL</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">32&#39;h00000002</span><span class="p">;</span><span class="w"> </span>
<span class="c1">//    localparam MCAUSE_EXC_L_ACCESS   = 32&#39;h00000005; </span>
<span class="c1">//    localparam MCAUSE_EXC_J_ACCESS   = 32&#39;h00000007; </span>
<span class="w">    </span><span class="k">localparam</span><span class="w"> </span><span class="n">MSTATUS_ENABLE</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="mh">32&#39;h00000008</span><span class="p">;</span>
<span class="w">    </span><span class="k">localparam</span><span class="w"> </span><span class="n">MSTATUS_UNABLE</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="mh">32&#39;h00000000</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// CSRRegs</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">csr_rdata</span><span class="p">;</span>
<span class="w">    </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">csr_wdata</span><span class="p">;</span>
<span class="w">    </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">11</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">csr_raddr</span><span class="p">,</span><span class="w"> </span><span class="n">csr_waddr</span><span class="p">;</span>
<span class="w">    </span><span class="kt">reg</span><span class="w"> </span><span class="n">csr_w</span><span class="p">;</span>
<span class="w">    </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">csr_wsc_mode</span><span class="p">;</span>
<span class="w">    </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">rst</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="n">expt_int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">            </span><span class="n">mepc_bypass_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">            </span><span class="n">mcause_bypass_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">            </span><span class="n">mtval_bypass_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">            </span><span class="n">mstatus_bypass_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MSTATUS_ENABLE</span><span class="p">;</span>
<span class="w">            </span><span class="n">pc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pc_current</span><span class="p">;</span>
<span class="w">            </span><span class="n">pc_change</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">mstatus</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MSTATUS_ENABLE</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// enabled</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">INT</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                    </span><span class="n">expt_int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">                    </span><span class="n">pc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mtvec</span><span class="p">;</span>
<span class="w">                    </span><span class="n">pc_change</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">                    </span><span class="n">mcause_bypass_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MCAUSE_INT_EXTERNAL</span><span class="p">;</span>
<span class="w">                    </span><span class="n">mstatus_bypass_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MSTATUS_UNABLE</span><span class="p">;</span>
<span class="w">                    </span><span class="n">mepc_bypass_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pc_current</span><span class="p">;</span>
<span class="w">                    </span><span class="n">mtval_bypass_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">                </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ecall</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                    </span><span class="n">expt_int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">                    </span><span class="n">pc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mtvec</span><span class="p">;</span>
<span class="w">                    </span><span class="n">pc_change</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">                    </span><span class="n">mcause_bypass_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MCAUSE_EXC_ECALL</span><span class="p">;</span>
<span class="w">                    </span><span class="n">mstatus_bypass_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MSTATUS_UNABLE</span><span class="p">;</span>
<span class="w">                    </span><span class="n">mepc_bypass_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pc_current</span><span class="p">;</span>
<span class="w">                    </span><span class="n">mtval_bypass_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">                </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">illegal_inst</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                    </span><span class="n">expt_int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">                    </span><span class="n">pc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mtvec</span><span class="p">;</span>
<span class="w">                    </span><span class="n">pc_change</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">                    </span><span class="n">mcause_bypass_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MCAUSE_EXC_ILLEGAL</span><span class="p">;</span>
<span class="w">                    </span><span class="n">mstatus_bypass_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MSTATUS_UNABLE</span><span class="p">;</span>
<span class="w">                    </span><span class="n">mepc_bypass_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pc_current</span><span class="p">;</span>
<span class="w">                    </span><span class="n">mtval_bypass_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst</span><span class="p">;</span>
<span class="w">                </span><span class="k">end</span><span class="w"> </span>
<span class="w">                </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                    </span><span class="n">expt_int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">                    </span><span class="n">pc_change</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">                </span><span class="k">end</span>
<span class="w">            </span><span class="k">end</span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mret</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                    </span><span class="n">expt_int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">                    </span><span class="n">pc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mepc</span><span class="p">;</span>
<span class="w">                    </span><span class="n">pc_change</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">                    </span><span class="n">mcause_bypass_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">                    </span><span class="n">mstatus_bypass_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MSTATUS_ENABLE</span><span class="p">;</span><span class="w"> </span><span class="c1">// clear mark</span>
<span class="w">                    </span><span class="n">mepc_bypass_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">                    </span><span class="n">mtval_bypass_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">                </span><span class="k">end</span><span class="w">        </span>
<span class="w">                </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                    </span><span class="n">expt_int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">                    </span><span class="n">pc_change</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">                </span><span class="k">end</span>
<span class="w">            </span><span class="k">end</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">en</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">expt_int</span><span class="p">;</span>
<span class="k">endmodule</span>
</code></pre></div>
在这个模块中，主要实现了产生旁路输出，并产生 pc 更改信号，传入 DataPath</p>
<p>其中 <code>mcause</code> 的值采用了标准的值，即:</p>
<div class="highlight"><pre><span></span><code><span class="k">localparam</span><span class="w"> </span><span class="n">MCAUSE_INT_EXTERNAL</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">32&#39;h8000000B</span><span class="p">;</span><span class="w"> </span>
<span class="k">localparam</span><span class="w"> </span><span class="n">MCAUSE_EXC_ECALL</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">32&#39;h0000000B</span><span class="p">;</span><span class="w"> </span><span class="c1">// ECALL </span>
<span class="k">localparam</span><span class="w"> </span><span class="n">MCAUSE_EXC_ILLEGAL</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">32&#39;h00000002</span><span class="p">;</span><span class="w"> </span>
</code></pre></div>
<p>最高位为  1  代表是外部中断</p>
<p><em>3. SCPU_Ctrl 代码：</em></p>
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">SCPU_ctrls</span><span class="p">(</span>
<span class="w">  </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">       </span><span class="n">OPcode</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">       </span><span class="n">Fun3</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">             </span><span class="n">Fun7</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">             </span><span class="n">MIO_ready</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">       </span><span class="n">High7</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">ImmSel</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">        </span><span class="n">ALUSrc_B</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">MemtoReg</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">Jump</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">Branch</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">        </span><span class="n">RegWrite</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">        </span><span class="n">MemRW</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">WHBU</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">ALU_Control</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">        </span><span class="n">csr_w</span><span class="p">,</span><span class="w">     </span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">        </span><span class="n">is_csri</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">csr_wsc_mode</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">        </span><span class="n">mret</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">        </span><span class="n">ecall</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">        </span><span class="n">illegal</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">        </span><span class="n">CPU_MIO</span>
<span class="p">);</span>
<span class="k">initial</span><span class="w"> </span><span class="k">begin</span>
<span class="w">  </span><span class="n">ImmSel</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">;</span>
<span class="w">  </span><span class="n">ALUSrc_B</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">  </span><span class="n">MemtoReg</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">;</span><span class="w"> </span><span class="c1">// 0: ALU result 1: Load from RAM to reg  2/3: PC4, JAL</span>
<span class="w">  </span><span class="n">MemRW</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="c1">// write to/read from RAM?</span>
<span class="w">  </span><span class="n">WHBU</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">  </span><span class="n">Jump</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span>
<span class="w">  </span><span class="n">Branch</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">;</span>
<span class="w">  </span><span class="n">RegWrite</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>

<span class="w">  </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span>
<span class="w">  </span><span class="c1">//CPU_MIO   = 1&#39;b0;</span>
<span class="k">end</span>
<span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">OPcode</span><span class="p">)</span>
<span class="w">    </span><span class="mh">5</span><span class="mb">&#39;b01100</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// R-type </span>
<span class="w">      </span><span class="n">is_csri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">mret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">ecall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">csr_wsc_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span><span class="w">  </span>
<span class="w">      </span><span class="n">illegal</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">WHBU</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">ALUSrc_B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">MemtoReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">;</span>
<span class="w">      </span><span class="n">RegWrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">      </span><span class="c1">//ImmSel   = 2&#39;b00; // no imm</span>
<span class="w">      </span><span class="c1">//MemRW    = 1&#39;bx; // no read or write </span>
<span class="w">      </span><span class="n">Jump</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span>
<span class="w">      </span><span class="n">Branch</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">;</span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="p">({</span><span class="n">Fun3</span><span class="p">,</span><span class="w"> </span><span class="n">Fun7</span><span class="p">})</span>
<span class="w">        </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span><span class="w"> </span><span class="c1">// ADD</span>
<span class="w">        </span><span class="mh">4</span><span class="mb">&#39;b0001</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0001</span><span class="p">;</span><span class="w"> </span><span class="c1">// SUB</span>
<span class="w">        </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="p">;</span><span class="w"> </span><span class="c1">// SLL</span>
<span class="w">        </span><span class="mh">4</span><span class="mb">&#39;b0100</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0011</span><span class="p">;</span><span class="w"> </span><span class="c1">// SLT</span>
<span class="w">        </span><span class="mh">4</span><span class="mb">&#39;b0110</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0100</span><span class="p">;</span><span class="w"> </span><span class="c1">// SLTU</span>
<span class="w">        </span><span class="mh">4</span><span class="mb">&#39;b1000</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0101</span><span class="p">;</span><span class="w"> </span><span class="c1">// XOR</span>
<span class="w">        </span><span class="mh">4</span><span class="mb">&#39;b1010</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0110</span><span class="p">;</span><span class="w"> </span><span class="c1">// SRL</span>
<span class="w">        </span><span class="mh">4</span><span class="mb">&#39;b1011</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0111</span><span class="p">;</span><span class="w"> </span><span class="c1">// SRA</span>
<span class="w">        </span><span class="mh">4</span><span class="mb">&#39;b1100</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b1000</span><span class="p">;</span><span class="w"> </span><span class="c1">// OR</span>
<span class="w">        </span><span class="mh">4</span><span class="mb">&#39;b1110</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b1001</span><span class="p">;</span><span class="w"> </span><span class="c1">// AND</span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span>
<span class="w">      </span><span class="k">endcase</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="mh">5</span><span class="mb">&#39;b11100</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// I-type csr</span>
<span class="w">      </span><span class="n">illegal</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">WHBU</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">ALUSrc_B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">MemtoReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b101</span><span class="p">;</span>
<span class="w">      </span><span class="n">RegWrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span><span class="w"> </span><span class="c1">// write into rd</span>
<span class="w">      </span><span class="n">ImmSel</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b101</span><span class="p">;</span>
<span class="w">      </span><span class="n">Jump</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span>
<span class="w">      </span><span class="n">Branch</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">;</span>
<span class="w">      </span><span class="n">csr_w</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">Fun3</span><span class="p">)</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span>
<span class="w">          </span><span class="c1">//expt_int = 1&#39;b1;</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">High7</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">7</span><span class="mb">&#39;b0011000</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// mret</span>
<span class="w">              </span><span class="n">mret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">              </span><span class="n">ecall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">          </span><span class="k">end</span>
<span class="w">          </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// ecall</span>
<span class="w">              </span><span class="n">mret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">              </span><span class="n">ecall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">          </span><span class="k">end</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b001</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">is_csri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">mret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">ecall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">csr_wsc_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span><span class="k">end</span><span class="c1">// csrrw</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b010</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">is_csri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">mret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">ecall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">csr_wsc_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b01</span><span class="p">;</span><span class="k">end</span><span class="c1">// csrrs</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b011</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">is_csri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">mret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">ecall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">csr_wsc_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b10</span><span class="p">;</span><span class="k">end</span><span class="c1">// csrrc</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b101</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">is_csri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span><span class="w"> </span><span class="n">mret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">ecall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">csr_wsc_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span><span class="k">end</span><span class="c1">// csrrwi</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b110</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">is_csri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span><span class="w"> </span><span class="n">mret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">ecall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">csr_wsc_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b01</span><span class="p">;</span><span class="k">end</span><span class="c1">// csrrsi</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b111</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">is_csri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span><span class="w"> </span><span class="n">mret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">ecall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">csr_wsc_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b10</span><span class="p">;</span><span class="k">end</span><span class="c1">// csrrci</span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">is_csri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">mret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">ecall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">csr_wsc_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span><span class="k">end</span>
<span class="w">      </span><span class="k">endcase</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="mh">5</span><span class="mb">&#39;b00000</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// Load </span>
<span class="w">      </span><span class="n">is_csri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">mret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">ecall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">csr_wsc_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span>
<span class="w">      </span><span class="n">illegal</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">ALUSrc_B</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">      </span><span class="n">MemtoReg</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b001</span><span class="p">;</span>
<span class="w">      </span><span class="n">RegWrite</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">      </span><span class="n">ImmSel</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">;</span>
<span class="w">      </span><span class="n">MemRW</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="c1">// read</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">Fun3</span><span class="p">)</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="o">:</span><span class="w"> </span><span class="n">WHBU</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="p">;</span><span class="w"> </span><span class="c1">// LB</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b001</span><span class="o">:</span><span class="w"> </span><span class="n">WHBU</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0100</span><span class="p">;</span><span class="w"> </span><span class="c1">// LH</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b010</span><span class="o">:</span><span class="w"> </span><span class="n">WHBU</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b1000</span><span class="p">;</span><span class="w"> </span><span class="c1">// LW</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b100</span><span class="o">:</span><span class="w"> </span><span class="n">WHBU</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0011</span><span class="p">;</span><span class="w"> </span><span class="c1">// LBU</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b101</span><span class="o">:</span><span class="w"> </span><span class="n">WHBU</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0101</span><span class="p">;</span><span class="w"> </span><span class="c1">// LHU</span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">WHBU</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span>
<span class="w">      </span><span class="k">endcase</span>
<span class="w">      </span><span class="n">Jump</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span>
<span class="w">      </span><span class="n">Branch</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">;</span>
<span class="w">      </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span><span class="w"> </span><span class="c1">// ADD for address calculation</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="mh">5</span><span class="mb">&#39;b01000</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// Store </span>
<span class="w">      </span><span class="n">is_csri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">mret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">ecall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">csr_wsc_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span>
<span class="w">      </span><span class="n">illegal</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">ALUSrc_B</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">      </span><span class="c1">//MemtoReg  = 2&#39;b01;</span>
<span class="w">      </span><span class="n">MemtoReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="p">&#39;</span><span class="n">bx</span><span class="p">;</span>
<span class="w">      </span><span class="c1">//RegWrite  = 1&#39;b1;</span>
<span class="w">      </span><span class="n">RegWrite</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">ImmSel</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b001</span><span class="p">;</span>
<span class="w">      </span><span class="n">MemRW</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span><span class="w"> </span><span class="c1">// write</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">Fun3</span><span class="p">)</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="o">:</span><span class="w"> </span><span class="n">WHBU</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="p">;</span><span class="w"> </span><span class="c1">// SB</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b001</span><span class="o">:</span><span class="w"> </span><span class="n">WHBU</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0100</span><span class="p">;</span><span class="w"> </span><span class="c1">// SH</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b010</span><span class="o">:</span><span class="w"> </span><span class="n">WHBU</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b1000</span><span class="p">;</span><span class="w"> </span><span class="c1">// SW</span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">WHBU</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span>
<span class="w">      </span><span class="k">endcase</span>

<span class="w">      </span><span class="n">Jump</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span>
<span class="w">      </span><span class="n">Branch</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">;</span><span class="w"> </span>
<span class="w">      </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span><span class="w"> </span><span class="c1">// ADD for address calculation</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="mh">5</span><span class="mb">&#39;b11000</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// Branch</span>
<span class="w">      </span><span class="n">is_csri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">mret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">ecall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">csr_wsc_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span>
<span class="w">      </span><span class="n">illegal</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">WHBU</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span>
<span class="w">      </span><span class="n">ALUSrc_B</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">MemtoReg</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="p">&#39;</span><span class="n">bx</span><span class="p">;</span><span class="w"> </span><span class="c1">// new</span>
<span class="w">      </span><span class="n">RegWrite</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="c1">//</span>
<span class="w">      </span><span class="n">ImmSel</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b010</span><span class="p">;</span><span class="w"> </span>
<span class="w">      </span><span class="c1">//MemRW     = 1&#39;bx;</span>

<span class="w">      </span><span class="c1">//Branch    = 1&#39;b1;</span>
<span class="w">      </span><span class="n">Jump</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">Fun3</span><span class="p">)</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">Branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b001</span><span class="p">;</span><span class="w">  </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d1</span><span class="p">;</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="c1">// BEQ, do SUB in ALU </span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b001</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">Branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b010</span><span class="p">;</span><span class="w">  </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d1</span><span class="p">;</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="c1">// BNE</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b100</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">Branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b011</span><span class="p">;</span><span class="w">  </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d3</span><span class="p">;</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="c1">// BLT, do SLT in ALU</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b101</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">Branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b100</span><span class="p">;</span><span class="w">  </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d3</span><span class="p">;</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="c1">// BGE</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b110</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">Branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b101</span><span class="p">;</span><span class="w">  </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d4</span><span class="p">;</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="c1">// BLTU, do SLTU in ALU</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b111</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">Branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b110</span><span class="p">;</span><span class="w">  </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d4</span><span class="p">;</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="c1">// BGEU </span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">Branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">;</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d0</span><span class="p">;</span><span class="w"> </span><span class="k">end</span>
<span class="w">      </span><span class="k">endcase</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="mh">5</span><span class="mb">&#39;b11011</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// JAL </span>
<span class="w">      </span><span class="n">is_csri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">mret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">ecall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">csr_wsc_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span>
<span class="w">      </span><span class="n">illegal</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">WHBU</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span>
<span class="w">      </span><span class="c1">//ALUSrc_B = 1&#39;b1;</span>
<span class="w">      </span><span class="n">ALUSrc_B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="p">&#39;</span><span class="n">bx</span><span class="p">;</span>
<span class="w">      </span><span class="n">MemtoReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b010</span><span class="p">;</span><span class="w"> </span><span class="c1">// PC + 4</span>
<span class="w">      </span><span class="n">RegWrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span><span class="w"> </span><span class="c1">//</span>
<span class="w">      </span><span class="n">ImmSel</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b011</span><span class="p">;</span>
<span class="w">      </span><span class="c1">// MemRW = 1&#39;bx;</span>

<span class="w">      </span><span class="n">Jump</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b01</span><span class="p">;</span>
<span class="w">      </span><span class="n">Branch</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="mh">5</span><span class="mb">&#39;b00100</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// I-type ALU</span>
<span class="w">      </span><span class="n">illegal</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">WHBU</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span><span class="w"> </span>
<span class="w">      </span><span class="n">ALUSrc_B</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">      </span><span class="n">MemtoReg</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">;</span>
<span class="w">      </span><span class="n">RegWrite</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">      </span><span class="n">ImmSel</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">;</span>
<span class="w">      </span><span class="c1">//MemRW     = 1&#39;bx; </span>

<span class="w">      </span><span class="n">Jump</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span>
<span class="w">      </span><span class="n">Branch</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">;</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">Fun3</span><span class="p">)</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span><span class="w"> </span><span class="c1">// ADDI</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b001</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="p">;</span><span class="w"> </span><span class="c1">// SLLI</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b010</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0011</span><span class="p">;</span><span class="w"> </span><span class="c1">// SLTI</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b011</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0100</span><span class="p">;</span><span class="w"> </span><span class="c1">// SLTIU</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b100</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0101</span><span class="p">;</span><span class="w"> </span><span class="c1">// XORI</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b101</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Fun7</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0111</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0110</span><span class="p">;</span><span class="w"> </span><span class="c1">// SRAI / SRLI</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b110</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b1000</span><span class="p">;</span><span class="w"> </span><span class="c1">// ORI</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b111</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b1001</span><span class="p">;</span><span class="w"> </span><span class="c1">// ANDI</span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span>
<span class="w">      </span><span class="k">endcase</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="mh">5</span><span class="mb">&#39;b11001</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// I-type JALR</span>
<span class="w">      </span><span class="n">is_csri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">mret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">ecall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">csr_wsc_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span>
<span class="w">      </span><span class="n">illegal</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">WHBU</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span>
<span class="w">      </span><span class="n">ALUSrc_B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">      </span><span class="n">MemtoReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b010</span><span class="p">;</span><span class="w"> </span><span class="c1">// PC + 4</span>
<span class="w">      </span><span class="n">RegWrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span><span class="w"> </span><span class="c1">//</span>
<span class="w">      </span><span class="n">ImmSel</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">;</span>
<span class="w">      </span><span class="c1">//MemRW    = 1&#39;b0;</span>

<span class="w">      </span><span class="n">MemRW</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="p">&#39;</span><span class="n">bx</span><span class="p">;</span>
<span class="w">      </span><span class="n">Jump</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b10</span><span class="p">;</span>
<span class="w">      </span><span class="n">Branch</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">;</span>
<span class="w">      </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d0</span><span class="p">;</span><span class="w"> </span><span class="c1">// ADD</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="mh">5</span><span class="mb">&#39;b01101</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// lui</span>
<span class="w">      </span><span class="n">is_csri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">mret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">ecall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">csr_wsc_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span>
<span class="w">      </span><span class="n">illegal</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">WHBU</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span>
<span class="w">      </span><span class="n">ALUSrc_B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="p">&#39;</span><span class="n">bx</span><span class="p">;</span>
<span class="w">      </span><span class="n">MemtoReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b11</span><span class="p">;</span><span class="w"> </span><span class="c1">// lui_res = Imm</span>
<span class="w">      </span><span class="n">RegWrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span><span class="w"> </span><span class="c1">//</span>
<span class="w">      </span><span class="n">ImmSel</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b100</span><span class="p">;</span><span class="w"> </span><span class="c1">// U-type</span>
<span class="w">      </span><span class="n">MemRW</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="p">&#39;</span><span class="n">bx</span><span class="p">;</span>
<span class="w">      </span><span class="n">Jump</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span>
<span class="w">      </span><span class="n">Branch</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">;</span>
<span class="w">      </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="p">&#39;</span><span class="n">dx</span><span class="p">;</span><span class="w"> </span><span class="c1">// ADD</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="mh">5</span><span class="mb">&#39;b00101</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// auipc</span>
<span class="w">      </span><span class="n">is_csri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">mret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">ecall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">csr_wsc_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span>
<span class="w">      </span><span class="n">illegal</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">WHBU</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span>
<span class="w">      </span><span class="n">ALUSrc_B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="p">&#39;</span><span class="n">bx</span><span class="p">;</span>
<span class="w">      </span><span class="n">MemtoReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b100</span><span class="p">;</span><span class="w"> </span><span class="c1">// auipc_res = PC + Imm</span>
<span class="w">      </span><span class="n">RegWrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span><span class="w"> </span><span class="c1">//</span>
<span class="w">      </span><span class="n">ImmSel</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b100</span><span class="p">;</span>
<span class="w">      </span><span class="n">MemRW</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="p">&#39;</span><span class="n">bx</span><span class="p">;</span>
<span class="w">      </span><span class="n">Jump</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span>
<span class="w">      </span><span class="n">Branch</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">;</span>
<span class="w">      </span><span class="n">ALU_Control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="p">&#39;</span><span class="n">dx</span><span class="p">;</span><span class="w"> </span><span class="c1">// ADD</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">illegal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span><span class="w"> </span><span class="c1">// illegal instruction</span>
<span class="w">  </span><span class="k">endcase</span>
<span class="k">end</span>
<span class="k">endmodule</span>
</code></pre></div>
<p>更改的部分为：</p>
<p><div class="highlight"><pre><span></span><code><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">  </span><span class="k">case</span><span class="p">(</span><span class="n">OPcode</span><span class="p">)</span><span class="o">:</span>
<span class="w">    </span><span class="mh">5</span><span class="mb">&#39;b11100</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// I-type csr</span>
<span class="w">      </span><span class="n">illegal</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">WHBU</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">ALUSrc_B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">MemtoReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b101</span><span class="p">;</span>
<span class="w">      </span><span class="n">RegWrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span><span class="w"> </span><span class="c1">// write into rd</span>
<span class="w">      </span><span class="n">ImmSel</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b101</span><span class="p">;</span>
<span class="w">      </span><span class="n">Jump</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span>
<span class="w">      </span><span class="n">Branch</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">;</span>
<span class="w">      </span><span class="n">csr_w</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">Fun3</span><span class="p">)</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">High7</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">7</span><span class="mb">&#39;b0011000</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// mret</span>
<span class="w">              </span><span class="n">mret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">              </span><span class="n">ecall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">          </span><span class="k">end</span>
<span class="w">          </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// ecall</span>
<span class="w">              </span><span class="n">mret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">              </span><span class="n">ecall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">          </span><span class="k">end</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b001</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">is_csri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">mret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">ecall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">csr_wsc_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span><span class="k">end</span><span class="c1">// csrrw</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b010</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">is_csri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">mret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">ecall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">csr_wsc_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b01</span><span class="p">;</span><span class="k">end</span><span class="c1">// csrrs</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b011</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">is_csri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">mret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">ecall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">csr_wsc_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b10</span><span class="p">;</span><span class="k">end</span><span class="c1">// csrrc</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b101</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">is_csri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span><span class="w"> </span><span class="n">mret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">ecall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">csr_wsc_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span><span class="k">end</span><span class="c1">// csrrwi</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b110</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">is_csri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span><span class="w"> </span><span class="n">mret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">ecall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">csr_wsc_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b01</span><span class="p">;</span><span class="k">end</span><span class="c1">// csrrsi</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b111</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">is_csri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span><span class="w"> </span><span class="n">mret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">ecall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">csr_wsc_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b10</span><span class="p">;</span><span class="k">end</span><span class="c1">// csrrci</span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">is_csri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">mret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">ecall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"> </span><span class="n">csr_wsc_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span><span class="k">end</span>
<span class="w">      </span><span class="k">endcase</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">endcase</span>
<span class="k">end</span>
</code></pre></div>
即产生对应的异常控制信号</p>
<p><em>4. DataPath 代码：</em>
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">DataPaths</span><span class="p">(</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ImmSel</span><span class="p">,</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="n">ALUSrc_B</span><span class="p">,</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">MemtoReg</span><span class="p">,</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Jump</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Branch</span><span class="p">,</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="n">RegWrite</span><span class="p">,</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ALU_Control</span><span class="p">,</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="n">is_csri</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">csr_wsc_mode</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">csr_w</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">illegal</span><span class="p">,</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="n">mret</span><span class="p">,</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="n">ecall</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">INT</span><span class="p">,</span><span class="w"> </span><span class="c1">// external interruption</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Data_in</span><span class="p">,</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="n">clk</span><span class="p">,</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">inst_field</span><span class="p">,</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="n">rst</span><span class="p">,</span><span class="w"> </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">WHBU</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg00</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg01</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg02</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg03</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg04</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg05</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg06</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg07</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg08</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg09</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg10</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg11</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg12</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg13</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg14</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg15</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg16</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg17</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg18</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg19</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg20</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg21</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg22</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg23</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg24</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg25</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg26</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg27</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg28</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg29</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg30</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg31</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ALU_out</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Data_out</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_out</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">out_wea</span><span class="p">);</span>

<span class="kt">reg</span><span class="w"> </span><span class="n">branch</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="n">Branch_one</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">branch_out</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="n">ALU_zero</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="n">ALU_overflow</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PCAddImm</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ALU_A</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ALU_B</span><span class="p">;</span>
<span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PCAdd4</span><span class="p">;</span>
<span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_in</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ImmOut</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">LSwea</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="n">expt_int</span><span class="p">;</span>
<span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">wea</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rdata</span><span class="p">;</span>
<span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">LoadData</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ReadData</span><span class="p">;</span>

<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mepc_bypass_in</span><span class="p">;</span><span class="w"> </span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mcause_bypass_in</span><span class="p">;</span><span class="w">    </span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mtval_bypass_in</span><span class="p">;</span><span class="w">  </span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mstatus_bypass_in</span><span class="p">;</span><span class="w">      </span>

<span class="k">assign</span><span class="w"> </span><span class="n">LSwea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ImmOut</span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
<span class="k">assign</span><span class="w"> </span><span class="n">PCAdd4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PC_out</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d4</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">Branch_one</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Branch</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">PCAddImm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ImmOut</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PC_out</span><span class="p">;</span><span class="w"> </span><span class="c1">// ALU ? Adder!</span>

<span class="k">always</span><span class="w"> </span><span class="p">@</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">MemtoReg</span><span class="p">)</span>
<span class="w">        </span><span class="mh">3</span><span class="mi">&#39;d0</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALU_out</span><span class="p">;</span><span class="w"> </span><span class="c1">// ALU</span>
<span class="w">        </span><span class="mh">3</span><span class="mi">&#39;d1</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">WHBU</span><span class="p">)</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="mh">24</span><span class="p">{</span><span class="n">LoadData</span><span class="p">[</span><span class="mh">7</span><span class="p">]}},</span><span class="w"> </span><span class="n">LoadData</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]};</span><span class="w"> </span><span class="c1">// LB</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0100</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="mh">16</span><span class="p">{</span><span class="n">LoadData</span><span class="p">[</span><span class="mh">15</span><span class="p">]}},</span><span class="w"> </span><span class="n">LoadData</span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]};</span><span class="w"> </span><span class="c1">// LH</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b1000</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LoadData</span><span class="p">;</span><span class="w"> </span><span class="c1">// LW</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0011</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">24</span><span class="mb">&#39;b0</span><span class="p">,</span><span class="w"> </span><span class="n">LoadData</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]};</span><span class="w"> </span><span class="c1">// LBU</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0101</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">16</span><span class="mb">&#39;b0</span><span class="p">,</span><span class="w"> </span><span class="n">LoadData</span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]};</span><span class="w"> </span><span class="c1">// LHU</span>
<span class="w">                </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">endcase</span><span class="w"> </span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="mh">3</span><span class="mi">&#39;d2</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PCAdd4</span><span class="p">;</span><span class="w"> </span><span class="c1">// JAL</span>
<span class="w">        </span><span class="mh">3</span><span class="mi">&#39;d3</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ImmOut</span><span class="p">;</span><span class="w"> </span><span class="c1">// lui</span>
<span class="w">        </span><span class="mh">3</span><span class="mi">&#39;d4</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PCAddImm</span><span class="p">;</span><span class="w"> </span><span class="c1">// auipc</span>
<span class="w">        </span><span class="mh">3</span><span class="mi">&#39;d5</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rdata</span><span class="p">;</span><span class="w"> </span><span class="c1">// csr</span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">    </span><span class="k">endcase</span><span class="w">      </span>
<span class="k">end</span>

<span class="k">always</span><span class="w"> </span><span class="p">@</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w">  </span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">Branch</span><span class="p">)</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b001</span><span class="o">:</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Branch_one</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">ALU_zero</span><span class="p">);</span><span class="w"> </span><span class="c1">// BEQ</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b010</span><span class="o">:</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Branch_one</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">~</span><span class="n">ALU_zero</span><span class="p">);</span><span class="w"> </span><span class="c1">// BNE</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b011</span><span class="o">:</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Branch_one</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">ALU_out</span><span class="p">[</span><span class="mh">0</span><span class="p">]);</span><span class="w"> </span><span class="c1">// BLT</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b100</span><span class="o">:</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Branch_one</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">~</span><span class="n">ALU_out</span><span class="p">[</span><span class="mh">0</span><span class="p">]);</span><span class="w"> </span><span class="c1">// BGE</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b101</span><span class="o">:</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Branch_one</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">ALU_out</span><span class="p">[</span><span class="mh">0</span><span class="p">]);</span><span class="w"> </span><span class="c1">// BLTU</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b110</span><span class="o">:</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Branch_one</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">~</span><span class="n">ALU_out</span><span class="p">[</span><span class="mh">0</span><span class="p">]);</span><span class="w"> </span><span class="c1">// BGEU </span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">    </span><span class="k">endcase</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">Jump</span><span class="p">)</span>
<span class="w">        </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="o">:</span><span class="w"> </span><span class="n">PC_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">branch_out</span><span class="p">;</span>
<span class="w">        </span><span class="mh">2</span><span class="mb">&#39;b01</span><span class="o">:</span><span class="w"> </span><span class="n">PC_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PCAddImm</span><span class="p">;</span>
<span class="w">        </span><span class="mh">2</span><span class="mb">&#39;b10</span><span class="o">:</span><span class="w"> </span><span class="n">PC_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALU_out</span><span class="p">;</span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">PC_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">        </span><span class="c1">//2&#39;b11: PC_in = ALU_out;</span>
<span class="w">    </span><span class="k">endcase</span>
<span class="k">end</span>
<span class="k">always</span><span class="w"> </span><span class="p">@</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">LSwea</span><span class="p">)</span>
<span class="w">        </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="n">LoadData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Data_in</span><span class="p">;</span>
<span class="w">            </span><span class="n">Data_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReadData</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">WHBU</span><span class="p">)</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="o">:</span><span class="w"> </span><span class="n">wea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0001</span><span class="p">;</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0100</span><span class="o">:</span><span class="w"> </span><span class="n">wea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0011</span><span class="p">;</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b1000</span><span class="o">:</span><span class="w"> </span><span class="n">wea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b1111</span><span class="p">;</span>
<span class="w">                </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">wea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">endcase</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="mh">2</span><span class="mb">&#39;b01</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="n">LoadData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">8</span><span class="mb">&#39;b0</span><span class="p">,</span><span class="w"> </span><span class="n">Data_in</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">8</span><span class="p">]};</span>
<span class="w">            </span><span class="n">Data_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">ReadData</span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">0</span><span class="p">],</span><span class="w"> </span><span class="mh">8</span><span class="mb">&#39;b0</span><span class="p">};</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">WHBU</span><span class="p">)</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="o">:</span><span class="w"> </span><span class="n">wea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="p">;</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0100</span><span class="o">:</span><span class="w"> </span><span class="n">wea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0110</span><span class="p">;</span>
<span class="w">                </span><span class="c1">//4&#39;b1000: wea = 4&#39;b1111;</span>
<span class="w">                </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">wea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">endcase</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="mh">2</span><span class="mb">&#39;b10</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="n">LoadData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">16</span><span class="mb">&#39;b0</span><span class="p">,</span><span class="w"> </span><span class="n">Data_in</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">16</span><span class="p">]};</span>
<span class="w">            </span><span class="n">Data_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">ReadData</span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">],</span><span class="w"> </span><span class="mh">16</span><span class="mb">&#39;b0</span><span class="p">};</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">WHBU</span><span class="p">)</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="o">:</span><span class="w"> </span><span class="n">wea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0100</span><span class="p">;</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0100</span><span class="o">:</span><span class="w"> </span><span class="n">wea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b1100</span><span class="p">;</span>
<span class="w">                </span><span class="c1">//4&#39;b1000: wea = 4&#39;b1111;</span>
<span class="w">                </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">wea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">endcase</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="mh">2</span><span class="mb">&#39;b11</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="n">LoadData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">24</span><span class="mb">&#39;b0</span><span class="p">,</span><span class="w"> </span><span class="n">Data_in</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">24</span><span class="p">]};</span>
<span class="w">            </span><span class="n">Data_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">ReadData</span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">0</span><span class="p">],</span><span class="w"> </span><span class="mh">24</span><span class="mb">&#39;b0</span><span class="p">};</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">WHBU</span><span class="p">)</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="o">:</span><span class="w"> </span><span class="n">wea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b1000</span><span class="p">;</span>
<span class="w">                </span><span class="c1">//4&#39;b0100: wea = 4&#39;b1100;</span>
<span class="w">                </span><span class="c1">//4&#39;b1000: wea = 4&#39;b1111;</span>
<span class="w">                </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">wea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">endcase</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">endcase</span>

<span class="k">end</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">wdata</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">ALU_B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALUSrc_B</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">ImmOut</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ReadData</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">branch_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">PCAddImm</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">PCAdd4</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">wdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">is_csri</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">ImmOut</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ALU_A</span><span class="p">;</span><span class="w"> </span><span class="c1">// uimm or rs1</span>
<span class="kt">wire</span><span class="w"> </span><span class="n">pc_change</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="n">en</span><span class="p">;</span>
<span class="n">ALU</span><span class="w"> </span><span class="n">alu</span><span class="p">(.</span><span class="n">A</span><span class="p">(</span><span class="n">ALU_A</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">B</span><span class="p">(</span><span class="n">ALU_B</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">ALU_operation</span><span class="p">(</span><span class="n">ALU_Control</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">res</span><span class="p">(</span><span class="n">ALU_out</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="p">.</span><span class="n">zero</span><span class="p">(</span><span class="n">ALU_zero</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">overflow</span><span class="p">(</span><span class="n">ALU_overflow</span><span class="p">));</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">RS1</span><span class="p">,</span><span class="w"> </span><span class="n">RS2</span><span class="p">,</span><span class="w"> </span><span class="n">WT</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">RS1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst_field</span><span class="p">[</span><span class="mh">19</span><span class="o">:</span><span class="mh">15</span><span class="p">];</span>
<span class="k">assign</span><span class="w"> </span><span class="n">RS2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst_field</span><span class="p">[</span><span class="mh">24</span><span class="o">:</span><span class="mh">20</span><span class="p">];</span>
<span class="k">assign</span><span class="w"> </span><span class="n">WT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst_field</span><span class="p">[</span><span class="mh">11</span><span class="o">:</span><span class="mh">7</span><span class="p">];</span>
<span class="n">Regs</span><span class="w"> </span><span class="n">regs</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Rs1_addr</span><span class="p">(</span><span class="n">RS1</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Rs2_addr</span><span class="p">(</span><span class="n">RS2</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="p">.</span><span class="n">Wt_addr</span><span class="p">(</span><span class="n">WT</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Wt_data</span><span class="p">(</span><span class="n">reg_wt_data</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">RegWrite</span><span class="p">(</span><span class="n">RegWrite</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">en</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="p">.</span><span class="n">Rs1_data</span><span class="p">(</span><span class="n">ALU_A</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Rs2_data</span><span class="p">(</span><span class="n">ReadData</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg00</span><span class="p">(</span><span class="n">Reg00</span><span class="p">),.</span><span class="n">Reg01</span><span class="p">(</span><span class="n">Reg01</span><span class="p">),.</span><span class="n">Reg02</span><span class="p">(</span><span class="n">Reg02</span><span class="p">),.</span><span class="n">Reg03</span><span class="p">(</span><span class="n">Reg03</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg04</span><span class="p">(</span><span class="n">Reg04</span><span class="p">),.</span><span class="n">Reg05</span><span class="p">(</span><span class="n">Reg05</span><span class="p">),.</span><span class="n">Reg06</span><span class="p">(</span><span class="n">Reg06</span><span class="p">),.</span><span class="n">Reg07</span><span class="p">(</span><span class="n">Reg07</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg08</span><span class="p">(</span><span class="n">Reg08</span><span class="p">),.</span><span class="n">Reg09</span><span class="p">(</span><span class="n">Reg09</span><span class="p">),.</span><span class="n">Reg10</span><span class="p">(</span><span class="n">Reg10</span><span class="p">),.</span><span class="n">Reg11</span><span class="p">(</span><span class="n">Reg11</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg12</span><span class="p">(</span><span class="n">Reg12</span><span class="p">),.</span><span class="n">Reg13</span><span class="p">(</span><span class="n">Reg13</span><span class="p">),.</span><span class="n">Reg14</span><span class="p">(</span><span class="n">Reg14</span><span class="p">),.</span><span class="n">Reg15</span><span class="p">(</span><span class="n">Reg15</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg16</span><span class="p">(</span><span class="n">Reg16</span><span class="p">),.</span><span class="n">Reg17</span><span class="p">(</span><span class="n">Reg17</span><span class="p">),.</span><span class="n">Reg18</span><span class="p">(</span><span class="n">Reg18</span><span class="p">),.</span><span class="n">Reg19</span><span class="p">(</span><span class="n">Reg19</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg20</span><span class="p">(</span><span class="n">Reg20</span><span class="p">),.</span><span class="n">Reg21</span><span class="p">(</span><span class="n">Reg21</span><span class="p">),.</span><span class="n">Reg22</span><span class="p">(</span><span class="n">Reg22</span><span class="p">),.</span><span class="n">Reg23</span><span class="p">(</span><span class="n">Reg23</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg24</span><span class="p">(</span><span class="n">Reg24</span><span class="p">),.</span><span class="n">Reg25</span><span class="p">(</span><span class="n">Reg25</span><span class="p">),.</span><span class="n">Reg26</span><span class="p">(</span><span class="n">Reg26</span><span class="p">),.</span><span class="n">Reg27</span><span class="p">(</span><span class="n">Reg27</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg28</span><span class="p">(</span><span class="n">Reg28</span><span class="p">),.</span><span class="n">Reg29</span><span class="p">(</span><span class="n">Reg29</span><span class="p">),.</span><span class="n">Reg30</span><span class="p">(</span><span class="n">Reg30</span><span class="p">),.</span><span class="n">Reg31</span><span class="p">(</span><span class="n">Reg31</span><span class="p">));</span>



<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">11</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mstatus</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mtvec</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mepc</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst_field</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">20</span><span class="p">];</span>
<span class="n">CSRRegs</span><span class="w"> </span><span class="n">csrregs</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">raddr</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="p">.</span><span class="n">waddr</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">wdata</span><span class="p">(</span><span class="n">wdata</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rdata</span><span class="p">(</span><span class="n">rdata</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">csr_w</span><span class="p">(</span><span class="n">csr_w</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">csr_wsc_mode</span><span class="p">(</span><span class="n">csr_wsc_mode</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">expt_int</span><span class="p">(</span><span class="n">expt_int</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">mepc_bypass_in</span><span class="p">(</span><span class="n">mepc_bypass_in</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">mcause_bypass_in</span><span class="p">(</span><span class="n">mcause_bypass_in</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">mtval_bypass_in</span><span class="p">(</span><span class="n">mtval_bypass_in</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">mstatus_bypass_in</span><span class="p">(</span><span class="n">mstatus_bypass_in</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">mstatus</span><span class="p">(</span><span class="n">mstatus</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">mtvec</span><span class="p">(</span><span class="n">mtvec</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">mepc</span><span class="p">(</span><span class="n">mepc</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>


<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">EN</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">EN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">en</span><span class="p">,</span><span class="w"> </span><span class="n">en</span><span class="p">,</span><span class="w"> </span><span class="n">en</span><span class="p">,</span><span class="w"> </span><span class="n">en</span><span class="p">};</span>
<span class="k">assign</span><span class="w"> </span><span class="n">out_wea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wea</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">EN</span><span class="p">;</span>

<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">INTPC</span><span class="p">;</span>
<span class="n">RV_INT</span><span class="w"> </span><span class="n">rv_int</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">INT</span><span class="p">(</span><span class="n">INT</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">expt_int</span><span class="p">(</span><span class="n">expt_int</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">ecall</span><span class="p">(</span><span class="n">ecall</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">mret</span><span class="p">(</span><span class="n">mret</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="p">.</span><span class="n">illegal_inst</span><span class="p">(</span><span class="n">illegal</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">pc_current</span><span class="p">(</span><span class="n">PC_out</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">en</span><span class="p">(</span><span class="n">en</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">pc</span><span class="p">(</span><span class="n">INTPC</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">pc_change</span><span class="p">(</span><span class="n">pc_change</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="p">.</span><span class="n">mepc_bypass_in</span><span class="p">(</span><span class="n">mepc_bypass_in</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">mcause_bypass_in</span><span class="p">(</span><span class="n">mcause_bypass_in</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="p">.</span><span class="n">mtval_bypass_in</span><span class="p">(</span><span class="n">mtval_bypass_in</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">mstatus_bypass_in</span><span class="p">(</span><span class="n">mstatus_bypass_in</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">mstatus</span><span class="p">(</span><span class="n">mstatus</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">mtvec</span><span class="p">(</span><span class="n">mtvec</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">mepc</span><span class="p">(</span><span class="n">mepc</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">inst</span><span class="p">(</span><span class="n">inst_field</span><span class="p">));</span>

<span class="n">ImmGen</span><span class="w"> </span><span class="n">immgen</span><span class="p">(.</span><span class="n">ImmSel</span><span class="p">(</span><span class="n">ImmSel</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">inst_field</span><span class="p">(</span><span class="n">inst_field</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Imm_out</span><span class="p">(</span><span class="n">ImmOut</span><span class="p">));</span>


<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_IN</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">PC_IN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pc_change</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">INTPC</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">PC_in</span><span class="p">;</span>

<span class="n">Reg</span><span class="w"> </span><span class="n">PC</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">PC_IN</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">PC_out</span><span class="p">));</span>

<span class="k">endmodule</span>
</code></pre></div>
更改的部分为：</p>
<p><div class="highlight"><pre><span></span><code><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">wdata</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">wdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">is_csri</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">ImmOut</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ALU_A</span><span class="p">;</span><span class="w"> </span><span class="c1">// uimm or rs1</span>
<span class="kt">wire</span><span class="w"> </span><span class="n">pc_change</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">11</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mstatus</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mtvec</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mepc</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst_field</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">20</span><span class="p">];</span>
<span class="n">CSRRegs</span><span class="w"> </span><span class="n">csrregs</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">raddr</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="p">.</span><span class="n">waddr</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">wdata</span><span class="p">(</span><span class="n">wdata</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rdata</span><span class="p">(</span><span class="n">rdata</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">csr_w</span><span class="p">(</span><span class="n">csr_w</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">csr_wsc_mode</span><span class="p">(</span><span class="n">csr_wsc_mode</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">expt_int</span><span class="p">(</span><span class="n">expt_int</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">mepc_bypass_in</span><span class="p">(</span><span class="n">mepc_bypass_in</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">mcause_bypass_in</span><span class="p">(</span><span class="n">mcause_bypass_in</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">mtval_bypass_in</span><span class="p">(</span><span class="n">mtval_bypass_in</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">mstatus_bypass_in</span><span class="p">(</span><span class="n">mstatus_bypass_in</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">mstatus</span><span class="p">(</span><span class="n">mstatus</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">mtvec</span><span class="p">(</span><span class="n">mtvec</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">mepc</span><span class="p">(</span><span class="n">mepc</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>

<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">INTPC</span><span class="p">;</span>
<span class="n">RV_INT</span><span class="w"> </span><span class="n">rv_int</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">INT</span><span class="p">(</span><span class="n">INT</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">expt_int</span><span class="p">(</span><span class="n">expt_int</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">ecall</span><span class="p">(</span><span class="n">ecall</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">mret</span><span class="p">(</span><span class="n">mret</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="p">.</span><span class="n">illegal_inst</span><span class="p">(</span><span class="n">illegal</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">pc_current</span><span class="p">(</span><span class="n">PC_out</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">en</span><span class="p">(</span><span class="n">en</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">pc</span><span class="p">(</span><span class="n">INTPC</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">pc_change</span><span class="p">(</span><span class="n">pc_change</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="p">.</span><span class="n">mepc_bypass_in</span><span class="p">(</span><span class="n">mepc_bypass_in</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">mcause_bypass_in</span><span class="p">(</span><span class="n">mcause_bypass_in</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="p">.</span><span class="n">mtval_bypass_in</span><span class="p">(</span><span class="n">mtval_bypass_in</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">mstatus_bypass_in</span><span class="p">(</span><span class="n">mstatus_bypass_in</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">mstatus</span><span class="p">(</span><span class="n">mstatus</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">mtvec</span><span class="p">(</span><span class="n">mtvec</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">mepc</span><span class="p">(</span><span class="n">mepc</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">inst</span><span class="p">(</span><span class="n">inst_field</span><span class="p">));</span>

<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_IN</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">PC_IN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pc_change</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">INTPC</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">PC_in</span><span class="p">;</span>

<span class="n">Reg</span><span class="w"> </span><span class="n">PC</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">PC_IN</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">PC_out</span><span class="p">));</span>
</code></pre></div>
即实例化了 CSRRegs 和 RV_INT 模块，完成接线，并将 PC 值的输入进行选择</p>
<h3 id="_19">仿真关键步骤说明</h3>
<p>仿真代码同 Lab4-2</p>
<p><em>2. 仿真测试代码：</em></p>
<div class="highlight"><pre><span></span><code>    j    start            # 00
dummy:
    nop                   # 04
    nop                   # 08
    nop                   # 0C
    nop                   # 10
    nop                   # 14
    nop                   # 18
    nop                   # 1C
    j    dummy

start:
    addi x1, x0, 1
    add x2, x1, x0
    add x3, x2, x1
    add x4, x3, x2
    add x5, x4, x3
    add x6, x5, x4
    addi x7, x0, 0x7c
    csrrs x0, 0x305, x7
    csrrc x0, 0x341, x3
    csrrci x0, 0x342, x4
    csrrsi x0, 0x343, x5
    csrrwi x21, 0x300, x8
    # Here will be an illegal instruction
    add x7, x6, x5
    add x8, x7, x6
    add x9, x8, x7
    ecall
    add x10, x9, x8
    add x11, x10, x9
    add x12, x11, x10
pass_1:
    li   x31, 0x666
    j    dummy
trap:
    csrrs x21, 0x300, x0 # mstatus
    csrrs x22, 0x305, x0 # mtvec
    csrrs x23, 0x341, x0 # mepc
    csrrs x24, 0x342, x0 # mcause
    csrrs x25, 0x343, x0 # mtval
    lui x26, 0x80000
    addi x26, x26, 0x00B
    beq x24, x26, return
illegal_ecall:
    addi x23, x23, 4
    csrrw x0, 0x341, x23
    beq x0, x0, return
return:
    add x0, x0, x0
</code></pre></div>
<p>这是基本的测试 CSR 指令的代码，并且包含了 trap 代码</p>
<p>在仿真波形测试中，会加入硬件中断, 非法指令和软件中断</p>
<h2 id="_20">实验结果与分析</h2>
<h3 id="_21">仿真结果</h3>
<p><img alt="alt text" src="../../images/SCPU/image-7.png" /></p>
<p><img alt="alt text" src="../../images/SCPU/image-8.png" /></p>
<p><img alt="alt text" src="../../images/SCPU/image-9.png" /></p>
<p><img alt="alt text" src="../../images/SCPU/image-10.png" /></p>
<p>可以看到，再出现第一个非法指令 <code>ffffffff</code> 后，程序保存了 <code>mepc=54</code> 并跳转到了 trap 程序</p>
<p>在 trap 里面用寄存器保存了五个异常寄存器的值，并更改 <code>mepc=58</code>，因为不是硬件中断，所以要将 <code>mepc = mepc + 4</code></p>
<p>之后程序返回到了 <code>pc=58</code> 并继续运行</p>
<p>之后，程序遇到了 <code>ecall</code> 指令，同样保存了 <code>mepc=64</code> 并跳转到了 trap 程序</p>
<p>在 trap 里面用寄存器保存了五个异常寄存器的值，并更改 <code>mepc=68</code>，因为不是硬件中断，所以要将 <code>mepc = mepc + 4</code></p>
<p>在这期间，<code>INT</code> 被置为 <code>1</code>, 表示外部中断被打开，但是程序没有触发新的中断，因为当前已经在中断中了，这一表现符合不触发新中断的要求</p>
<p>之后程序返回到了 <code>pc=68</code> 并继续运行</p>
<p>之后程序遇到了另一个外部中断，同样保存了 <code>mepc=6c</code> 并跳转到了 trap 程序</p>
<p>在 trap 里面用寄存器保存了五个异常寄存器的值，并更改 <code>mepc=6c</code>，因为是硬件中断，所以要将 <code>mepc = mepc</code></p>
<p>之后程序返回到了 <code>pc=6c</code> 并继续运行</p>
<p>之后运行到 <code>pc=78</code>, 主程序结束，<code>Reg31=666</code> 并且进入 dummy 循环，说明测试通过，结果符合预期</p>
<h2 id="_22">思考题</h2>
<blockquote>
<p>在涉及到一个大立即数的读入时，我们经常能想到使用 <code>lui &amp; addi</code> 来实现，比如下面这段代码就将 <code>0x22223333</code> 赋给了 <code>t0</code>:
<div class="highlight"><pre><span></span><code><span class="n">lui</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="mh">0</span><span class="n">x22223</span>
<span class="n">addi</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="mh">0</span><span class="n">x333</span>
</code></pre></div>
你是否能通过以下代码得到 <code>0xDEADBEEF</code>？如果你觉得不能的话，先解释为什么不能，再修改代码中的一个字符，使得以下代码有效地得到 <code>0xDEADBEEF</code>。
<div class="highlight"><pre><span></span><code><span class="n">lui</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="mh">0</span><span class="n">xDEADB</span><span class="w"> </span>
<span class="n">addi</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mh">273</span><span class="w"> </span><span class="c1">// 0xEEF</span>
</code></pre></div></p>
</blockquote>
<p><em>回答：</em></p>
<p>上面的代码会得到 <code>DEADAEEF</code>, 主要原因是 <code>addi</code> 指令会将指令中的  12  位数据进行符号拓展后产生  32  位的立即数，所以由 <code>-273</code> 产生的立即数为 <code>FFFFFEEF</code>, 所以与 <code>lui</code> 产生的 <code>DEADB000</code> 相加，结果为 <code>DEADAEEF</code></p>
<p>只改变一个字符解决方法，可以改成：</p>
<div class="highlight"><pre><span></span><code><span class="n">lui</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="mh">0</span><span class="n">xDEADC</span>
<span class="n">addi</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mh">273</span><span class="w"> </span><span class="c1">// 0xEEF</span>
</code></pre></div>
<p>这样，高  20  位的 <code>DEADC</code> 就会与 <code>FFFFF</code> 相加得到 <code>DEADB</code>, 最后就能得到 <code>DEADBEEF</code></p>
<h1 id="pcpu">PCPU</h1>
<h1 id="lab-5-1">Lab 5-1</h1>
<h2 id="_23">操作方法与实验步骤</h2>
<h3 id="_24">代码设计层次结构图及说明</h3>
<p><img alt="pi" src="../../images/PCPU/Pipeline.drawio.png" /></p>
<p>在流水线 CPU 中, 需要将单周期 CPU 拆成 <span class="arithmatex">\(5\)</span> 个阶段, 分别是 <code>IF, ID, EX, MEM, WB</code> 阶段</p>
<p>同时需要将每个阶段中的重要信号通过阶段寄存器传到下一个阶段</p>
<ul>
<li>
<p><code>IF</code> 阶段主要实现通过 <code>PCSrc</code> 取址, 从 ROM 取出对应的指令</p>
</li>
<li>
<p><code>ID</code> 阶段主要实现 <code>SCPU_Ctrl</code> 用于产生控制信号, <code>RegFile</code> 寄存器堆用于读取, 写入寄存器值, 还有 <code>ImmGen</code> 用于产生指令对应的立即数</p>
</li>
</ul>
<p>同时产生 <code>StoreData</code> 用于 <code>store</code> 指令存储值</p>
<ul>
<li>
<p><code>EX</code> 阶段主要实现 <code>ALU</code> 用于计算</p>
</li>
<li>
<p><code>MEM</code> 阶段主要实现输出存入 RAM 中的值, 以及从 RAM 中读入的值传入下一阶段</p>
</li>
</ul>
<p>以及产生 <code>PCSrc</code> 用于分支跳转
* <code>WB</code> 阶段主要实现产生寄存器需要写入的值, 并送回 <code>ID</code> 阶段</p>
<h3 id="_25">源代码</h3>
<ol>
<li>整体的流水线 CPU 代码:</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">Pipeline_CPU</span><span class="p">(</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">clk</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">rst</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Data_in</span><span class="p">,</span><span class="w">  </span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">inst_IF</span><span class="p">,</span><span class="w">  </span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Addr_out</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Data_out</span><span class="p">,</span><span class="w">  </span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Data_out_WB</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_out_IF</span><span class="p">,</span><span class="w">  </span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">inst_ID</span><span class="p">,</span><span class="w">  </span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_out_ID</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_out_EX</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="n">MemRW_EX</span><span class="p">,</span><span class="w">  </span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="n">MemRW_Mem</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">wea</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg00</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg01</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg02</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg03</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg04</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg05</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg06</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg07</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg08</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg09</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg10</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg11</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg12</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg13</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg14</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg15</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg16</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg17</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg18</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg19</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg20</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg21</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg22</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg23</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg24</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg25</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg26</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg27</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg28</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg29</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg30</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg31</span>

<span class="p">);</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_out_EXMem</span><span class="p">,</span><span class="w"> </span><span class="n">ALU_out_EXMem</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Rd_addr_out_MemWB</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="n">RegWrite_out_MemWB</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PCSrc</span><span class="p">;</span>

<span class="w">    </span><span class="n">Pipeline_IF</span><span class="w"> </span><span class="n">PPLIF</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">.</span><span class="n">clk_IF</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">rst_IF</span><span class="p">(</span><span class="n">rst</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">en_IF</span><span class="p">(</span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC_in_IF</span><span class="p">(</span><span class="n">PC_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PCSrc</span><span class="p">(</span><span class="n">PCSrc</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">ALU_in_IF</span><span class="p">(</span><span class="n">ALU_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC_out_IF</span><span class="p">(</span><span class="n">PC_out_IF</span><span class="p">)</span>

<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_out_IFID</span><span class="p">,</span><span class="w"> </span><span class="n">inst_out_IFID</span><span class="p">;</span>


<span class="w">    </span><span class="n">IF_reg_ID</span><span class="w"> </span><span class="n">PPLIFID</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">.</span><span class="n">clk_IFID</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">rst_IFID</span><span class="p">(</span><span class="n">rst</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">en_IFID</span><span class="p">(</span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="p">.</span><span class="n">PC_in_IFID</span><span class="p">(</span><span class="n">PC_out_IF</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">inst_in_IFID</span><span class="p">(</span><span class="n">inst_IF</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC_out_IFID</span><span class="p">(</span><span class="n">PC_out_IFID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">inst_out_IFID</span><span class="p">(</span><span class="n">inst_out_IFID</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>


<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Rs1_out_ID</span><span class="p">,</span><span class="w"> </span><span class="n">Rs2_out_ID</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="n">Imm_out_ID</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="n">ALUSrc_B_ID</span><span class="p">,</span><span class="w"> </span><span class="n">MemRW_ID</span><span class="p">,</span><span class="w"> </span><span class="n">RegWrite_out_ID</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Rd_addr_out_ID</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ALU_control_ID</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Branch_ID</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Jump_ID</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">MemtoReg_ID</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">WHBU_ID</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">LSwea_ID</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">StoreData_ID</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">wea_ID</span><span class="p">;</span>



<span class="w">    </span><span class="n">Pipeline_ID</span><span class="w"> </span><span class="n">PPLID</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">.</span><span class="n">clk_ID</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">rst_ID</span><span class="p">(</span><span class="n">rst</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">RegWrite_in_ID</span><span class="p">(</span><span class="n">RegWrite_out_MemWB</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="p">.</span><span class="n">Rd_addr_ID</span><span class="p">(</span><span class="n">Rd_addr_out_MemWB</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="p">.</span><span class="n">Wt_data_ID</span><span class="p">(</span><span class="n">Data_out_WB</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="p">.</span><span class="n">inst_in_ID</span><span class="p">(</span><span class="n">inst_out_IFID</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="p">.</span><span class="n">Rd_addr_out_ID</span><span class="p">(</span><span class="n">Rd_addr_out_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Rs1_out_ID</span><span class="p">(</span><span class="n">Rs1_out_ID</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="p">.</span><span class="n">Rs2_out_ID</span><span class="p">(</span><span class="n">Rs2_out_ID</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="p">.</span><span class="n">Imm_out_ID</span><span class="p">(</span><span class="n">Imm_out_ID</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="p">.</span><span class="n">ALUSrc_B_ID</span><span class="p">(</span><span class="n">ALUSrc_B_ID</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="p">.</span><span class="n">ALU_control_ID</span><span class="p">(</span><span class="n">ALU_control_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Branch_ID</span><span class="p">(</span><span class="n">Branch_ID</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="p">.</span><span class="n">MemRW_ID</span><span class="p">(</span><span class="n">MemRW_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Jump_ID</span><span class="p">(</span><span class="n">Jump_ID</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="p">.</span><span class="n">MemtoReg_ID</span><span class="p">(</span><span class="n">MemtoReg_ID</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="p">.</span><span class="n">RegWrite_out_ID</span><span class="p">(</span><span class="n">RegWrite_out_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">WHBU_ID</span><span class="p">(</span><span class="n">WHBU_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">LSwea_ID</span><span class="p">(</span><span class="n">LSwea_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">StoreData_ID</span><span class="p">(</span><span class="n">StoreData_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">wea_ID</span><span class="p">(</span><span class="n">wea_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Reg00</span><span class="p">(</span><span class="n">Reg00</span><span class="p">),.</span><span class="n">Reg01</span><span class="p">(</span><span class="n">Reg01</span><span class="p">),.</span><span class="n">Reg02</span><span class="p">(</span><span class="n">Reg02</span><span class="p">),.</span><span class="n">Reg03</span><span class="p">(</span><span class="n">Reg03</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Reg04</span><span class="p">(</span><span class="n">Reg04</span><span class="p">),.</span><span class="n">Reg05</span><span class="p">(</span><span class="n">Reg05</span><span class="p">),.</span><span class="n">Reg06</span><span class="p">(</span><span class="n">Reg06</span><span class="p">),.</span><span class="n">Reg07</span><span class="p">(</span><span class="n">Reg07</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Reg08</span><span class="p">(</span><span class="n">Reg08</span><span class="p">),.</span><span class="n">Reg09</span><span class="p">(</span><span class="n">Reg09</span><span class="p">),.</span><span class="n">Reg10</span><span class="p">(</span><span class="n">Reg10</span><span class="p">),.</span><span class="n">Reg11</span><span class="p">(</span><span class="n">Reg11</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Reg12</span><span class="p">(</span><span class="n">Reg12</span><span class="p">),.</span><span class="n">Reg13</span><span class="p">(</span><span class="n">Reg13</span><span class="p">),.</span><span class="n">Reg14</span><span class="p">(</span><span class="n">Reg14</span><span class="p">),.</span><span class="n">Reg15</span><span class="p">(</span><span class="n">Reg15</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Reg16</span><span class="p">(</span><span class="n">Reg16</span><span class="p">),.</span><span class="n">Reg17</span><span class="p">(</span><span class="n">Reg17</span><span class="p">),.</span><span class="n">Reg18</span><span class="p">(</span><span class="n">Reg18</span><span class="p">),.</span><span class="n">Reg19</span><span class="p">(</span><span class="n">Reg19</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Reg20</span><span class="p">(</span><span class="n">Reg20</span><span class="p">),.</span><span class="n">Reg21</span><span class="p">(</span><span class="n">Reg21</span><span class="p">),.</span><span class="n">Reg22</span><span class="p">(</span><span class="n">Reg22</span><span class="p">),.</span><span class="n">Reg23</span><span class="p">(</span><span class="n">Reg23</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Reg24</span><span class="p">(</span><span class="n">Reg24</span><span class="p">),.</span><span class="n">Reg25</span><span class="p">(</span><span class="n">Reg25</span><span class="p">),.</span><span class="n">Reg26</span><span class="p">(</span><span class="n">Reg26</span><span class="p">),.</span><span class="n">Reg27</span><span class="p">(</span><span class="n">Reg27</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Reg28</span><span class="p">(</span><span class="n">Reg28</span><span class="p">),.</span><span class="n">Reg29</span><span class="p">(</span><span class="n">Reg29</span><span class="p">),.</span><span class="n">Reg30</span><span class="p">(</span><span class="n">Reg30</span><span class="p">),.</span><span class="n">Reg31</span><span class="p">(</span><span class="n">Reg31</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_out_IDEX</span><span class="p">,</span><span class="w"> </span><span class="n">Rs1_out_IDEX</span><span class="p">,</span><span class="w"> </span><span class="n">Rs2_out_IDEX</span><span class="p">,</span><span class="w"> </span><span class="n">Imm_out_IDEX</span><span class="p">;</span><span class="w"> </span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Rd_addr_out_IDEX</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="n">ALUSrc_B_out_IDEX</span><span class="p">,</span><span class="w"> </span><span class="n">MemRW_out_IDEX</span><span class="p">,</span><span class="w"> </span><span class="n">RegWrite_out_IDEX</span><span class="p">;</span>

<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ALU_control_out_IDEX</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Branch_out_IDEX</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Jump_out_IDEX</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">MemtoReg_out_IDEX</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">WHBU_out_IDEX</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">LSwea_out_IDEX</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">StoreData_out_IDEX</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">wea_out_IDEX</span><span class="p">;</span>


<span class="w">    </span><span class="n">ID_reg_Ex</span><span class="w"> </span><span class="n">PPLIDEx</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">.</span><span class="n">clk_IDEX</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">rst_IDEX</span><span class="p">(</span><span class="n">rst</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">en_IDEX</span><span class="p">(</span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC_in_IDEX</span><span class="p">(</span><span class="n">PC_out_IFID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Rd_addr_IDEX</span><span class="p">(</span><span class="n">Rd_addr_out_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Rs1_in_IDEX</span><span class="p">(</span><span class="n">Rs1_out_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Rs2_in_IDEX</span><span class="p">(</span><span class="n">Rs2_out_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Imm_in_IDEX</span><span class="p">(</span><span class="n">Imm_out_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">ALUSrc_B_in_IDEX</span><span class="p">(</span><span class="n">ALUSrc_B_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">ALU_control_in_IDEX</span><span class="p">(</span><span class="n">ALU_control_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Branch_in_IDEX</span><span class="p">(</span><span class="n">Branch_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Jump_in_IDEX</span><span class="p">(</span><span class="n">Jump_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">MemRW_in_IDEX</span><span class="p">(</span><span class="n">MemRW_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">MemtoReg_in_IDEX</span><span class="p">(</span><span class="n">MemtoReg_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">RegWrite_in_IDEX</span><span class="p">(</span><span class="n">RegWrite_out_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">WHBU_in_IDEX</span><span class="p">(</span><span class="n">WHBU_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">LSwea_in_IDEX</span><span class="p">(</span><span class="n">LSwea_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">StoreData_in_IDEX</span><span class="p">(</span><span class="n">StoreData_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">wea_in_IDEX</span><span class="p">(</span><span class="n">wea_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC_out_IDEX</span><span class="p">(</span><span class="n">PC_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Rd_addr_out_IDEX</span><span class="p">(</span><span class="n">Rd_addr_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Rs1_out_IDEX</span><span class="p">(</span><span class="n">Rs1_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Rs2_out_IDEX</span><span class="p">(</span><span class="n">Rs2_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Imm_out_IDEX</span><span class="p">(</span><span class="n">Imm_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">ALUSrc_B_out_IDEX</span><span class="p">(</span><span class="n">ALUSrc_B_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">ALU_control_out_IDEX</span><span class="p">(</span><span class="n">ALU_control_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Branch_out_IDEX</span><span class="p">(</span><span class="n">Branch_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Jump_out_IDEX</span><span class="p">(</span><span class="n">Jump_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">MemRW_out_IDEX</span><span class="p">(</span><span class="n">MemRW_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">MemtoReg_out_IDEX</span><span class="p">(</span><span class="n">MemtoReg_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">RegWrite_out_IDEX</span><span class="p">(</span><span class="n">RegWrite_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">WHBU_out_IDEX</span><span class="p">(</span><span class="n">WHBU_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">LSwea_out_IDEX</span><span class="p">(</span><span class="n">LSwea_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">StoreData_out_IDEX</span><span class="p">(</span><span class="n">StoreData_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">wea_out_IDEX</span><span class="p">(</span><span class="n">wea_out_IDEX</span><span class="p">)</span>

<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC4_out_EX</span><span class="p">,</span><span class="w"> </span><span class="n">zero_out_EX</span><span class="p">,</span><span class="w"> </span><span class="n">ALU_out_EX</span><span class="p">,</span><span class="w"> </span><span class="n">Rs2_out_EX</span><span class="p">;</span>

<span class="w">    </span><span class="n">Pipeline_Ex</span><span class="w"> </span><span class="n">PPLEx</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC_in_EX</span><span class="p">(</span><span class="n">PC_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Rs1_in_EX</span><span class="p">(</span><span class="n">Rs1_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Rs2_in_EX</span><span class="p">(</span><span class="n">Rs2_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Imm_in_EX</span><span class="p">(</span><span class="n">Imm_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">ALUSrc_B_in_EX</span><span class="p">(</span><span class="n">ALUSrc_B_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">ALU_control_in_EX</span><span class="p">(</span><span class="n">ALU_control_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC_out_EX</span><span class="p">(</span><span class="n">PC_out_EX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC4_out_EX</span><span class="p">(</span><span class="n">PC4_out_EX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">zero_out_EX</span><span class="p">(</span><span class="n">zero_out_EX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">ALU_out_EX</span><span class="p">(</span><span class="n">ALU_out_EX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Rs2_out_EX</span><span class="p">(</span><span class="n">Rs2_out_EX</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC4_out_EXMem</span><span class="p">,</span><span class="w"> </span><span class="n">Rs2_out_EXMem</span><span class="p">,</span><span class="w"> </span><span class="n">Imm_out_EXMem</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Rd_addr_out_EXMem</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="n">zero_out_EXMem</span><span class="p">,</span><span class="w"> </span><span class="n">MemRW_out_EXMem</span><span class="p">,</span><span class="w"> </span><span class="n">RegWrite_out_EXMem</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Branch_out_EXMem</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Jump_out_EXMem</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">MemtoReg_out_EXMem</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">WHBU_out_EXMem</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">LSwea_out_EXMem</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">StoreData_out_EXMem</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">wea_out_EXMem</span><span class="p">;</span>


<span class="w">    </span><span class="n">Ex_reg_Mem</span><span class="w"> </span><span class="n">PPLExMem</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">.</span><span class="n">clk_EXMem</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">rst_EXMem</span><span class="p">(</span><span class="n">rst</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">en_EXMem</span><span class="p">(</span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC_in_EXMem</span><span class="p">(</span><span class="n">PC_out_EX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Imm_in_EXMem</span><span class="p">(</span><span class="n">Imm_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC4_in_EXMem</span><span class="p">(</span><span class="n">PC4_out_EX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Rd_addr_EXMem</span><span class="p">(</span><span class="n">Rd_addr_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">zero_in_EXMem</span><span class="p">(</span><span class="n">zero_out_EX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">ALU_in_EXMem</span><span class="p">(</span><span class="n">ALU_out_EX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Rs2_in_EXMem</span><span class="p">(</span><span class="n">Rs2_out_EX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Branch_in_EXMem</span><span class="p">(</span><span class="n">Branch_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Jump_in_EXMem</span><span class="p">(</span><span class="n">Jump_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">MemRW_in_EXMem</span><span class="p">(</span><span class="n">MemRW_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">MemtoReg_in_EXMem</span><span class="p">(</span><span class="n">MemtoReg_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">RegWrite_in_EXMem</span><span class="p">(</span><span class="n">RegWrite_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">WHBU_in_EXMem</span><span class="p">(</span><span class="n">WHBU_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">LSwea_in_EXMem</span><span class="p">(</span><span class="n">LSwea_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">StoreData_in_EXMem</span><span class="p">(</span><span class="n">StoreData_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">wea_in_EXMem</span><span class="p">(</span><span class="n">wea_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC_out_EXMem</span><span class="p">(</span><span class="n">PC_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Imm_out_EXMem</span><span class="p">(</span><span class="n">Imm_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC4_out_EXMem</span><span class="p">(</span><span class="n">PC4_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Rd_addr_out_EXMem</span><span class="p">(</span><span class="n">Rd_addr_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">zero_out_EXMem</span><span class="p">(</span><span class="n">zero_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">ALU_out_EXMem</span><span class="p">(</span><span class="n">ALU_out_EXMem</span><span class="p">),</span>

<span class="w">        </span><span class="p">.</span><span class="n">Rs2_out_EXMem</span><span class="p">(</span><span class="n">Rs2_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Branch_out_EXMem</span><span class="p">(</span><span class="n">Branch_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Jump_out_EXMem</span><span class="p">(</span><span class="n">Jump_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">MemRW_out_EXMem</span><span class="p">(</span><span class="n">MemRW_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">MemtoReg_out_EXMem</span><span class="p">(</span><span class="n">MemtoReg_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">RegWrite_out_EXMem</span><span class="p">(</span><span class="n">RegWrite_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">WHBU_out_EXMem</span><span class="p">(</span><span class="n">WHBU_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">LSwea_out_EXMem</span><span class="p">(</span><span class="n">LSwea_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">StoreData_out_EXMem</span><span class="p">(</span><span class="n">StoreData_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">wea_out_EXMem</span><span class="p">(</span><span class="n">wea_out_EXMem</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="n">Pipeline_Mem</span><span class="w"> </span><span class="n">PPLMem</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">.</span><span class="n">zero_in_Mem</span><span class="p">(</span><span class="n">zero_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">res_in_Mem</span><span class="p">(</span><span class="n">ALU_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Branch_in_Mem</span><span class="p">(</span><span class="n">Branch_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Jump_in_Mem</span><span class="p">(</span><span class="n">Jump_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PCSrc</span><span class="p">(</span><span class="n">PCSrc</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_out_MemWB</span><span class="p">,</span><span class="w"> </span><span class="n">Imm_out_MemWB</span><span class="p">,</span><span class="w"> </span><span class="n">PC4_out_MemWB</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="n">ALU_out_MemWB</span><span class="p">,</span><span class="w"> </span><span class="n">Dmem_data_out_MemWB</span><span class="p">;</span>

<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">MemtoReg_out_MemWB</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//wire RegWrite_out_MemWB;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">WHBU_out_MemWB</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">LSwea_out_MemWB</span><span class="p">;</span>


<span class="w">    </span><span class="n">Mem_reg_WB</span><span class="w"> </span><span class="n">PPLMemWB</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">.</span><span class="n">clk_MemWB</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">rst_MemWB</span><span class="p">(</span><span class="n">rst</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">en_MemWB</span><span class="p">(</span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC_in_MemWB</span><span class="p">(</span><span class="n">PC_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Imm_in_MemWB</span><span class="p">(</span><span class="n">Imm_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC4_in_MemWB</span><span class="p">(</span><span class="n">PC4_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Rd_addr_MemWB</span><span class="p">(</span><span class="n">Rd_addr_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">ALU_in_MemWB</span><span class="p">(</span><span class="n">ALU_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Dmem_data_MemWB</span><span class="p">(</span><span class="n">Data_in</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">MemtoReg_in_MemWB</span><span class="p">(</span><span class="n">MemtoReg_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">RegWrite_in_MemWB</span><span class="p">(</span><span class="n">RegWrite_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">WHBU_in_MemWB</span><span class="p">(</span><span class="n">WHBU_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">LSwea_in_MemWB</span><span class="p">(</span><span class="n">LSwea_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC_out_MemWB</span><span class="p">(</span><span class="n">PC_out_MemWB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Imm_out_MemWB</span><span class="p">(</span><span class="n">Imm_out_MemWB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC4_out_MemWB</span><span class="p">(</span><span class="n">PC4_out_MemWB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Rd_addr_out_MemWB</span><span class="p">(</span><span class="n">Rd_addr_out_MemWB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">ALU_out_MemWB</span><span class="p">(</span><span class="n">ALU_out_MemWB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Dmem_data_out_MemWB</span><span class="p">(</span><span class="n">Dmem_data_out_MemWB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">MemtoReg_out_MemWB</span><span class="p">(</span><span class="n">MemtoReg_out_MemWB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">RegWrite_out_MemWB</span><span class="p">(</span><span class="n">RegWrite_out_MemWB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">WHBU_out_MemWB</span><span class="p">(</span><span class="n">WHBU_out_MemWB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">LSwea_out_MemWB</span><span class="p">(</span><span class="n">LSwea_out_MemWB</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="n">Pipeline_WB</span><span class="w"> </span><span class="n">PPLWB</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC4_in_WB</span><span class="p">(</span><span class="n">PC4_out_MemWB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">ALU_in_WB</span><span class="p">(</span><span class="n">ALU_out_MemWB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Dmem_data_WB</span><span class="p">(</span><span class="n">Dmem_data_out_MemWB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Imm_in_WB</span><span class="p">(</span><span class="n">Imm_out_MemWB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC_in_WB</span><span class="p">(</span><span class="n">PC_out_MemWB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">MemtoReg_in_WB</span><span class="p">(</span><span class="n">MemtoReg_out_MemWB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">WHBU_in_WB</span><span class="p">(</span><span class="n">WHBU_out_MemWB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">LSwea_in_WB</span><span class="p">(</span><span class="n">LSwea_out_MemWB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Data_out_WB</span><span class="p">(</span><span class="n">Data_out_WB</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">MemRW_EX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MemRW_out_IDEX</span><span class="p">;</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">MemRW_Mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MemRW_out_EXMem</span><span class="p">;</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Addr_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALU_out_EXMem</span><span class="p">;</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Data_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StoreData_out_EXMem</span><span class="p">;</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">wea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wea_out_EXMem</span><span class="p">;</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">PC_out_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PC_out_IFID</span><span class="p">;</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">inst_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst_out_IFID</span><span class="p">;</span>

<span class="k">endmodule</span>
</code></pre></div>
<p>实例化了 <span class="arithmatex">\(9\)</span> 个模块, <span class="arithmatex">\(5\)</span> 个阶段 + <span class="arithmatex">\(4\)</span> 个寄存器</p>
<ol>
<li><code>IF</code> 阶段代码:</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">Pipeline_IF</span><span class="p">(</span><span class="w"> </span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">clk_IF</span><span class="p">,</span><span class="w"> </span><span class="c1">//时钟</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">rst_IF</span><span class="p">,</span><span class="w"> </span><span class="c1">//复位</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">en_IF</span><span class="p">,</span><span class="w"> </span><span class="c1">//使能</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_in_IF</span><span class="p">,</span><span class="w"> </span><span class="c1">//取指令PC输入, = PCAddImm</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PCSrc</span><span class="p">,</span><span class="w"> </span><span class="c1">//PC输入选择</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ALU_in_IF</span><span class="p">,</span><span class="w"> </span><span class="c1">//ALU输出</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_out_IF</span><span class="w"> </span><span class="c1">//PC输出</span>
<span class="p">);</span><span class="w"> </span>

<span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_in</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PCAdd4</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">PCAdd4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PC_out_IF</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d4</span><span class="p">;</span>
<span class="k">always</span><span class="w"> </span><span class="p">@</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">PCSrc</span><span class="p">)</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="o">:</span><span class="w"> </span><span class="n">PC_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PCAdd4</span><span class="p">;</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b100</span><span class="o">:</span><span class="w"> </span><span class="n">PC_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PC_in_IF</span><span class="p">;</span><span class="w"> </span><span class="c1">// branch</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b001</span><span class="o">:</span><span class="w"> </span><span class="n">PC_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PC_in_IF</span><span class="p">;</span><span class="w"> </span><span class="c1">// jal</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b010</span><span class="o">:</span><span class="w"> </span><span class="n">PC_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALU_in_IF</span><span class="p">;</span><span class="w"> </span><span class="c1">// jalr</span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">PC_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">    </span><span class="k">endcase</span>
<span class="k">end</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">PC</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_IF</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_IF</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_IF</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">PC_in</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">PC_out_IF</span><span class="p">));</span>
<span class="k">endmodule</span>
</code></pre></div>
<p>输出写回数据</p>
<ol>
<li><code>ID</code> 阶段代码:</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">Pipeline_ID</span><span class="p">(</span><span class="w"> </span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">clk_ID</span><span class="p">,</span><span class="w"> </span><span class="c1">//时钟</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">rst_ID</span><span class="p">,</span><span class="w"> </span><span class="c1">//复位</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">RegWrite_in_ID</span><span class="p">,</span><span class="w"> </span><span class="c1">//寄存器堆使能</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Rd_addr_ID</span><span class="p">,</span><span class="w"> </span><span class="c1">//写目的地址输入</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Wt_data_ID</span><span class="p">,</span><span class="w"> </span><span class="c1">//写数据输出</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">inst_in_ID</span><span class="p">,</span><span class="w"> </span><span class="c1">//指令输入</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Rd_addr_out_ID</span><span class="p">,</span><span class="w"> </span><span class="c1">//写目的地址输出</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Rs1_out_ID</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="c1">//操作数1输出</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Rs2_out_ID</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="c1">//操作数2输出</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Imm_out_ID</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="c1">//立即数输出</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="n">ALUSrc_B_ID</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="c1">//ALU B端输入选择</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ALU_control_ID</span><span class="p">,</span><span class="w"> </span><span class="c1">//ALU控制</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Branch_ID</span><span class="p">,</span><span class="w"> </span><span class="c1">//Beq控制</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="n">MemRW_ID</span><span class="p">,</span><span class="w"> </span><span class="c1">//存储器读</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Jump_ID</span><span class="p">,</span><span class="w"> </span><span class="c1">//Jal控制</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">MemtoReg_ID</span><span class="p">,</span><span class="w"> </span><span class="c1">//寄存器写回</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="n">RegWrite_out_ID</span><span class="p">,</span><span class="w"> </span><span class="c1">//寄存器堆读写</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">WHBU_ID</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">LSwea_ID</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">StoreData_ID</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">wea_ID</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg00</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg01</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg02</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg03</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg04</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg05</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg06</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg07</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg08</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg09</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg10</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg11</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg12</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg13</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg14</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg15</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg16</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg17</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg18</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg19</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg20</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg21</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg22</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg23</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg24</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg25</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg26</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg27</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg28</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg29</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg30</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg31</span>
<span class="p">);</span><span class="w"> </span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">RS1</span><span class="p">,</span><span class="w"> </span><span class="n">RS2</span><span class="p">,</span><span class="w"> </span><span class="n">WT</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">OP</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">FUN3</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="n">FUN7</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">RS1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst_in_ID</span><span class="p">[</span><span class="mh">19</span><span class="o">:</span><span class="mh">15</span><span class="p">];</span>
<span class="k">assign</span><span class="w"> </span><span class="n">RS2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst_in_ID</span><span class="p">[</span><span class="mh">24</span><span class="o">:</span><span class="mh">20</span><span class="p">];</span>
<span class="k">assign</span><span class="w"> </span><span class="n">WT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst_in_ID</span><span class="p">[</span><span class="mh">11</span><span class="o">:</span><span class="mh">7</span><span class="p">];</span>
<span class="k">assign</span><span class="w"> </span><span class="n">OP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst_in_ID</span><span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">2</span><span class="p">];</span>
<span class="k">assign</span><span class="w"> </span><span class="n">FUN3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst_in_ID</span><span class="p">[</span><span class="mh">14</span><span class="o">:</span><span class="mh">12</span><span class="p">];</span>
<span class="k">assign</span><span class="w"> </span><span class="n">FUN7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst_in_ID</span><span class="p">[</span><span class="mh">30</span><span class="p">];</span>
<span class="k">assign</span><span class="w"> </span><span class="n">LSwea_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Imm_out_ID</span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ImmSel</span><span class="p">;</span>
<span class="n">ImmGen</span><span class="w"> </span><span class="n">immgen</span><span class="p">(.</span><span class="n">ImmSel</span><span class="p">(</span><span class="n">ImmSel</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">inst_field</span><span class="p">(</span><span class="n">inst_in_ID</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Imm_out</span><span class="p">(</span><span class="n">Imm_out_ID</span><span class="p">));</span>
<span class="n">SCPU_ctrls</span><span class="w"> </span><span class="n">Ctrl</span><span class="p">(.</span><span class="n">OPcode</span><span class="p">(</span><span class="n">OP</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Fun3</span><span class="p">(</span><span class="n">FUN3</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Fun7</span><span class="p">(</span><span class="n">FUN7</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="p">.</span><span class="n">ImmSel</span><span class="p">(</span><span class="n">ImmSel</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">ALUSrc_B</span><span class="p">(</span><span class="n">ALUSrc_B_ID</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">MemtoReg</span><span class="p">(</span><span class="n">MemtoReg_ID</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="p">.</span><span class="n">Jump</span><span class="p">(</span><span class="n">Jump_ID</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Branch</span><span class="p">(</span><span class="n">Branch_ID</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">RegWrite</span><span class="p">(</span><span class="n">RegWrite_out_ID</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">MemRW</span><span class="p">(</span><span class="n">MemRW_ID</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="p">.</span><span class="n">ALU_Control</span><span class="p">(</span><span class="n">ALU_control_ID</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">WHBU</span><span class="p">(</span><span class="n">WHBU_ID</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
<span class="n">Regs</span><span class="w"> </span><span class="n">regs</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_ID</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_ID</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Rs1_addr</span><span class="p">(</span><span class="n">RS1</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Rs2_addr</span><span class="p">(</span><span class="n">RS2</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="p">.</span><span class="n">Wt_addr</span><span class="p">(</span><span class="n">Rd_addr_ID</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Wt_data</span><span class="p">(</span><span class="n">Wt_data_ID</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">RegWrite</span><span class="p">(</span><span class="n">RegWrite_in_ID</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="p">.</span><span class="n">Rs1_data</span><span class="p">(</span><span class="n">Rs1_out_ID</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Rs2_data</span><span class="p">(</span><span class="n">Rs2_out_ID</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg00</span><span class="p">(</span><span class="n">Reg00</span><span class="p">),.</span><span class="n">Reg01</span><span class="p">(</span><span class="n">Reg01</span><span class="p">),.</span><span class="n">Reg02</span><span class="p">(</span><span class="n">Reg02</span><span class="p">),.</span><span class="n">Reg03</span><span class="p">(</span><span class="n">Reg03</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg04</span><span class="p">(</span><span class="n">Reg04</span><span class="p">),.</span><span class="n">Reg05</span><span class="p">(</span><span class="n">Reg05</span><span class="p">),.</span><span class="n">Reg06</span><span class="p">(</span><span class="n">Reg06</span><span class="p">),.</span><span class="n">Reg07</span><span class="p">(</span><span class="n">Reg07</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg08</span><span class="p">(</span><span class="n">Reg08</span><span class="p">),.</span><span class="n">Reg09</span><span class="p">(</span><span class="n">Reg09</span><span class="p">),.</span><span class="n">Reg10</span><span class="p">(</span><span class="n">Reg10</span><span class="p">),.</span><span class="n">Reg11</span><span class="p">(</span><span class="n">Reg11</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg12</span><span class="p">(</span><span class="n">Reg12</span><span class="p">),.</span><span class="n">Reg13</span><span class="p">(</span><span class="n">Reg13</span><span class="p">),.</span><span class="n">Reg14</span><span class="p">(</span><span class="n">Reg14</span><span class="p">),.</span><span class="n">Reg15</span><span class="p">(</span><span class="n">Reg15</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg16</span><span class="p">(</span><span class="n">Reg16</span><span class="p">),.</span><span class="n">Reg17</span><span class="p">(</span><span class="n">Reg17</span><span class="p">),.</span><span class="n">Reg18</span><span class="p">(</span><span class="n">Reg18</span><span class="p">),.</span><span class="n">Reg19</span><span class="p">(</span><span class="n">Reg19</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg20</span><span class="p">(</span><span class="n">Reg20</span><span class="p">),.</span><span class="n">Reg21</span><span class="p">(</span><span class="n">Reg21</span><span class="p">),.</span><span class="n">Reg22</span><span class="p">(</span><span class="n">Reg22</span><span class="p">),.</span><span class="n">Reg23</span><span class="p">(</span><span class="n">Reg23</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg24</span><span class="p">(</span><span class="n">Reg24</span><span class="p">),.</span><span class="n">Reg25</span><span class="p">(</span><span class="n">Reg25</span><span class="p">),.</span><span class="n">Reg26</span><span class="p">(</span><span class="n">Reg26</span><span class="p">),.</span><span class="n">Reg27</span><span class="p">(</span><span class="n">Reg27</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">Reg28</span><span class="p">(</span><span class="n">Reg28</span><span class="p">),.</span><span class="n">Reg29</span><span class="p">(</span><span class="n">Reg29</span><span class="p">),.</span><span class="n">Reg30</span><span class="p">(</span><span class="n">Reg30</span><span class="p">),.</span><span class="n">Reg31</span><span class="p">(</span><span class="n">Reg31</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
<span class="k">assign</span><span class="w"> </span><span class="n">Rd_addr_out_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst_in_ID</span><span class="p">[</span><span class="mh">11</span><span class="o">:</span><span class="mh">7</span><span class="p">];</span>

<span class="k">always</span><span class="w"> </span><span class="p">@</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">LSwea_ID</span><span class="p">)</span>
<span class="w">        </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="n">StoreData_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Rs2_out_ID</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">WHBU_ID</span><span class="p">)</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="o">:</span><span class="w"> </span><span class="n">wea_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0001</span><span class="p">;</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0100</span><span class="o">:</span><span class="w"> </span><span class="n">wea_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0011</span><span class="p">;</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b1000</span><span class="o">:</span><span class="w"> </span><span class="n">wea_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b1111</span><span class="p">;</span>
<span class="w">                </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">wea_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">endcase</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="mh">2</span><span class="mb">&#39;b01</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="n">StoreData_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">Rs2_out_ID</span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">0</span><span class="p">],</span><span class="w"> </span><span class="mh">8</span><span class="mb">&#39;b0</span><span class="p">};</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">WHBU_ID</span><span class="p">)</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="o">:</span><span class="w"> </span><span class="n">wea_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="p">;</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0100</span><span class="o">:</span><span class="w"> </span><span class="n">wea_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0110</span><span class="p">;</span>
<span class="w">                </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">wea_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">endcase</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="mh">2</span><span class="mb">&#39;b10</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="n">StoreData_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">Rs2_out_ID</span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">],</span><span class="w"> </span><span class="mh">16</span><span class="mb">&#39;b0</span><span class="p">};</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">WHBU_ID</span><span class="p">)</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="o">:</span><span class="w"> </span><span class="n">wea_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0100</span><span class="p">;</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0100</span><span class="o">:</span><span class="w"> </span><span class="n">wea_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b1100</span><span class="p">;</span>
<span class="w">                </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">wea_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">endcase</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="mh">2</span><span class="mb">&#39;b11</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="n">StoreData_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">Rs2_out_ID</span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">0</span><span class="p">],</span><span class="w"> </span><span class="mh">24</span><span class="mb">&#39;b0</span><span class="p">};</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">WHBU_ID</span><span class="p">)</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="o">:</span><span class="w"> </span><span class="n">wea_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b1000</span><span class="p">;</span>
<span class="w">                </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">wea_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">endcase</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">    </span><span class="k">endcase</span>
<span class="k">end</span><span class="w">    </span>
<span class="k">endmodule</span>
</code></pre></div>
<p>实例化了寄存器, 立即数生成器和 Ctrl Unit</p>
<ol>
<li><code>EX</code> 阶段代码:</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">Pipeline_Ex</span><span class="p">(</span><span class="w"> </span>
<span class="w">    </span><span class="k">input</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_in_EX</span><span class="p">,</span><span class="w"> </span><span class="c1">//PC输入</span>
<span class="w">    </span><span class="k">input</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Rs1_in_EX</span><span class="p">,</span><span class="w"> </span><span class="c1">//操作1输入</span>
<span class="w">    </span><span class="k">input</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Rs2_in_EX</span><span class="p">,</span><span class="w"> </span><span class="c1">//操作2输入</span>
<span class="w">    </span><span class="k">input</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Imm_in_EX</span><span class="p">,</span><span class="w"> </span><span class="c1">//立即数</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">ALUSrc_B_in_EX</span><span class="p">,</span><span class="w"> </span><span class="c1">//ALU B选择</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ALU_control_in_EX</span><span class="p">,</span><span class="w"> </span><span class="c1">//ALU选择控制</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_out_EX</span><span class="p">,</span><span class="w"> </span><span class="c1">//PC输出, PCAddImm</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC4_out_EX</span><span class="p">,</span><span class="w"> </span><span class="c1">//PC+4输出</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="n">zero_out_EX</span><span class="p">,</span><span class="w"> </span><span class="c1">//ALU0输出</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ALU_out_EX</span><span class="p">,</span><span class="w"> </span><span class="c1">//ALU计算输出</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Rs2_out_EX</span><span class="w"> </span><span class="c1">//操作2输出</span>
<span class="p">);</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ALUB</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">PC_out_EX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PC_in_EX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Imm_in_EX</span><span class="p">;</span><span class="w"> </span><span class="c1">// PC_out = PC + Imm</span>
<span class="k">assign</span><span class="w"> </span><span class="n">PC4_out_EX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PC_in_EX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d4</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">Rs2_out_EX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Rs2_in_EX</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">ALUB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ALUSrc_B_in_EX</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">Imm_in_EX</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Rs2_in_EX</span><span class="p">;</span>
<span class="n">ALU</span><span class="w"> </span><span class="n">alu</span><span class="p">(.</span><span class="n">A</span><span class="p">(</span><span class="n">Rs1_in_EX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">B</span><span class="p">(</span><span class="n">ALUB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">ALU_operation</span><span class="p">(</span><span class="n">ALU_control_in_EX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">res</span><span class="p">(</span><span class="n">ALU_out_EX</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="p">.</span><span class="n">zero</span><span class="p">(</span><span class="n">zero_out_EX</span><span class="p">));</span>

<span class="k">endmodule</span>
</code></pre></div>
<p>实例化了 ALU</p>
<ol>
<li><code>MEM</code> 阶段代码:</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">Pipeline_Mem</span><span class="p">(</span><span class="w"> </span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">zero_in_Mem</span><span class="p">,</span><span class="w"> </span><span class="c1">//zero</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">res_in_Mem</span><span class="p">,</span><span class="w"> </span><span class="c1">// ALU res</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Branch_in_Mem</span><span class="p">,</span><span class="w"> </span><span class="c1">//beq</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Jump_in_Mem</span><span class="p">,</span><span class="w"> </span><span class="c1">//jal</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PCSrc</span><span class="w"> </span><span class="c1">//PC选择控制输出</span>
<span class="p">);</span>
<span class="kt">wire</span><span class="w"> </span><span class="n">Branch_one</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">Branch_one</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Branch_in_Mem</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="kt">reg</span><span class="w"> </span><span class="n">branch</span><span class="p">;</span>
<span class="k">always</span><span class="w"> </span><span class="p">@</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w">  </span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">Branch_in_Mem</span><span class="p">)</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b001</span><span class="o">:</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Branch_one</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">zero_in_Mem</span><span class="p">);</span><span class="w"> </span><span class="c1">// BEQ</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b010</span><span class="o">:</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Branch_one</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">~</span><span class="n">zero_in_Mem</span><span class="p">);</span><span class="w"> </span><span class="c1">// BNE</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b011</span><span class="o">:</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Branch_one</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">res_in_Mem</span><span class="p">[</span><span class="mh">0</span><span class="p">]);</span><span class="w"> </span><span class="c1">// BLT</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b100</span><span class="o">:</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Branch_one</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">~</span><span class="n">res_in_Mem</span><span class="p">[</span><span class="mh">0</span><span class="p">]);</span><span class="w"> </span><span class="c1">// BGE</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b101</span><span class="o">:</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Branch_one</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">res_in_Mem</span><span class="p">[</span><span class="mh">0</span><span class="p">]);</span><span class="w"> </span><span class="c1">// BLTU</span>
<span class="w">        </span><span class="mh">3</span><span class="mb">&#39;b110</span><span class="o">:</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Branch_one</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">~</span><span class="n">res_in_Mem</span><span class="p">[</span><span class="mh">0</span><span class="p">]);</span><span class="w"> </span><span class="c1">// BGEU </span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">branch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">    </span><span class="k">endcase</span>
<span class="k">end</span>

<span class="k">assign</span><span class="w"> </span><span class="n">PCSrc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">branch</span><span class="p">,</span><span class="w"> </span><span class="n">Jump_in_Mem</span><span class="p">};</span><span class="w"> </span>
<span class="k">endmodule</span>
</code></pre></div>
<p>产生 <code>PCSrc</code> 并与 RAM 交互</p>
<ol>
<li><code>WB</code> 阶段代码:</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">Pipeline_WB</span><span class="p">(</span><span class="w"> </span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC4_in_WB</span><span class="p">,</span><span class="w"> </span><span class="c1">//PC+4输入</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ALU_in_WB</span><span class="p">,</span><span class="w"> </span><span class="c1">//ALU结果输出</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Dmem_data_WB</span><span class="p">,</span><span class="w"> </span><span class="c1">//存储器数据输出</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Imm_in_WB</span><span class="p">,</span><span class="w"> </span><span class="c1">//立即数输出</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_in_WB</span><span class="p">,</span><span class="w"> </span><span class="c1">//PC+立即数输出</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">WHBU_in_WB</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">LSwea_in_WB</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">MemtoReg_in_WB</span><span class="p">,</span><span class="w"> </span><span class="c1">//写回选择控制</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Data_out_WB</span><span class="w"> </span><span class="c1">//写回数据输出</span>
<span class="p">);</span>
<span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="p">;</span>
<span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">LoadData</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">Data_in</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">Data_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Dmem_data_WB</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">Data_out_WB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="p">;</span>
<span class="k">always</span><span class="w"> </span><span class="p">@</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">MemtoReg_in_WB</span><span class="p">)</span>
<span class="w">        </span><span class="mh">3</span><span class="mi">&#39;d0</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALU_in_WB</span><span class="p">;</span><span class="w"> </span><span class="c1">// ALU</span>
<span class="w">        </span><span class="mh">3</span><span class="mi">&#39;d1</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">WHBU_in_WB</span><span class="p">)</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="mh">24</span><span class="p">{</span><span class="n">LoadData</span><span class="p">[</span><span class="mh">7</span><span class="p">]}},</span><span class="w"> </span><span class="n">LoadData</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]};</span><span class="w"> </span><span class="c1">// LB</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0100</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="mh">16</span><span class="p">{</span><span class="n">LoadData</span><span class="p">[</span><span class="mh">15</span><span class="p">]}},</span><span class="w"> </span><span class="n">LoadData</span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]};</span><span class="w"> </span><span class="c1">// LH</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b1000</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LoadData</span><span class="p">;</span><span class="w"> </span><span class="c1">// LW</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0011</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">24</span><span class="mb">&#39;b0</span><span class="p">,</span><span class="w"> </span><span class="n">LoadData</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]};</span><span class="w"> </span><span class="c1">// LBU</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0101</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">16</span><span class="mb">&#39;b0</span><span class="p">,</span><span class="w"> </span><span class="n">LoadData</span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]};</span><span class="w"> </span><span class="c1">// LHU</span>
<span class="w">                </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">endcase</span><span class="w"> </span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="mh">3</span><span class="mi">&#39;d2</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PC4_in_WB</span><span class="p">;</span><span class="w"> </span><span class="c1">// JAL</span>
<span class="w">        </span><span class="mh">3</span><span class="mi">&#39;d3</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Imm_in_WB</span><span class="p">;</span><span class="w"> </span><span class="c1">// lui</span>
<span class="w">        </span><span class="mh">3</span><span class="mi">&#39;d4</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PC_in_WB</span><span class="p">;</span><span class="w"> </span><span class="c1">// auipc</span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">reg_wt_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">    </span><span class="k">endcase</span><span class="w">      </span>
<span class="k">end</span>
<span class="k">always</span><span class="w"> </span><span class="p">@</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">LSwea_in_WB</span><span class="p">)</span>
<span class="w">        </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="o">:</span><span class="w"> </span><span class="n">LoadData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Data_in</span><span class="p">;</span>
<span class="w">        </span><span class="mh">2</span><span class="mb">&#39;b01</span><span class="o">:</span><span class="w"> </span><span class="n">LoadData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">8</span><span class="mb">&#39;b0</span><span class="p">,</span><span class="w"> </span><span class="n">Data_in</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">8</span><span class="p">]};</span>
<span class="w">        </span><span class="mh">2</span><span class="mb">&#39;b10</span><span class="o">:</span><span class="w"> </span><span class="n">LoadData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">16</span><span class="mb">&#39;b0</span><span class="p">,</span><span class="w"> </span><span class="n">Data_in</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">16</span><span class="p">]};</span>
<span class="w">        </span><span class="mh">2</span><span class="mb">&#39;b11</span><span class="o">:</span><span class="w"> </span><span class="n">LoadData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">24</span><span class="mb">&#39;b0</span><span class="p">,</span><span class="w"> </span><span class="n">Data_in</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">24</span><span class="p">]};</span>
<span class="w">    </span><span class="k">endcase</span>
<span class="k">end</span>

<span class="k">endmodule</span>
</code></pre></div>
<p>产生写回数据</p>
<ol>
<li><code>IFID</code> 寄存器代码:</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">IF_reg_ID</span><span class="p">(</span><span class="w"> </span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">clk_IFID</span><span class="p">,</span><span class="w"> </span><span class="c1">//寄存器时钟</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">rst_IFID</span><span class="p">,</span><span class="w"> </span><span class="c1">//寄存器复位</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">en_IFID</span><span class="p">,</span><span class="w"> </span><span class="c1">//寄存器使能</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_in_IFID</span><span class="p">,</span><span class="w"> </span><span class="c1">//PC输入</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">inst_in_IFID</span><span class="p">,</span><span class="w"> </span><span class="c1">//指令输入</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_out_IFID</span><span class="p">,</span><span class="w"> </span><span class="c1">//PC输出</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">inst_out_IFID</span><span class="w"> </span><span class="c1">//指令输出</span>
<span class="p">);</span><span class="w"> </span>

<span class="n">Reg</span><span class="w"> </span><span class="n">PC</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_IFID</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_IFID</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_IFID</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">PC_in_IFID</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">PC_out_IFID</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">inst</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_IFID</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_IFID</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_IFID</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">inst_in_IFID</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">inst_out_IFID</span><span class="p">));</span>
<span class="k">endmodule</span>
</code></pre></div>
<p>传输指令</p>
<ol>
<li><code>IDEX</code> 寄存器代码:</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">ID_reg_Ex</span><span class="p">(</span><span class="w"> </span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">clk_IDEX</span><span class="p">,</span><span class="w"> </span><span class="c1">//寄存器时</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">rst_IDEX</span><span class="p">,</span><span class="w"> </span><span class="c1">//寄存器复</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">en_IDEX</span><span class="p">,</span><span class="w"> </span><span class="c1">//寄存器使</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_in_IDEX</span><span class="p">,</span><span class="w"> </span><span class="c1">//PC输入</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Rd_addr_IDEX</span><span class="p">,</span><span class="w"> </span><span class="c1">//写目的输入</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Rs1_in_IDEX</span><span class="p">,</span><span class="w"> </span><span class="c1">//操作1输入</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Rs2_in_IDEX</span><span class="p">,</span><span class="w"> </span><span class="c1">//操作2输入</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Imm_in_IDEX</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="c1">//立即数输出</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">ALUSrc_B_in_IDEX</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="c1">//ALU B输入选择</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ALU_control_in_IDEX</span><span class="p">,</span><span class="w"> </span><span class="c1">//ALU选择控制</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Branch_in_IDEX</span><span class="p">,</span><span class="w"> </span><span class="c1">//Beq</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">MemRW_in_IDEX</span><span class="p">,</span><span class="w"> </span><span class="c1">//存储器读</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Jump_in_IDEX</span><span class="p">,</span><span class="w"> </span><span class="c1">//Jal</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">MemtoReg_in_IDEX</span><span class="p">,</span><span class="w"> </span><span class="c1">//写回选择</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">RegWrite_in_IDEX</span><span class="p">,</span><span class="w"> </span><span class="c1">//寄存器堆读写</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">WHBU_in_IDEX</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">LSwea_in_IDEX</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">StoreData_in_IDEX</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">wea_in_IDEX</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_out_IDEX</span><span class="p">,</span><span class="w"> </span><span class="c1">//PC输出</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Rd_addr_out_IDEX</span><span class="p">,</span><span class="w"> </span><span class="c1">//目的地址输出</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Rs1_out_IDEX</span><span class="p">,</span><span class="w"> </span><span class="c1">//操作1输出</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Rs2_out_IDEX</span><span class="p">,</span><span class="w"> </span><span class="c1">//操作2输出</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Imm_out_IDEX</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="c1">//立即数</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="n">ALUSrc_B_out_IDEX</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="c1">//ALU B选择</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ALU_control_out_IDEX</span><span class="p">,</span><span class="w"> </span><span class="c1">//ALU控制</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Branch_out_IDEX</span><span class="p">,</span><span class="w"> </span><span class="c1">//Beq</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="n">MemRW_out_IDEX</span><span class="p">,</span><span class="w"> </span><span class="c1">//存储器</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Jump_out_IDEX</span><span class="p">,</span><span class="w"> </span><span class="c1">//Jal</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">MemtoReg_out_IDEX</span><span class="p">,</span><span class="w"> </span><span class="c1">//写回</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="n">RegWrite_out_IDEX</span><span class="p">,</span><span class="w"> </span><span class="c1">//寄存器堆读写</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">WHBU_out_IDEX</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">LSwea_out_IDEX</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">StoreData_out_IDEX</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">wea_out_IDEX</span>
<span class="p">);</span><span class="w"> </span>

<span class="n">Reg</span><span class="w"> </span><span class="n">PC</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">PC_in_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">PC_out_IDEX</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">Rd_addr</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">Rd_addr_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">Rd_addr_out_IDEX</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">Rs1</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">Rs1_in_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">Rs1_out_IDEX</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">Rs2</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">Rs2_in_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">Rs2_out_IDEX</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">Imm</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">Imm_in_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">Imm_out_IDEX</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">ALUSrc_B</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">ALUSrc_B_in_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">ALUSrc_B_out_IDEX</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">ALU_control</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">ALU_control_in_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">ALU_control_out_IDEX</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">Branch</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">Branch_in_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">Branch_out_IDEX</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">MemRW</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">MemRW_in_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">MemRW_out_IDEX</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">Jump</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">Jump_in_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">Jump_out_IDEX</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">MemtoReg</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">MemtoReg_in_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">MemtoReg_out_IDEX</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">RegWrite</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">RegWrite_in_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">RegWrite_out_IDEX</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">WHBU</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">WHBU_in_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">WHBU_out_IDEX</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">LSwea</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">LSwea_in_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">LSwea_out_IDEX</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">StoreData</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">StoreData_in_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">StoreData_out_IDEX</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">wea</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">wea_in_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">wea_out_IDEX</span><span class="p">));</span>

<span class="k">endmodule</span>
</code></pre></div>
<p>传输控制信号</p>
<ol>
<li><code>EXMEM</code> 寄存器代码:</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">Ex_reg_Mem</span><span class="p">(</span><span class="w"> </span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">clk_EXMem</span><span class="p">,</span><span class="w"> </span><span class="c1">//寄存器时</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">rst_EXMem</span><span class="p">,</span><span class="w"> </span><span class="c1">//寄存器复</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">en_EXMem</span><span class="p">,</span><span class="w"> </span><span class="c1">//寄存器使</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_in_EXMem</span><span class="p">,</span><span class="w"> </span><span class="c1">//PC输入</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Imm_in_EXMem</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC4_in_EXMem</span><span class="p">,</span><span class="w"> </span><span class="c1">//PC+4输入</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Rd_addr_EXMem</span><span class="p">,</span><span class="w"> </span><span class="c1">//写目的寄存器地址输入</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">zero_in_EXMem</span><span class="p">,</span><span class="w"> </span><span class="c1">//zero</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ALU_in_EXMem</span><span class="p">,</span><span class="w"> </span><span class="c1">//ALU输入</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Rs2_in_EXMem</span><span class="p">,</span><span class="w"> </span><span class="c1">//操作2输入</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Branch_in_EXMem</span><span class="p">,</span><span class="w"> </span><span class="c1">//Beq</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">MemRW_in_EXMem</span><span class="p">,</span><span class="w"> </span><span class="c1">//存储器读</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Jump_in_EXMem</span><span class="p">,</span><span class="w"> </span><span class="c1">//Jal</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">MemtoReg_in_EXMem</span><span class="p">,</span><span class="w"> </span><span class="c1">//写回</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">RegWrite_in_EXMem</span><span class="p">,</span><span class="w"> </span><span class="c1">//寄存器堆读写</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">WHBU_in_EXMem</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">LSwea_in_EXMem</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">StoreData_in_EXMem</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">wea_in_EXMem</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_out_EXMem</span><span class="p">,</span><span class="w"> </span><span class="c1">//PC输出</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Imm_out_EXMem</span><span class="p">,</span><span class="w"> </span><span class="c1">//立即数输</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC4_out_EXMem</span><span class="p">,</span><span class="w"> </span><span class="c1">//PC+4输出</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Rd_addr_out_EXMem</span><span class="p">,</span><span class="w"> </span><span class="c1">//写目的寄存器输出</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="n">zero_out_EXMem</span><span class="p">,</span><span class="w"> </span><span class="c1">//zero</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ALU_out_EXMem</span><span class="p">,</span><span class="w"> </span><span class="c1">//ALU输出</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Rs2_out_EXMem</span><span class="p">,</span><span class="w"> </span><span class="c1">//操作2输出</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Branch_out_EXMem</span><span class="p">,</span><span class="w"> </span><span class="c1">//Beq</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="n">MemRW_out_EXMem</span><span class="p">,</span><span class="w"> </span><span class="c1">//存储器读</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Jump_out_EXMem</span><span class="p">,</span><span class="w"> </span><span class="c1">//Jal</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">MemtoReg_out_EXMem</span><span class="p">,</span><span class="w"> </span><span class="c1">//写回</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="n">RegWrite_out_EXMem</span><span class="p">,</span><span class="w"> </span><span class="c1">//寄存器堆读写</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">WHBU_out_EXMem</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">LSwea_out_EXMem</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">StoreData_out_EXMem</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">wea_out_EXMem</span>
<span class="p">);</span><span class="w"> </span>

<span class="n">Reg</span><span class="w"> </span><span class="n">PC</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">PC_in_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">PC_out_EXMem</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">Imm</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">Imm_in_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">Imm_out_EXMem</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">PC4</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">PC4_in_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">PC4_out_EXMem</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">Rd_addr</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">Rd_addr_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">Rd_addr_out_EXMem</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">zero</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">zero_in_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">zero_out_EXMem</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">ALU</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">ALU_in_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">ALU_out_EXMem</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">Rs2</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">Rs2_in_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">Rs2_out_EXMem</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">Branch</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">Branch_in_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">Branch_out_EXMem</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">MemRW</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">MemRW_in_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">MemRW_out_EXMem</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">Jump</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">Jump_in_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">Jump_out_EXMem</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">MemtoReg</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">MemtoReg_in_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">MemtoReg_out_EXMem</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">RegWrite</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">RegWrite_in_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">RegWrite_out_EXMem</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">WHBU</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">WHBU_in_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">WHBU_out_EXMem</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">LSwea</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">LSwea_in_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">LSwea_out_EXMem</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">StoreData</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">StoreData_in_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">StoreData_out_EXMem</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">wea</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">wea_in_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">wea_out_EXMem</span><span class="p">));</span>

<span class="k">endmodule</span>
</code></pre></div>
<p>传输计算值</p>
<ol>
<li><code>MEMWB</code> 寄存器代码:</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">Mem_reg_WB</span><span class="p">(</span><span class="w"> </span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">clk_MemWB</span><span class="p">,</span><span class="w"> </span><span class="c1">//寄存器时</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">rst_MemWB</span><span class="p">,</span><span class="w"> </span><span class="c1">//寄存器复</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">en_MemWB</span><span class="p">,</span><span class="w"> </span><span class="c1">//寄存器使</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_in_MemWB</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Imm_in_MemWB</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC4_in_MemWB</span><span class="p">,</span><span class="w"> </span><span class="c1">//PC+4输入</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Rd_addr_MemWB</span><span class="p">,</span><span class="w"> </span><span class="c1">//写目的输入</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ALU_in_MemWB</span><span class="p">,</span><span class="w"> </span><span class="c1">//ALU输入</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Dmem_data_MemWB</span><span class="p">,</span><span class="w"> </span><span class="c1">//存储器数据</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">MemtoReg_in_MemWB</span><span class="p">,</span><span class="w"> </span><span class="c1">//写回</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">RegWrite_in_MemWB</span><span class="p">,</span><span class="w"> </span><span class="c1">//寄存器堆读写</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">WHBU_in_MemWB</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">LSwea_in_MemWB</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_out_MemWB</span><span class="p">,</span><span class="w"> </span><span class="c1">//PC输出</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Imm_out_MemWB</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC4_out_MemWB</span><span class="p">,</span><span class="w"> </span><span class="c1">//PC+4输出</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Rd_addr_out_MemWB</span><span class="p">,</span><span class="w"> </span><span class="c1">//写目的输出</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ALU_out_MemWB</span><span class="p">,</span><span class="w"> </span><span class="c1">//ALU输出</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Dmem_data_out_MemWB</span><span class="p">,</span><span class="w"> </span><span class="c1">//存储器数据</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">MemtoReg_out_MemWB</span><span class="p">,</span><span class="w"> </span><span class="c1">//写回</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="n">RegWrite_out_MemWB</span><span class="p">,</span><span class="w"> </span><span class="c1">//寄存器堆读写</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">WHBU_out_MemWB</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">LSwea_out_MemWB</span>
<span class="p">);</span>

<span class="n">Reg</span><span class="w"> </span><span class="n">PC</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">PC_in_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">PC_out_MemWB</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">Imm</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">Imm_in_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">Imm_out_MemWB</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">PC4</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">PC4_in_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">PC4_out_MemWB</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">Rd_addr</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">Rd_addr_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">Rd_addr_out_MemWB</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">ALU</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">ALU_in_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">ALU_out_MemWB</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">Dmem_data</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">Dmem_data_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">Dmem_data_out_MemWB</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">MemtoReg</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">MemtoReg_in_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">MemtoReg_out_MemWB</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">RegWrite</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">RegWrite_in_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">RegWrite_out_MemWB</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">WHBU</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">WHBU_in_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">WHBU_out_MemWB</span><span class="p">));</span>
<span class="n">Reg</span><span class="w"> </span><span class="n">LSwea</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">CE</span><span class="p">(</span><span class="n">en_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">D</span><span class="p">(</span><span class="n">LSwea_in_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">Q</span><span class="p">(</span><span class="n">LSwea_out_MemWB</span><span class="p">));</span>
<span class="k">endmodule</span>
</code></pre></div>
<h3 id="_26">仿真关键步骤说明</h3>
<ol>
<li>仿真汇编:</li>
</ol>
<p>仿真代码为将 Lab4-3 仿真代码每句指令中间插入 <span class="arithmatex">\(3\)</span> 个 <code>nop</code> 指令得来</p>
<p>最终运行结果为 <code>x31</code> 寄存器值 <code>666</code></p>
<ol>
<li>testbench 模块: </li>
</ol>
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">testbench</span><span class="p">(</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="n">clk</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="n">rst</span>
<span class="p">);</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Addr_out</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Data_out</span><span class="p">;</span><span class="w">       </span>
<span class="w">    </span><span class="kt">wire</span><span class="w">        </span><span class="n">CPU_MIO</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w">        </span><span class="n">MemRW_Mem</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">memrw</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">MEMRW</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_out_IF</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">douta</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">spo</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">wea</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">memrw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">MemRW_Mem</span><span class="p">,</span><span class="w"> </span><span class="n">MemRW_Mem</span><span class="p">,</span><span class="w"> </span><span class="n">MemRW_Mem</span><span class="p">,</span><span class="w"> </span><span class="n">MemRW_Mem</span><span class="p">};</span>
<span class="k">assign</span><span class="w"> </span><span class="n">MEMRW</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memrw</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">wea</span><span class="p">;</span>
<span class="n">Pipeline_CPU</span><span class="w"> </span><span class="n">u0</span><span class="p">(</span>
<span class="w">         </span><span class="p">.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">         </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst</span><span class="p">),</span>
<span class="w">         </span><span class="p">.</span><span class="n">Data_in</span><span class="p">(</span><span class="n">douta</span><span class="p">),</span>
<span class="w">         </span><span class="p">.</span><span class="n">inst_IF</span><span class="p">(</span><span class="n">spo</span><span class="p">),</span><span class="w"> </span>
<span class="w">         </span><span class="p">.</span><span class="n">Addr_out</span><span class="p">(</span><span class="n">Addr_out</span><span class="p">),</span>
<span class="w">         </span><span class="p">.</span><span class="n">Data_out</span><span class="p">(</span><span class="n">Data_out</span><span class="p">),</span><span class="w"> </span>
<span class="w">         </span><span class="p">.</span><span class="n">PC_out_IF</span><span class="p">(</span><span class="n">PC_out_IF</span><span class="p">),</span><span class="w"> </span>
<span class="w">         </span><span class="p">.</span><span class="n">MemRW_Mem</span><span class="p">(</span><span class="n">MemRW_Mem</span><span class="p">),</span>
<span class="w">         </span><span class="p">.</span><span class="n">wea</span><span class="p">(</span><span class="n">wea</span><span class="p">)</span><span class="w">  </span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="n">RAM_B</span><span class="w"> </span><span class="n">u1</span><span class="p">(</span>
<span class="w">        </span><span class="p">.</span><span class="n">clka</span><span class="p">(</span><span class="o">~</span><span class="n">clk</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">wea</span><span class="p">(</span><span class="n">MEMRW</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">addra</span><span class="p">(</span><span class="n">Addr_out</span><span class="p">[</span><span class="mh">11</span><span class="o">:</span><span class="mh">2</span><span class="p">]),</span>
<span class="w">        </span><span class="p">.</span><span class="n">dina</span><span class="p">(</span><span class="n">Data_out</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">douta</span><span class="p">(</span><span class="n">douta</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="n">ROM_D</span><span class="w"> </span><span class="n">u2</span><span class="p">(</span>
<span class="w">        </span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">PC_out_IF</span><span class="p">[</span><span class="mh">11</span><span class="o">:</span><span class="mh">2</span><span class="p">]),</span>
<span class="w">        </span><span class="p">.</span><span class="n">spo</span><span class="p">(</span><span class="n">spo</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>

<span class="k">endmodule</span>
</code></pre></div>
<p>实例化了流水线 CPU, RAM, ROM 模块, 并进行了连线</p>
<ol>
<li>仿真代码:</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">sim</span><span class="p">();</span>
<span class="w">    </span><span class="kt">reg</span><span class="w"> </span><span class="n">clk</span><span class="p">;</span>
<span class="w">    </span><span class="kt">reg</span><span class="w"> </span><span class="n">rst</span><span class="p">;</span>
<span class="w">    </span><span class="n">testbench</span><span class="w"> </span><span class="n">m0</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst</span><span class="p">));</span>
<span class="w">    </span><span class="k">initial</span><span class="w"> </span><span class="k">begin</span>
<span class="w">        </span><span class="n">clk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">        </span><span class="n">rst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">        </span><span class="p">#</span><span class="mh">50</span><span class="p">;</span>
<span class="w">        </span><span class="n">rst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">always</span><span class="w"> </span><span class="p">#</span><span class="mh">10</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">clk</span><span class="p">;</span>
<span class="k">endmodule</span>
</code></pre></div>
<p>在仿真顶层代码中, 实例化一个 testbench 模块并将时钟，复位信号传入模块</p>
<h2 id="_27">实验结果与分析</h2>
<h3 id="_28">仿真结果</h3>
<p><img alt="alt text" src="../../images/PCPU/image.png" /></p>
<ol>
<li>
<p>初始时所有寄存器值为 <code>0</code></p>
<p>然后流水线 CPU 正常运行, 与 Lab 4-3 中的中间运行结果保持一致</p>
</li>
</ol>
<p><img alt="alt text" src="../../images/PCPU/image-1.png" /></p>
<ol>
<li>最后寄存器 <code>x31 = 666</code>, 说明仿真成功</li>
</ol>
<h3 id="_29">下板结果</h3>
<h1 id="lab-5-2">Lab 5-2</h1>
<h2 id="_30">操作方法与实验步骤</h2>
<h3 id="_31">代码设计及说明</h3>
<h4 id="stall">Stall</h4>
<p>在流水线 CPU 产生冲突时, 可以通过暂停 <code>IF, ID</code> 阶段, 向 <code>EX</code> 阶段插入 <code>nop</code> 指令来实现 stall. </p>
<p>对于 Data Hazard, 如果 当 <code>EX, MEM, WB</code> 阶段的 <code>rd</code> 与 <code>ID</code> 阶段的 <code>rs</code> 相同时, 说明产生冲突, 就需要 stall 一个周期</p>
<p>对于 Control Hazard, 如果 <code>EX, MEM</code> 阶段的 <code>Branch, Jump</code> 信号为 <span class="arithmatex">\(1\)</span>, 那么说明是跳转指令, 就需要 stall 一个周期</p>
<h4 id="structural-hazard">Structural Hazard</h4>
<p>在寄存器读写时, 如果在上升沿进行写操作, 那么在写入的那一周期无法同时将写入的值读出, 导致需要多 stall 一个周期</p>
<p>因此, 可以改为在时钟下降沿写, 于是可以提前半个周期把值写入, 就可以在下一个整周期读出写入的值, 因此可以只 stall 两个周期解决 data hazard</p>
<h4 id="data-hazard">Data Hazard</h4>
<p>在处理数据冲突时, 我采用了 Forwarding 的处理方式</p>
<p>当 <code>MEM, WB</code> 阶段的 <code>rd</code> 与 <code>ID</code> 阶段的 <code>rs</code> 相同时, 说明产生冲突, 那么就可以将 <code>rd</code> 的值旁路传回 <code>EX</code> 阶段, 并控制 <code>ALU</code> 直接选择 <code>rs</code> 为 Forwarding 后的值</p>
<p>同时, 为了处理 Load-Use 情况, 需要 stall 控制模块在 <code>EX</code> 阶段进行一次 stall, 之后再进行 Forwarding 即可</p>
<p>同时, 处理 Use-Store 情况, 需要将 <code>StoreData</code> 的产生从 <code>ID</code> 阶段挪到 <code>EX</code> 阶段, 然后选择 Forwarding 后的数据作为 <code>StoreData</code> 即可</p>
<p>最后是 Lui-Use 情况, 由于在我实现的 <code>lui</code> 指令, 产生的立即数 <code>ImmOut</code> 不经过 ALU, 在传到 <code>WB</code> 阶段时才能够写回</p>
<p>所以为了将 <code>WB</code> 阶段的 <code>lui</code> 的立即数旁路传回 <code>EX</code> 阶段, 需要将 <code>lui</code> 指令在 <code>EX</code> 阶段多 stall 一个周期, 这样就可以将 <code>WB</code> 阶段的立即数值传回 <code>EX</code> 阶段, 完成Forwarding</p>
<h4 id="forwarding">Forwarding</h4>
<p>控制产生 Forwarding 信号</p>
<p>如果 <code>MEM</code> 阶段的 <code>rd</code> 与 <code>ID</code> 阶段的 <code>rs</code> 相同时, 那么控制产生 <code>Forward = 01</code></p>
<p>如果 <code>WB</code> 阶段的 <code>rd</code> 与 <code>ID</code> 阶段的 <code>rs</code> 相同时, 那么控制产生 <code>Forward = 10</code></p>
<h4 id="control-hazard">Control Hazard</h4>
<p>在处理控制冲突时, 我只采用了 stall 的方式, 不过写完才发现是和 Branch Always Not Taken 结合后的奇妙版本</p>
<p>当跳转指令处于 <code>EX</code> 阶段时, 直接 stall 一个周期; 当指令处于 <code>MEM</code> 阶段时, 由于 <code>PCSrc</code> 也在此阶段产生, 所以我判断了 <code>PCSrc</code> 的值来决定是否 flush 掉 <code>IF, ID</code> 阶段寄存器的值</p>
<p>如果 taken, 那么 flush 掉 <code>IF, ID</code> 阶段, 相当于 stall 了 <span class="arithmatex">\(3\)</span> 个周期; 如果 not taken, 则流水线继续运行, 相当于只在 <code>EX</code> 阶段 stall 了 <span class="arithmatex">\(1\)</span> 个周期</p>
<h3 id="_32">源代码</h3>
<ol>
<li><code>RegFile</code> 模块:</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">negedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="cm">/*double bump*/</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">posedge</span><span class="w"> </span><span class="n">rst</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rst</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">32</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                </span><span class="n">Reg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">            </span><span class="k">end</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">RegWrite</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">Wt_addr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">5</span><span class="mb">&#39;b0</span><span class="p">))</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                </span><span class="n">Reg</span><span class="p">[</span><span class="n">Wt_addr</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">Wt_data</span><span class="p">;</span>
<span class="w">            </span><span class="k">end</span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                </span><span class="n">Reg</span><span class="p">[</span><span class="n">Wt_addr</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="n">Wt_addr</span><span class="p">];</span>
<span class="w">            </span><span class="k">end</span>

<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Rs1_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="n">Rs1_addr</span><span class="p">];</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Rs2_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Reg</span><span class="p">[</span><span class="n">Rs2_addr</span><span class="p">];</span>
</code></pre></div>
<p>将寄存器改为下降沿写</p>
<ol>
<li><code>Stall</code> 模块:</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">stall_control</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ID_rs1</span><span class="p">,</span><span class="w">         </span><span class="c1">// 当前指令的源操作数 rs1</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ID_rs2</span><span class="p">,</span><span class="w">         </span><span class="c1">// 当前指令的源操作数 rs2</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">IDEX_rd</span><span class="p">,</span><span class="w">      </span><span class="c1">// ID 阶段的目标寄存器 // rd_out</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">EXMem_rd</span><span class="p">,</span><span class="w">     </span><span class="c1">// EX 阶段的目标寄存器 // rd_out</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">MemWB_rd</span><span class="p">,</span><span class="w">     </span><span class="c1">// MEM 阶段的目标寄存器 // rd_out</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="n">MemWB_RegWrite</span><span class="p">,</span><span class="w">    </span><span class="c1">//RegWrite_out  </span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="n">EXMem_RegWrite</span><span class="p">,</span><span class="w">    </span><span class="c1">//RegWrite_out  </span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="n">IDEX_RegWrite</span><span class="p">,</span><span class="w">   </span><span class="c1">//RegWrite_out</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">IDEX_MemtoReg</span><span class="p">,</span><span class="w">     </span><span class="c1">//MemtoReg_out</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Mem_PCSrc</span><span class="p">,</span><span class="w">  </span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">IDEX_Branch</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">EXMem_Branch</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">IDEX_Jump</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">EXMem_Jump</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="n">PC_en</span><span class="p">,</span><span class="w"> </span><span class="c1">// PC 写使能信号</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="n">IFID_en</span><span class="p">,</span><span class="w"> </span><span class="c1">// IF/ID 写使能信号</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="n">IDEX_Bubble</span><span class="p">,</span><span class="w"> </span><span class="c1">// ID/EX 阶段插入 bubble</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="n">IFID_flush</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="n">IDEX_flush</span>
<span class="p">);</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="n">stall</span><span class="p">,</span><span class="w"> </span><span class="n">DataHazard</span><span class="p">,</span><span class="w"> </span><span class="n">ControlHazard</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// with forwarding</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">DataHazard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w"> </span>
<span class="w">        </span><span class="p">(</span><span class="n">IDEX_RegWrite</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">IDEX_MemtoReg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">IDEX_rd</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">5</span><span class="mb">&#39;b0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>
<span class="w">        </span><span class="p">((</span><span class="n">ID_rs1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">IDEX_rd</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">ID_rs2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">IDEX_rd</span><span class="p">)))</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="c1">// Load-Use Hazard</span>
<span class="w">        </span><span class="p">(</span><span class="n">IDEX_RegWrite</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">IDEX_MemtoReg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b11</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">IDEX_rd</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">5</span><span class="mb">&#39;b0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>
<span class="w">        </span><span class="p">((</span><span class="n">ID_rs1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">IDEX_rd</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">ID_rs2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">IDEX_rd</span><span class="p">)))</span><span class="w"> </span><span class="c1">// Lui-Use Hazard</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="c1">// without forwarding</span>

<span class="w">    </span><span class="c1">// assign DataHazard = ( </span>
<span class="w">    </span><span class="c1">//     (IDEX_RegWrite &amp;&amp; (IDEX_rd != 5&#39;b0) &amp;&amp; </span>
<span class="w">    </span><span class="c1">//     ((ID_rs1 == IDEX_rd) || (ID_rs2 == IDEX_rd))) || </span>
<span class="w">    </span><span class="c1">//     (EXMem_RegWrite &amp;&amp; (EXMem_rd != 5&#39;b0) &amp;&amp; </span>
<span class="w">    </span><span class="c1">//     ((ID_rs1 == EXMem_rd) || (ID_rs2 == EXMem_rd)))</span>
<span class="w">    </span><span class="c1">//     // || </span>
<span class="w">    </span><span class="c1">//     // (MemWB_RegWrite &amp;&amp; (MemWB_rd != 5&#39;b0) &amp;&amp; </span>
<span class="w">    </span><span class="c1">//     // ((ID_rs1 == MemWB_rd) || (ID_rs2 == MemWB_rd)))</span>
<span class="w">    </span><span class="c1">// );</span>

<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">ControlHazard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">IDEX_Branch</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b0</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">EXMem_Branch</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b0</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span>
<span class="w">        </span><span class="p">(</span><span class="n">IDEX_Jump</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b0</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">EXMem_Jump</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b0</span><span class="p">));</span><span class="w"> </span>

<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">stall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">DataHazard</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">ControlHazard</span><span class="p">);</span>

<span class="w">    </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stall</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EXMem_Branch</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">EXMem_Jump</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b0</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                </span><span class="n">PC_en</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">                </span><span class="n">IFID_en</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">                </span><span class="n">IDEX_Bubble</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">Mem_PCSrc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b0</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                    </span><span class="n">IFID_flush</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">                    </span><span class="n">IDEX_flush</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">                </span><span class="k">end</span>
<span class="w">                </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                    </span><span class="n">IFID_flush</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">                    </span><span class="n">IDEX_flush</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">                </span><span class="k">end</span>
<span class="w">            </span><span class="k">end</span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                </span><span class="n">PC_en</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">                </span><span class="n">IFID_en</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">                </span><span class="n">IFID_flush</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">                </span><span class="n">IDEX_flush</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">                </span><span class="n">IDEX_Bubble</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">            </span><span class="k">end</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="n">PC_en</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span><span class="w">        </span>
<span class="w">            </span><span class="n">IFID_en</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span><span class="w">     </span>
<span class="w">            </span><span class="n">IFID_flush</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">            </span><span class="n">IDEX_flush</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">            </span><span class="n">IDEX_Bubble</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span><span class="w">       </span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">endmodule</span>
</code></pre></div>
<ol>
<li><code>Forwarding</code> 模块:
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">ForwardingUnit</span><span class="p">(</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">EXMem_Rd</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">MemWB_Rd</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">IDEX_Rs1</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">IDEX_Rs2</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w">       </span><span class="n">EXMem_RegWrite</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w">       </span><span class="n">MemWB_RegWrite</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ForwardA</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ForwardB</span>
<span class="p">);</span>

<span class="kt">wire</span><span class="w"> </span><span class="n">EXMemForwardA</span><span class="p">,</span><span class="w"> </span><span class="n">EXMemForwardB</span><span class="p">,</span><span class="w"> </span><span class="n">MemWBForwardA</span><span class="p">,</span><span class="w"> </span><span class="n">MemWBForwardB</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">EXMemForwardA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EXMem_RegWrite</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">EXMem_Rd</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">EXMem_Rd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">IDEX_Rs1</span><span class="p">);</span>
<span class="k">assign</span><span class="w"> </span><span class="n">EXMemForwardB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EXMem_RegWrite</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">EXMem_Rd</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">EXMem_Rd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">IDEX_Rs2</span><span class="p">);</span>
<span class="k">assign</span><span class="w"> </span><span class="n">MemWBForwardA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MemWB_RegWrite</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">MemWB_Rd</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">MemWB_Rd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">IDEX_Rs1</span><span class="p">);</span>
<span class="k">assign</span><span class="w"> </span><span class="n">MemWBForwardB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MemWB_RegWrite</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">MemWB_Rd</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">MemWB_Rd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">IDEX_Rs2</span><span class="p">);</span>

<span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">    </span><span class="c1">// Forwarding for Rs1</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EXMemForwardA</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">        </span><span class="n">ForwardA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b10</span><span class="p">;</span><span class="w"> </span><span class="c1">// Forward from EX/MEM</span>
<span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">MemWBForwardA</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">~</span><span class="n">EXMemForwardA</span><span class="p">))</span><span class="w"> </span><span class="k">begin</span>
<span class="w">        </span><span class="n">ForwardA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b01</span><span class="p">;</span><span class="w"> </span><span class="c1">// Forward from MEM/WB</span>
<span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">        </span><span class="n">ForwardA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span><span class="w"> </span><span class="c1">// No forwarding</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="c1">// Forwarding for Rs2</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EXMemForwardB</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">        </span><span class="n">ForwardB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b10</span><span class="p">;</span><span class="w"> </span><span class="c1">// Forward from EX/MEM</span>
<span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">MemWBForwardB</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">~</span><span class="n">EXMemForwardB</span><span class="p">))</span><span class="w"> </span><span class="k">begin</span>
<span class="w">        </span><span class="n">ForwardB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b01</span><span class="p">;</span><span class="w"> </span><span class="c1">// Forward from MEM/WB</span>
<span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">        </span><span class="n">ForwardB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span><span class="w"> </span><span class="c1">// No forwarding</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>

<span class="k">endmodule</span>
</code></pre></div></li>
<li>改过的 <code>EX</code> 阶段代码:</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">Pipeline_Ex</span><span class="p">(</span><span class="w"> </span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_in_EX</span><span class="p">,</span><span class="w"> </span><span class="c1">//PC输入</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Rs1_in_EX</span><span class="p">,</span><span class="w"> </span><span class="c1">//操作1输入</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Rs2_in_EX</span><span class="p">,</span><span class="w"> </span><span class="c1">//操作2输入</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Imm_in_EX</span><span class="p">,</span><span class="w"> </span><span class="c1">//立即数</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">WHBU_in_EX</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">LSwea_in_EX</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">ALUSrc_B_in_EX</span><span class="p">,</span><span class="w"> </span><span class="c1">//ALU B选择</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ALU_control_in_EX</span><span class="p">,</span><span class="w"> </span><span class="c1">//ALU选择控制</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ForwardA</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ForwardB</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ALU_out_EXMem</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Data_out_WB</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_out_EX</span><span class="p">,</span><span class="w"> </span><span class="c1">//PC输出, PCAddImm</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC4_out_EX</span><span class="p">,</span><span class="w"> </span><span class="c1">//PC+4输出</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="n">zero_out_EX</span><span class="p">,</span><span class="w"> </span><span class="c1">//ALU0输出</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ALU_out_EX</span><span class="p">,</span><span class="w"> </span><span class="c1">//ALU计算输出</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Rs2_out_EX</span><span class="p">,</span><span class="w"> </span><span class="c1">//操作2输出</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">StoreData_out_EX</span><span class="p">,</span><span class="w"> </span><span class="c1">//存储数据输出</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">wea_out_EX</span><span class="w"> </span><span class="c1">//存储控制输出</span>
<span class="p">);</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ALUB</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">PC_out_EX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PC_in_EX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Imm_in_EX</span><span class="p">;</span><span class="w"> </span><span class="c1">// PC_out = PC + Imm</span>
<span class="k">assign</span><span class="w"> </span><span class="n">PC4_out_EX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PC_in_EX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d4</span><span class="p">;</span>


<span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ForwardA_data</span><span class="p">,</span><span class="w"> </span><span class="n">ForwardB_data</span><span class="p">;</span>

<span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">ForwardA</span><span class="p">)</span>
<span class="w">        </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="o">:</span><span class="w"> </span><span class="n">ForwardA_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Rs1_in_EX</span><span class="p">;</span>
<span class="w">        </span><span class="mh">2</span><span class="mb">&#39;b01</span><span class="o">:</span><span class="w"> </span><span class="n">ForwardA_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Data_out_WB</span><span class="p">;</span><span class="w"> </span><span class="c1">// Load data / previous ALU result</span>
<span class="w">        </span><span class="mh">2</span><span class="mb">&#39;b10</span><span class="o">:</span><span class="w"> </span><span class="n">ForwardA_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALU_out_EXMem</span><span class="p">;</span><span class="w"> </span><span class="c1">// ALU result</span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">ForwardA_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">    </span><span class="k">endcase</span>
<span class="k">end</span>

<span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">ForwardB</span><span class="p">)</span>
<span class="w">        </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="o">:</span><span class="w"> </span><span class="n">ForwardB_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Rs2_in_EX</span><span class="p">;</span>
<span class="w">        </span><span class="mh">2</span><span class="mb">&#39;b01</span><span class="o">:</span><span class="w"> </span><span class="n">ForwardB_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Data_out_WB</span><span class="p">;</span>
<span class="w">        </span><span class="mh">2</span><span class="mb">&#39;b10</span><span class="o">:</span><span class="w"> </span><span class="n">ForwardB_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALU_out_EXMem</span><span class="p">;</span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">ForwardB_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">    </span><span class="k">endcase</span>
<span class="k">end</span>

<span class="k">assign</span><span class="w"> </span><span class="n">Rs2_out_EX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ForwardB_data</span><span class="p">;</span>

<span class="k">assign</span><span class="w"> </span><span class="n">ALUB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ALUSrc_B_in_EX</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">Imm_in_EX</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ForwardB_data</span><span class="p">;</span>
<span class="n">ALU</span><span class="w"> </span><span class="n">alu</span><span class="p">(.</span><span class="n">A</span><span class="p">(</span><span class="n">ForwardA_data</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">B</span><span class="p">(</span><span class="n">ALUB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">ALU_operation</span><span class="p">(</span><span class="n">ALU_control_in_EX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">res</span><span class="p">(</span><span class="n">ALU_out_EX</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="p">.</span><span class="n">zero</span><span class="p">(</span><span class="n">zero_out_EX</span><span class="p">));</span>

<span class="k">always</span><span class="w"> </span><span class="p">@</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// 改在 Ex 阶段产生 StoreData</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">LSwea_in_EX</span><span class="p">)</span>
<span class="w">        </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="n">StoreData_out_EX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Rs2_out_EX</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">WHBU_in_EX</span><span class="p">)</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="o">:</span><span class="w"> </span><span class="n">wea_out_EX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0001</span><span class="p">;</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0100</span><span class="o">:</span><span class="w"> </span><span class="n">wea_out_EX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0011</span><span class="p">;</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b1000</span><span class="o">:</span><span class="w"> </span><span class="n">wea_out_EX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b1111</span><span class="p">;</span>
<span class="w">                </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">wea_out_EX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">endcase</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="mh">2</span><span class="mb">&#39;b01</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="n">StoreData_out_EX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">Rs2_out_EX</span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">0</span><span class="p">],</span><span class="w"> </span><span class="mh">8</span><span class="mb">&#39;b0</span><span class="p">};</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">WHBU_in_EX</span><span class="p">)</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="o">:</span><span class="w"> </span><span class="n">wea_out_EX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="p">;</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0100</span><span class="o">:</span><span class="w"> </span><span class="n">wea_out_EX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0110</span><span class="p">;</span>
<span class="w">                </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">wea_out_EX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">endcase</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="mh">2</span><span class="mb">&#39;b10</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="n">StoreData_out_EX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">Rs2_out_EX</span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">],</span><span class="w"> </span><span class="mh">16</span><span class="mb">&#39;b0</span><span class="p">};</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">WHBU_in_EX</span><span class="p">)</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="o">:</span><span class="w"> </span><span class="n">wea_out_EX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0100</span><span class="p">;</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0100</span><span class="o">:</span><span class="w"> </span><span class="n">wea_out_EX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b1100</span><span class="p">;</span>
<span class="w">                </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">wea_out_EX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">endcase</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="mh">2</span><span class="mb">&#39;b11</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="n">StoreData_out_EX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">Rs2_out_EX</span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">0</span><span class="p">],</span><span class="w"> </span><span class="mh">24</span><span class="mb">&#39;b0</span><span class="p">};</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">WHBU_in_EX</span><span class="p">)</span>
<span class="w">                </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="o">:</span><span class="w"> </span><span class="n">wea_out_EX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b1000</span><span class="p">;</span>
<span class="w">                </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">wea_out_EX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">endcase</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">endcase</span>
<span class="k">end</span><span class="w">    </span>

<span class="k">endmodule</span>
</code></pre></div>
<p>改为在 <code>EX</code> 阶段产生 <code>StoreData</code>, 并且接入了 <code>ALU_out_EXMem</code> 和 <code>Data_out_WB</code> 作为 Forwarding 的选择值</p>
<ol>
<li>整体 CPU 代码:
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">Pipeline_CPU</span><span class="p">(</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">clk</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="n">rst</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Data_in</span><span class="p">,</span><span class="w">  </span><span class="c1">// 数据输入</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">inst_IF</span><span class="p">,</span><span class="w">  </span><span class="c1">// 指令输入</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Addr_out</span><span class="p">,</span><span class="w">  </span><span class="c1">// 地址输出 </span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Data_out</span><span class="p">,</span><span class="w">  </span><span class="c1">// 数据输出 </span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Data_out_WB</span><span class="p">,</span><span class="w">  </span><span class="c1">// 写回数据输出</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_out_IF</span><span class="p">,</span><span class="w">  </span><span class="c1">// IF阶段PC输出 </span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">inst_ID</span><span class="p">,</span><span class="w">  </span><span class="c1">// ID阶段指令输出</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_out_ID</span><span class="p">,</span><span class="w">  </span><span class="c1">// ID阶段PC输出</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_out_EX</span><span class="p">,</span><span class="w">  </span><span class="c1">// EX阶段PC输出 </span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="n">MemRW_EX</span><span class="p">,</span><span class="w">  </span><span class="c1">// EX阶段存储器读写</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="n">MemRW_Mem</span><span class="p">,</span><span class="w">  </span><span class="c1">// MEM阶段存储器读写</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">wea</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg00</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg01</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg02</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg03</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg04</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg05</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg06</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg07</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg08</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg09</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg10</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg11</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg12</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg13</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg14</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg15</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg16</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg17</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg18</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg19</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg20</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg21</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg22</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg23</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg24</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg25</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg26</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg27</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg28</span><span class="p">,</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg29</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg30</span><span class="p">,</span><span class="k">output</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Reg31</span>

<span class="p">);</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_out_EXMem</span><span class="p">,</span><span class="w"> </span><span class="n">ALU_out_EXMem</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Rd_addr_out_MemWB</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="n">RegWrite_out_MemWB</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PCSrc</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="n">PC_en</span><span class="p">,</span><span class="w"> </span><span class="n">IFID_en</span><span class="p">,</span><span class="w"> </span><span class="n">IDEX_Bubble</span><span class="p">;</span>
<span class="w">    </span><span class="n">Pipeline_IF</span><span class="w"> </span><span class="n">PPLIF</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">.</span><span class="n">clk_IF</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">rst_IF</span><span class="p">(</span><span class="n">rst</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">en_IF</span><span class="p">(</span><span class="n">PC_en</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC_in_IF</span><span class="p">(</span><span class="n">PC_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PCSrc</span><span class="p">(</span><span class="n">PCSrc</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">ALU_in_IF</span><span class="p">(</span><span class="n">ALU_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC_out_IF</span><span class="p">(</span><span class="n">PC_out_IF</span><span class="p">)</span>

<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_out_IFID</span><span class="p">,</span><span class="w"> </span><span class="n">inst_out_IFID</span><span class="p">;</span>

<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="n">IFID_flush</span><span class="p">,</span><span class="w"> </span><span class="n">IDEX_flush</span><span class="p">;</span>
<span class="w">    </span><span class="n">IF_reg_ID</span><span class="w"> </span><span class="n">PPLIFID</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">.</span><span class="n">clk_IFID</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">rst_IFID</span><span class="p">(</span><span class="n">rst</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">flush</span><span class="p">(</span><span class="n">IFID_flush</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">en_IFID</span><span class="p">(</span><span class="n">IFID_en</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="p">.</span><span class="n">PC_in_IFID</span><span class="p">(</span><span class="n">PC_out_IF</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">inst_in_IFID</span><span class="p">(</span><span class="n">inst_IF</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC_out_IFID</span><span class="p">(</span><span class="n">PC_out_IFID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">inst_out_IFID</span><span class="p">(</span><span class="n">inst_out_IFID</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>


<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Imm_out_ID</span><span class="p">,</span><span class="w"> </span><span class="n">Rs1_out_ID</span><span class="p">,</span><span class="w"> </span><span class="n">Rs2_out_ID</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="n">ALUSrc_B_ID</span><span class="p">,</span><span class="w"> </span><span class="n">MemRW_ID</span><span class="p">,</span><span class="w"> </span><span class="n">RegWrite_out_ID</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Rd_addr_out_ID</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ALU_control_ID</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Branch_ID</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Jump_ID</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">MemtoReg_ID</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">WHBU_ID</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">LSwea_ID</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">StoreData_ID</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">wea_ID</span><span class="p">;</span>


<span class="w">    </span><span class="n">Pipeline_ID</span><span class="w"> </span><span class="n">PPLID</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">.</span><span class="n">clk_ID</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">rst_ID</span><span class="p">(</span><span class="n">rst</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">RegWrite_in_ID</span><span class="p">(</span><span class="n">RegWrite_out_MemWB</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="p">.</span><span class="n">Rd_addr_ID</span><span class="p">(</span><span class="n">Rd_addr_out_MemWB</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="p">.</span><span class="n">Wt_data_ID</span><span class="p">(</span><span class="n">Data_out_WB</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="p">.</span><span class="n">inst_in_ID</span><span class="p">(</span><span class="n">inst_out_IFID</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="p">.</span><span class="n">Rd_addr_out_ID</span><span class="p">(</span><span class="n">Rd_addr_out_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Rs1_out_ID</span><span class="p">(</span><span class="n">Rs1_out_ID</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="p">.</span><span class="n">Rs2_out_ID</span><span class="p">(</span><span class="n">Rs2_out_ID</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="p">.</span><span class="n">Imm_out_ID</span><span class="p">(</span><span class="n">Imm_out_ID</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="p">.</span><span class="n">ALUSrc_B_ID</span><span class="p">(</span><span class="n">ALUSrc_B_ID</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="p">.</span><span class="n">ALU_control_ID</span><span class="p">(</span><span class="n">ALU_control_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Branch_ID</span><span class="p">(</span><span class="n">Branch_ID</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="p">.</span><span class="n">MemRW_ID</span><span class="p">(</span><span class="n">MemRW_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Jump_ID</span><span class="p">(</span><span class="n">Jump_ID</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="p">.</span><span class="n">MemtoReg_ID</span><span class="p">(</span><span class="n">MemtoReg_ID</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="p">.</span><span class="n">RegWrite_out_ID</span><span class="p">(</span><span class="n">RegWrite_out_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Rs1_addr_out_ID</span><span class="p">(</span><span class="n">Rs1_addr_out_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Rs2_addr_out_ID</span><span class="p">(</span><span class="n">Rs2_addr_out_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">WHBU_ID</span><span class="p">(</span><span class="n">WHBU_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">LSwea_ID</span><span class="p">(</span><span class="n">LSwea_ID</span><span class="p">),</span>
<span class="w">        </span><span class="c1">// .StoreData_ID(StoreData_ID),</span>
<span class="w">        </span><span class="c1">// .wea_ID(wea_ID),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Reg00</span><span class="p">(</span><span class="n">Reg00</span><span class="p">),.</span><span class="n">Reg01</span><span class="p">(</span><span class="n">Reg01</span><span class="p">),.</span><span class="n">Reg02</span><span class="p">(</span><span class="n">Reg02</span><span class="p">),.</span><span class="n">Reg03</span><span class="p">(</span><span class="n">Reg03</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Reg04</span><span class="p">(</span><span class="n">Reg04</span><span class="p">),.</span><span class="n">Reg05</span><span class="p">(</span><span class="n">Reg05</span><span class="p">),.</span><span class="n">Reg06</span><span class="p">(</span><span class="n">Reg06</span><span class="p">),.</span><span class="n">Reg07</span><span class="p">(</span><span class="n">Reg07</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Reg08</span><span class="p">(</span><span class="n">Reg08</span><span class="p">),.</span><span class="n">Reg09</span><span class="p">(</span><span class="n">Reg09</span><span class="p">),.</span><span class="n">Reg10</span><span class="p">(</span><span class="n">Reg10</span><span class="p">),.</span><span class="n">Reg11</span><span class="p">(</span><span class="n">Reg11</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Reg12</span><span class="p">(</span><span class="n">Reg12</span><span class="p">),.</span><span class="n">Reg13</span><span class="p">(</span><span class="n">Reg13</span><span class="p">),.</span><span class="n">Reg14</span><span class="p">(</span><span class="n">Reg14</span><span class="p">),.</span><span class="n">Reg15</span><span class="p">(</span><span class="n">Reg15</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Reg16</span><span class="p">(</span><span class="n">Reg16</span><span class="p">),.</span><span class="n">Reg17</span><span class="p">(</span><span class="n">Reg17</span><span class="p">),.</span><span class="n">Reg18</span><span class="p">(</span><span class="n">Reg18</span><span class="p">),.</span><span class="n">Reg19</span><span class="p">(</span><span class="n">Reg19</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Reg20</span><span class="p">(</span><span class="n">Reg20</span><span class="p">),.</span><span class="n">Reg21</span><span class="p">(</span><span class="n">Reg21</span><span class="p">),.</span><span class="n">Reg22</span><span class="p">(</span><span class="n">Reg22</span><span class="p">),.</span><span class="n">Reg23</span><span class="p">(</span><span class="n">Reg23</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Reg24</span><span class="p">(</span><span class="n">Reg24</span><span class="p">),.</span><span class="n">Reg25</span><span class="p">(</span><span class="n">Reg25</span><span class="p">),.</span><span class="n">Reg26</span><span class="p">(</span><span class="n">Reg26</span><span class="p">),.</span><span class="n">Reg27</span><span class="p">(</span><span class="n">Reg27</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Reg28</span><span class="p">(</span><span class="n">Reg28</span><span class="p">),.</span><span class="n">Reg29</span><span class="p">(</span><span class="n">Reg29</span><span class="p">),.</span><span class="n">Reg30</span><span class="p">(</span><span class="n">Reg30</span><span class="p">),.</span><span class="n">Reg31</span><span class="p">(</span><span class="n">Reg31</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_out_IDEX</span><span class="p">,</span><span class="w"> </span><span class="n">Imm_out_IDEX</span><span class="p">,</span><span class="w"> </span><span class="n">Rs1_out_IDEX</span><span class="p">,</span><span class="w"> </span><span class="n">Rs2_out_IDEX</span><span class="p">;</span><span class="w"> </span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">Rd_addr_out_IDEX</span><span class="p">,</span><span class="w"> </span><span class="n">Rs1_addr_out_ID</span><span class="p">,</span><span class="w"> </span><span class="n">Rs2_addr_out_ID</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="n">ALUSrc_B_out_IDEX</span><span class="p">,</span><span class="w"> </span><span class="n">MemRW_out_IDEX</span><span class="p">,</span><span class="w"> </span><span class="n">RegWrite_out_IDEX</span><span class="p">;</span>

<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ALU_control_out_IDEX</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Branch_out_IDEX</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Jump_out_IDEX</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">MemtoReg_out_IDEX</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">WHBU_out_IDEX</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">LSwea_out_IDEX</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">StoreData_out_IDEX</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Rs1_addr_out_IDEX</span><span class="p">,</span><span class="w"> </span><span class="n">Rs2_addr_out_IDEX</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">wea_out_IDEX</span><span class="p">;</span>


<span class="w">    </span><span class="n">ID_reg_Ex</span><span class="w"> </span><span class="n">PPLIDEx</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">.</span><span class="n">clk_IDEX</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">rst_IDEX</span><span class="p">(</span><span class="n">rst</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">en_IDEX</span><span class="p">(</span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Bubble</span><span class="p">(</span><span class="n">IDEX_Bubble</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">flush</span><span class="p">(</span><span class="n">IDEX_flush</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC_in_IDEX</span><span class="p">(</span><span class="n">PC_out_IFID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Rd_addr_IDEX</span><span class="p">(</span><span class="n">Rd_addr_out_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Rs1_addr_IDEX</span><span class="p">(</span><span class="n">Rs1_addr_out_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Rs2_addr_IDEX</span><span class="p">(</span><span class="n">Rs2_addr_out_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Rs1_in_IDEX</span><span class="p">(</span><span class="n">Rs1_out_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Rs2_in_IDEX</span><span class="p">(</span><span class="n">Rs2_out_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Imm_in_IDEX</span><span class="p">(</span><span class="n">Imm_out_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">ALUSrc_B_in_IDEX</span><span class="p">(</span><span class="n">ALUSrc_B_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">ALU_control_in_IDEX</span><span class="p">(</span><span class="n">ALU_control_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Branch_in_IDEX</span><span class="p">(</span><span class="n">Branch_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Jump_in_IDEX</span><span class="p">(</span><span class="n">Jump_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">MemRW_in_IDEX</span><span class="p">(</span><span class="n">MemRW_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">MemtoReg_in_IDEX</span><span class="p">(</span><span class="n">MemtoReg_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">RegWrite_in_IDEX</span><span class="p">(</span><span class="n">RegWrite_out_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">WHBU_in_IDEX</span><span class="p">(</span><span class="n">WHBU_ID</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">LSwea_in_IDEX</span><span class="p">(</span><span class="n">LSwea_ID</span><span class="p">),</span>
<span class="w">        </span><span class="c1">// .StoreData_in_IDEX(StoreData_ID),</span>
<span class="w">        </span><span class="c1">// .wea_in_IDEX(wea_ID),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC_out_IDEX</span><span class="p">(</span><span class="n">PC_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Rd_addr_out_IDEX</span><span class="p">(</span><span class="n">Rd_addr_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Rs1_addr_out_IDEX</span><span class="p">(</span><span class="n">Rs1_addr_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Rs2_addr_out_IDEX</span><span class="p">(</span><span class="n">Rs2_addr_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Rs1_out_IDEX</span><span class="p">(</span><span class="n">Rs1_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Rs2_out_IDEX</span><span class="p">(</span><span class="n">Rs2_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Imm_out_IDEX</span><span class="p">(</span><span class="n">Imm_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">ALUSrc_B_out_IDEX</span><span class="p">(</span><span class="n">ALUSrc_B_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">ALU_control_out_IDEX</span><span class="p">(</span><span class="n">ALU_control_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Branch_out_IDEX</span><span class="p">(</span><span class="n">Branch_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Jump_out_IDEX</span><span class="p">(</span><span class="n">Jump_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">MemRW_out_IDEX</span><span class="p">(</span><span class="n">MemRW_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">MemtoReg_out_IDEX</span><span class="p">(</span><span class="n">MemtoReg_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">RegWrite_out_IDEX</span><span class="p">(</span><span class="n">RegWrite_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">WHBU_out_IDEX</span><span class="p">(</span><span class="n">WHBU_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">LSwea_out_IDEX</span><span class="p">(</span><span class="n">LSwea_out_IDEX</span><span class="p">)</span>
<span class="w">        </span><span class="c1">// .StoreData_out_IDEX(StoreData_out_IDEX),</span>
<span class="w">        </span><span class="c1">// .wea_out_IDEX(wea_out_IDEX)</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC4_out_EX</span><span class="p">,</span><span class="w"> </span><span class="n">ALU_out_EX</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Rs2_out_EX</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="n">zero_out_EX</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ForwardA</span><span class="p">,</span><span class="w"> </span><span class="n">ForwardB</span><span class="p">;</span>


<span class="w">    </span><span class="c1">// 新增 Forwarding 模块</span>
<span class="w">    </span><span class="n">ForwardingUnit</span><span class="w"> </span><span class="n">PPLForwarding</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">.</span><span class="n">IDEX_Rs1</span><span class="p">(</span><span class="n">Rs1_addr_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">IDEX_Rs2</span><span class="p">(</span><span class="n">Rs2_addr_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">EXMem_Rd</span><span class="p">(</span><span class="n">Rd_addr_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">MemWB_Rd</span><span class="p">(</span><span class="n">Rd_addr_out_MemWB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">EXMem_RegWrite</span><span class="p">(</span><span class="n">RegWrite_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">MemWB_RegWrite</span><span class="p">(</span><span class="n">RegWrite_out_MemWB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">ForwardA</span><span class="p">(</span><span class="n">ForwardA</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">ForwardB</span><span class="p">(</span><span class="n">ForwardB</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">StoreData_out_EX</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">wea_out_EX</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// 改为在 Ex 产生 StoreData</span>
<span class="w">    </span><span class="n">Pipeline_Ex</span><span class="w"> </span><span class="n">PPLEx</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC_in_EX</span><span class="p">(</span><span class="n">PC_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Rs1_in_EX</span><span class="p">(</span><span class="n">Rs1_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Rs2_in_EX</span><span class="p">(</span><span class="n">Rs2_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Imm_in_EX</span><span class="p">(</span><span class="n">Imm_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">WHBU_in_EX</span><span class="p">(</span><span class="n">WHBU_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">LSwea_in_EX</span><span class="p">(</span><span class="n">LSwea_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">ALUSrc_B_in_EX</span><span class="p">(</span><span class="n">ALUSrc_B_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">ALU_control_in_EX</span><span class="p">(</span><span class="n">ALU_control_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">ForwardA</span><span class="p">(</span><span class="n">ForwardA</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">ForwardB</span><span class="p">(</span><span class="n">ForwardB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">ALU_out_EXMem</span><span class="p">(</span><span class="n">ALU_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Data_out_WB</span><span class="p">(</span><span class="n">Data_out_WB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC_out_EX</span><span class="p">(</span><span class="n">PC_out_EX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC4_out_EX</span><span class="p">(</span><span class="n">PC4_out_EX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">zero_out_EX</span><span class="p">(</span><span class="n">zero_out_EX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">ALU_out_EX</span><span class="p">(</span><span class="n">ALU_out_EX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Rs2_out_EX</span><span class="p">(</span><span class="n">Rs2_out_EX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">StoreData_out_EX</span><span class="p">(</span><span class="n">StoreData_out_EX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">wea_out_EX</span><span class="p">(</span><span class="n">wea_out_EX</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC4_out_EXMem</span><span class="p">,</span><span class="w"> </span><span class="n">Imm_out_EXMem</span><span class="p">,</span><span class="w"> </span><span class="n">Rs2_out_EXMem</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Rd_addr_out_EXMem</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="n">zero_out_EXMem</span><span class="p">,</span><span class="w"> </span><span class="n">MemRW_out_EXMem</span><span class="p">,</span><span class="w"> </span><span class="n">RegWrite_out_EXMem</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Branch_out_EXMem</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">Jump_out_EXMem</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">MemtoReg_out_EXMem</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">WHBU_out_EXMem</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">LSwea_out_EXMem</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">StoreData_out_EXMem</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">wea_out_EXMem</span><span class="p">;</span>

<span class="w">    </span><span class="n">Ex_reg_Mem</span><span class="w"> </span><span class="n">PPLExMem</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">.</span><span class="n">clk_EXMem</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">rst_EXMem</span><span class="p">(</span><span class="n">rst</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">en_EXMem</span><span class="p">(</span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC_in_EXMem</span><span class="p">(</span><span class="n">PC_out_EX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Imm_in_EXMem</span><span class="p">(</span><span class="n">Imm_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC4_in_EXMem</span><span class="p">(</span><span class="n">PC4_out_EX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Rd_addr_EXMem</span><span class="p">(</span><span class="n">Rd_addr_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">zero_in_EXMem</span><span class="p">(</span><span class="n">zero_out_EX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">ALU_in_EXMem</span><span class="p">(</span><span class="n">ALU_out_EX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Rs2_in_EXMem</span><span class="p">(</span><span class="n">Rs2_out_EX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Branch_in_EXMem</span><span class="p">(</span><span class="n">Branch_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Jump_in_EXMem</span><span class="p">(</span><span class="n">Jump_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">MemRW_in_EXMem</span><span class="p">(</span><span class="n">MemRW_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">MemtoReg_in_EXMem</span><span class="p">(</span><span class="n">MemtoReg_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">RegWrite_in_EXMem</span><span class="p">(</span><span class="n">RegWrite_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">WHBU_in_EXMem</span><span class="p">(</span><span class="n">WHBU_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">LSwea_in_EXMem</span><span class="p">(</span><span class="n">LSwea_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">StoreData_in_EXMem</span><span class="p">(</span><span class="n">StoreData_out_EX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">wea_in_EXMem</span><span class="p">(</span><span class="n">wea_out_EX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC_out_EXMem</span><span class="p">(</span><span class="n">PC_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Imm_out_EXMem</span><span class="p">(</span><span class="n">Imm_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC4_out_EXMem</span><span class="p">(</span><span class="n">PC4_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Rd_addr_out_EXMem</span><span class="p">(</span><span class="n">Rd_addr_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">zero_out_EXMem</span><span class="p">(</span><span class="n">zero_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">ALU_out_EXMem</span><span class="p">(</span><span class="n">ALU_out_EXMem</span><span class="p">),</span>

<span class="w">        </span><span class="p">.</span><span class="n">Rs2_out_EXMem</span><span class="p">(</span><span class="n">Rs2_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Branch_out_EXMem</span><span class="p">(</span><span class="n">Branch_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Jump_out_EXMem</span><span class="p">(</span><span class="n">Jump_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">MemRW_out_EXMem</span><span class="p">(</span><span class="n">MemRW_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">MemtoReg_out_EXMem</span><span class="p">(</span><span class="n">MemtoReg_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">RegWrite_out_EXMem</span><span class="p">(</span><span class="n">RegWrite_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">WHBU_out_EXMem</span><span class="p">(</span><span class="n">WHBU_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">LSwea_out_EXMem</span><span class="p">(</span><span class="n">LSwea_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">StoreData_out_EXMem</span><span class="p">(</span><span class="n">StoreData_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">wea_out_EXMem</span><span class="p">(</span><span class="n">wea_out_EXMem</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="n">Pipeline_Mem</span><span class="w"> </span><span class="n">PPLMem</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">.</span><span class="n">zero_in_Mem</span><span class="p">(</span><span class="n">zero_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">res_in_Mem</span><span class="p">(</span><span class="n">ALU_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Branch_in_Mem</span><span class="p">(</span><span class="n">Branch_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Jump_in_Mem</span><span class="p">(</span><span class="n">Jump_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PCSrc</span><span class="p">(</span><span class="n">PCSrc</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC_out_MemWB</span><span class="p">,</span><span class="w"> </span><span class="n">Imm_out_MemWB</span><span class="p">,</span><span class="w"> </span><span class="n">PC4_out_MemWB</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="n">ALU_out_MemWB</span><span class="p">,</span><span class="w"> </span><span class="n">Dmem_data_out_MemWB</span><span class="p">;</span>

<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">MemtoReg_out_MemWB</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//wire RegWrite_out_MemWB;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">WHBU_out_MemWB</span><span class="p">;</span>
<span class="w">    </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">LSwea_out_MemWB</span><span class="p">;</span>

<span class="w">    </span><span class="n">Mem_reg_WB</span><span class="w"> </span><span class="n">PPLMemWB</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">.</span><span class="n">clk_MemWB</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">rst_MemWB</span><span class="p">(</span><span class="n">rst</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">en_MemWB</span><span class="p">(</span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC_in_MemWB</span><span class="p">(</span><span class="n">PC_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Imm_in_MemWB</span><span class="p">(</span><span class="n">Imm_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC4_in_MemWB</span><span class="p">(</span><span class="n">PC4_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Rd_addr_MemWB</span><span class="p">(</span><span class="n">Rd_addr_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">ALU_in_MemWB</span><span class="p">(</span><span class="n">ALU_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Dmem_data_MemWB</span><span class="p">(</span><span class="n">Data_in</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">MemtoReg_in_MemWB</span><span class="p">(</span><span class="n">MemtoReg_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">RegWrite_in_MemWB</span><span class="p">(</span><span class="n">RegWrite_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">WHBU_in_MemWB</span><span class="p">(</span><span class="n">WHBU_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">LSwea_in_MemWB</span><span class="p">(</span><span class="n">LSwea_out_EXMem</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC_out_MemWB</span><span class="p">(</span><span class="n">PC_out_MemWB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Imm_out_MemWB</span><span class="p">(</span><span class="n">Imm_out_MemWB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC4_out_MemWB</span><span class="p">(</span><span class="n">PC4_out_MemWB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Rd_addr_out_MemWB</span><span class="p">(</span><span class="n">Rd_addr_out_MemWB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">ALU_out_MemWB</span><span class="p">(</span><span class="n">ALU_out_MemWB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Dmem_data_out_MemWB</span><span class="p">(</span><span class="n">Dmem_data_out_MemWB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">MemtoReg_out_MemWB</span><span class="p">(</span><span class="n">MemtoReg_out_MemWB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">RegWrite_out_MemWB</span><span class="p">(</span><span class="n">RegWrite_out_MemWB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">WHBU_out_MemWB</span><span class="p">(</span><span class="n">WHBU_out_MemWB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">LSwea_out_MemWB</span><span class="p">(</span><span class="n">LSwea_out_MemWB</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="n">Pipeline_WB</span><span class="w"> </span><span class="n">PPLWB</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC4_in_WB</span><span class="p">(</span><span class="n">PC4_out_MemWB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">ALU_in_WB</span><span class="p">(</span><span class="n">ALU_out_MemWB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Dmem_data_WB</span><span class="p">(</span><span class="n">Dmem_data_out_MemWB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Imm_in_WB</span><span class="p">(</span><span class="n">Imm_out_MemWB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC_in_WB</span><span class="p">(</span><span class="n">PC_out_MemWB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">MemtoReg_in_WB</span><span class="p">(</span><span class="n">MemtoReg_out_MemWB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">WHBU_in_WB</span><span class="p">(</span><span class="n">WHBU_out_MemWB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">LSwea_in_WB</span><span class="p">(</span><span class="n">LSwea_out_MemWB</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">Data_out_WB</span><span class="p">(</span><span class="n">Data_out_WB</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">MemRW_EX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MemRW_out_IDEX</span><span class="p">;</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">MemRW_Mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MemRW_out_EXMem</span><span class="p">;</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Addr_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALU_out_EXMem</span><span class="p">;</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">Data_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StoreData_out_EXMem</span><span class="p">;</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">wea</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wea_out_EXMem</span><span class="p">;</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">PC_out_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PC_out_IFID</span><span class="p">;</span>
<span class="w">    </span><span class="k">assign</span><span class="w"> </span><span class="n">inst_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst_out_IFID</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//新增 stall 模块</span>
<span class="w">    </span><span class="n">stall_control</span><span class="w"> </span><span class="n">sc</span><span class="p">(.</span><span class="n">ID_rs1</span><span class="p">(</span><span class="n">Rs1_addr_out_ID</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">ID_rs2</span><span class="p">(</span><span class="n">Rs2_addr_out_ID</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="p">.</span><span class="n">IDEX_rd</span><span class="p">(</span><span class="n">Rd_addr_out_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">EXMem_rd</span><span class="p">(</span><span class="n">Rd_addr_out_EXMem</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="p">.</span><span class="n">MemWB_rd</span><span class="p">(</span><span class="n">Rd_addr_out_MemWB</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="p">.</span><span class="n">EXMem_RegWrite</span><span class="p">(</span><span class="n">RegWrite_out_EXMem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">IDEX_RegWrite</span><span class="p">(</span><span class="n">RegWrite_out_IDEX</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="p">.</span><span class="n">MemWB_RegWrite</span><span class="p">(</span><span class="n">RegWrite_out_MemWB</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">IDEX_MemtoReg</span><span class="p">(</span><span class="n">MemtoReg_out_IDEX</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">IDEX_Branch</span><span class="p">(</span><span class="n">Branch_out_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">EXMem_Branch</span><span class="p">(</span><span class="n">Branch_out_EXMem</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="p">.</span><span class="n">IDEX_Jump</span><span class="p">(</span><span class="n">Jump_out_IDEX</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">EXMem_Jump</span><span class="p">(</span><span class="n">Jump_out_EXMem</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="p">.</span><span class="n">Mem_PCSrc</span><span class="p">(</span><span class="n">PCSrc</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">PC_en</span><span class="p">(</span><span class="n">PC_en</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">IFID_en</span><span class="p">(</span><span class="n">IFID_en</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">IDEX_Bubble</span><span class="p">(</span><span class="n">IDEX_Bubble</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="p">.</span><span class="n">IFID_flush</span><span class="p">(</span><span class="n">IFID_flush</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">IDEX_flush</span><span class="p">(</span><span class="n">IDEX_flush</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
<span class="k">endmodule</span>
</code></pre></div></li>
</ol>
<h3 id="_33">仿真关键步骤说明</h3>
<ol>
<li>仿真汇编</li>
</ol>
<div class="highlight"><pre><span></span><code>    auipc x1, 0
    j     start            # 00
dummy:
    nop                    # 04
    nop                    # 08
    nop                    # 0C
    nop                    # 10
    nop                    # 14
    nop                    # 18
    nop                    # 1C
    j     dummy

start:
    bnez  x1, dummy
    beq   x0, x0, pass_0
    li    x31, 0
    auipc x30, 0
    j     dummy
pass_0:
    li    x31, 1
    bne   x0, x0, dummy
    bltu  x0, x0, dummy
    li    x1, -1           # x1=FFFFFFFF
    xori  x3, x1, 1        # x3=FFFFFFFE
    add   x3, x3, x3       # x3=FFFFFFFC
    add   x3, x3, x3       # x3=FFFFFFF8
    add   x3, x3, x3       # x3=FFFFFFF0    
    add   x3, x3, x3       # x3=FFFFFFE0
    add   x3, x3, x3       # x3=FFFFFFC0
    add   x3, x3, x3       # x3=FFFFFF80
    add   x3, x3, x3       # x3=FFFFFF00
    add   x3, x3, x3       # x3=FFFFFE00
    add   x3, x3, x3       # x3=FFFFFC00
    add   x3, x3, x3       # x3=FFFFF800
    add   x3, x3, x3       # x3=FFFFF000
    add   x3, x3, x3       # x3=FFFFE000
    add   x3, x3, x3       # x3=FFFFC000
    add   x3, x3, x3       # x3=FFFF8000
    add   x3, x3, x3       # x3=FFFF0000
    add   x3, x3, x3       # x3=FFFE0000
    add   x3, x3, x3       # x3=FFFC0000
    add   x3, x3, x3       # x3=FFF80000
    add   x3, x3, x3       # x3=FFF00000
    add   x3, x3, x3       # x3=FFE00000
    add   x3, x3, x3       # x3=FFC00000
    add   x3, x3, x3       # x3=FF800000
    add   x3, x3, x3       # x3=FF000000
    add   x3, x3, x3       # x3=FE000000
    add   x3, x3, x3       # x3=FC000000
    add   x5, x3, x3       # x5=F8000000
    add   x3, x5, x5       # x3=F0000000
    add   x4, x3, x3       # x4=E0000000
    add   x6, x4, x4       # x6=C0000000
    add   x7, x6, x6       # x7=80000000
    ori   x8, zero, 1      # x8=00000001
    ori   x28, zero, 31
    srl   x29, x7, x28     # x29=00000001
    auipc x30, 0
    bne   x8, x29, dummy
    auipc x30, 0
    blt   x8, x7, dummy
    sra   x29, x7, x28     # x29=FFFFFFFF
    and   x29, x29, x3     # x29=x3=F0000000
    auipc x30, 0
    bne   x3, x29, dummy
    mv    x29, x8          # x29=x8=00000001
    bltu  x29, x7, pass_1  # unsigned 00000001 &lt; 80000000
    auipc x30, 0
    j     dummy

pass_1:
    nop
    li    x31, 2
    sub   x3, x6, x7       # x3=40000000
    sub   x4, x7, x3       # x4=40000000
    slti  x9, x0, 1        # x9=00000001
    slt   x10, x3, x4
    slt   x10, x4, x3      # x10=00000000
    auipc x30, 0
    beq   x9, x10, dummy   # branch when x3 != x4
    srli  x29, x3, 30      # x29=00000001
    beq   x29, x9, pass_2
    auipc x30, 0
    j     dummy

pass_2:
    nop
# Test set-less-than
    li    x31, 3
    slti  x10, x1, 3       # x10=00000001
    slt   x11, x5, x1      # signed(0xF8000000) &lt; -1
                        # x11=00000001
    slt   x12, x1, x3      # x12=00000001
    andi  x10, x10, 0xff
    and   x10, x10, x11
    and   x10, x10, x12    # x10=00000001
    auipc x30, 0
    beqz  x10, dummy
    sltu  x10, x1, x8      # unsigned FFFFFFFF &lt; 00000001 ?
    auipc x30, 0
    bnez  x10, dummy
    sltu  x10, x8, x3      # unsigned 00000001 &lt; F0000000 ?
    auipc x30, 0
    beqz  x10, dummy
    sltiu x10, x1, 3
    auipc x30, 0
    bnez  x10, dummy
    li    x11, 1
    bne   x10, x11, pass_3
    auipc x30, 0
    j     dummy

pass_3:
    nop
    li    x31, 4
    or    x11, x7, x3      # x11=C0000000
    beq   x11, x6, pass_4
    auipc x30, 0
    j     dummy

pass_4:
    nop
    li    x31, 5
    li    x18, 0x20        # base addr=00000020
### uncomment instr. below when simulating on venus
    # lui   x18, 0x10000     # base addr=10000000
    sw    x5, 0(x18)       # mem[0x20]=F8000000
    sw    x4, 4(x18)       # mem[0x24]=40000000
    lw    x27, 0(x18)      # x27=mem[0x20]=F8000000
    xor   x27, x27, x5     # x27=00000000
    sw    x6, 0(x18)       # mem[0x20]=C0000000
    lw    x28, 0(x18)      # x28=mem[0x20]=C0000000
    xor   x27, x6, x28     # x27=00000000
    auipc x30, 0
    bnez  x27, dummy
    lui   x20, 0xA0000     # x20=A0000000
    sw    x20, 8(x18)      # mem[0x28]=A0000000
    lui   x27, 0xFEDCB     # x27=FEDCB000
    srai  x27, x27, 12     # x27=FFFFEDCB
    li    x28, 8
    sll   x27, x27, x28    # x27=FFEDCB00
    ori   x27, x27, 0xff   # x27=FFEDCBFF
    lb    x29, 11(x18)     # x29=FFFFFFA0, little-endian, signed-ext
    and   x27, x27, x29    # x27=FFEDCBA0
    sw    x27, 8(x18)      # mem[0x28]=FFEDCBA0
    lhu   x27, 8(x18)      # x27=0000CBA0
    lui   x20, 0xFFFF0     # x20=FFFF0000
    and   x20, x20, x27    # x20=00000000
    auipc x30, 0
    bnez  x20, dummy       # check unsigned-ext
    li    x31, 6
    lbu   x28, 10(x18)     # x28=000000ED
    lbu   x29, 11(x18)     # x29=000000FF
    slli  x29, x29, 8      # x29=0000FF00
    or    x29, x29, x28    # x29=0000FFED
    slli  x29, x29, 16
    or    x29, x27, x29    # x29=FFEDCBA0
    lw    x28, 8(x18)      # x28=FFEDCBA0
    auipc x30, 0
    bne   x28, x29, dummy
    sw    x0, 0(x18)       # mem[0x20]=00000000
    sh    x27, 0(x18)      # mem[0x20]=0000CBA0
    li    x28, 0xD0
    sb    x28, 2(x18)      # mem[0x20]=00D0CBA0
    lw    x28, 0(x18)      # x28=00D0CBA0
    li    x29, 0x00D0CBA0
    auipc x30, 0
    bne   x28, x29, dummy
    lh    x27, 2(x18)      # x27=000000D0
    li    x28, 0xD0
    auipc x30, 0
    bne   x27, x28, dummy

pass_5:
    li    x31, 7
    auipc x30, 0
    bge   x1, x0, dummy    # -1 &gt;= 0 ?
    bge   x8, x1, pass_6   # 1 &gt;= -1 ?
    auipc x30, 0
    j     dummy

pass_6:
    auipc x30, 0
    bgeu  x0, x1, dummy    # 0 &gt;= FFFFFFFF ?
    auipc x30, 0
    bgeu  x8, x1, dummy
    auipc x20, 0
    jalr  x21, x0, pass_7  # just for test : (
    auipc x30, 0
    j     dummy

pass_7:
# original test ends here
    addi  x20, x20, 8
    auipc x30, 0
    bne   x20, x21, dummy
pass_8:
    li    x31, 8
    addi  x1, x0, 1
    lui   x7, 1
    addi  x2, x1, 2
    lui   x7, 1
    beq   x1, x0, dummy
    addi  x3, x2, 3
    lui   x7, 1
    sw    x3, 0(x0)
    lui   x7, 1
    beq   x3, x0, dummy
    lw    x4, 0(x0)
    lui   x7, 1
    addi  x5, x4, 4
    lui   x7, 1
    beq   x5, x0, dummy
    addi  x6, x5, 5
    lui   x7, 1
    addi  x7, x7, 15
    addi  x8, x0, 1
    slli  x8, x8, 12
    sub   x7, x7, x8
    bne   x7, x6, dummy
pass_9:
    li    x31, 9
    addi  x0, x1, 1
    sub   x1, x1, x1
    bne   x0, x1, dummy
pass_10:
    li    x31, 10
    lui   x1, 233
    sw    x1, 0(x0)
    lw    x2, 0(x0)
    bne   x1, x2, dummy
pass_11:
    li    x31, 11
    addi  x1, x0, 233
    beq   x0, x1, dummy
    addi  x1, x0, -1
    blt   x0, x1, dummy
    bltu  x1, x0, dummy

passed:
    li    x31, 0x666
    j     dummy
</code></pre></div>
<p>该汇编代码为在 Lab 4-3 的基础上改编而来, 在原有的测试点 <code>pass_7</code> 后新增了 <code>pass_8</code> 到 <code>pass_11</code> <span class="arithmatex">\(4\)</span> 个测试点</p>
<p><code>pass_9</code> 主要测试普通 Use-Use Hazard</p>
<p><code>pass_10</code> 主要测试 Load-Use, Use-Store, Lui-Use Hazard</p>
<p><code>pass_11</code> 主要测试 Control Hazard</p>
<p><code>pass_8</code> 是综合上面的所有情况, 将所有类型指令混合在一起而成的一大段代码, 包含了上面的所有冲突</p>
<p>具体为, 在 Use 与 Use 中间穿插进多条 <code>lw, sw, lui</code> 指令, 同时还穿插了跳转指令</p>
<ol>
<li>仿真代码</li>
</ol>
<p><div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">sim</span><span class="p">();</span>
<span class="w">    </span><span class="kt">reg</span><span class="w"> </span><span class="n">clk</span><span class="p">;</span>
<span class="w">    </span><span class="kt">reg</span><span class="w"> </span><span class="n">rst</span><span class="p">;</span>
<span class="w">    </span><span class="n">testbench</span><span class="w"> </span><span class="n">m0</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst</span><span class="p">));</span>
<span class="w">    </span><span class="k">initial</span><span class="w"> </span><span class="k">begin</span>
<span class="w">        </span><span class="n">clk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">        </span><span class="n">rst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">        </span><span class="p">#</span><span class="mh">50</span><span class="p">;</span>
<span class="w">        </span><span class="n">rst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">always</span><span class="w"> </span><span class="p">#</span><span class="mh">10</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">clk</span><span class="p">;</span>
<span class="k">endmodule</span>
</code></pre></div>
与Lab 5-1 相同</p>
<h2 id="_34">实验结果与分析</h2>
<h3 id="_35">仿真结果</h3>
<p><img alt="alt text" src="../../images/PCPU/image-2.png" /></p>
<ol>
<li>运行仿真后 <code>x31</code> 寄存器首先正常改为 <code>8</code>, 说明基本的程序运行没有问题, 通过了 Lba 4-3 的基本仿真代码</li>
</ol>
<p><img alt="alt text" src="../../images/PCPU/image-3.png" /></p>
<ol>
<li>
<p>之后 <code>x31</code> 寄存器正常改为 <code>9</code>, 说明 <code>8</code> 号测试点通过, 符合预期</p>
<p>下面来具体分析 <code>9, 10, 11</code> 号测试点</p>
</li>
<li>
<p>对于 <code>9</code> 号测试点, 首先 <code>x1 = 1</code>, 之后 <code>x1 = x1 - x1</code>, 即用自己减去自己, 最后判断结果是否为 <code>0</code></p>
<p>可以看到, 图中 <code>x1</code> 被改为 <code>0</code>, 因此通过了测试点 <code>9</code> </p>
</li>
</ol>
<p><img alt="alt text" src="../../images/PCPU/image-4.png" /></p>
<ol>
<li>
<p>对于 <code>10</code> 号测试点, 首先 <code>lui x1, 233</code>, 之后先将 <code>x1</code> 的值存入 <code>mem[0]</code>, 再将 <code>mem[0]</code> 的值读入 <code>x2</code>, 最后判断是否 <code>x1 = x2</code></p>
<p>这个过程中出现了 Lui-Use, Use-Store 冲突</p>
<p>可以看到, 图中 <code>x1</code> 先被改为 <code>000e9000</code>, 这对应了 <code>233</code> 的 <span class="arithmatex">\(16\)</span> 进制表示; 然后看到 <code>x2 = 000e9000</code>, 因此通过了测试点 <code>10</code> </p>
</li>
</ol>
<p><img alt="alt text" src="../../images/PCPU/image-5.png" /></p>
<ol>
<li>
<p>对于 <code>11</code> 号测试点, 首先 <code>x1 = 233</code>, 后跟一句含有 <code>x1</code> 的跳转指令; 之后先将 <code>x1</code> 的值设为 <code>-1</code>, 后跟两句含有 <code>x1</code> 的跳转指令</p>
<p>这个过程中出现了控制冲突</p>
<p>可以看到, 图中 <code>x1</code> 先被改为 <code>000000e9</code>, 这对应了 <code>233</code> 的 <span class="arithmatex">\(16\)</span> 进制表示; 然后看到 <code>x1 = ffffffff</code>, 最后通过了测试点 <code>11</code> </p>
</li>
<li>
<p>最终 <code>x31 = 666</code>, 说明通过了仿真测试</p>
</li>
</ol>
<h3 id="_36">下板结果</h3>
<h1 id="_37">思考题</h1>
<blockquote>
<p>基于你完成的流水线，对于以下两段代码分别分析：不同指令之间是否存在冲突（如果有，请逐条列出）、在你的流水线上运行的 CPI 为何。</p>
<p><code>TP-0</code>:</p>
<div class="highlight"><pre><span></span><code><span class="n">addi</span><span class="w">    </span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="mh">0</span>
<span class="n">addi</span><span class="w">    </span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mh">1</span>
<span class="n">addi</span><span class="w">    </span><span class="n">x3</span><span class="p">,</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="mh">1</span>
<span class="n">addi</span><span class="w">    </span><span class="n">x4</span><span class="p">,</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mh">1</span>
<span class="n">addi</span><span class="w">    </span><span class="n">x5</span><span class="p">,</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="mh">1</span>
<span class="n">addi</span><span class="w">    </span><span class="n">x6</span><span class="p">,</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mh">1</span>
<span class="n">addi</span><span class="w">    </span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="mh">0</span>
<span class="n">addi</span><span class="w">    </span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="mh">1</span>
<span class="n">addi</span><span class="w">    </span><span class="n">x3</span><span class="p">,</span><span class="w"> </span><span class="n">x3</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mh">1</span>
<span class="n">addi</span><span class="w">    </span><span class="n">x4</span><span class="p">,</span><span class="w"> </span><span class="n">x4</span><span class="p">,</span><span class="w"> </span><span class="mh">1</span>
<span class="n">addi</span><span class="w">    </span><span class="n">x5</span><span class="p">,</span><span class="w"> </span><span class="n">x5</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mh">1</span>
<span class="n">addi</span><span class="w">    </span><span class="n">x6</span><span class="p">,</span><span class="w"> </span><span class="n">x6</span><span class="p">,</span><span class="w"> </span><span class="mh">1</span>
</code></pre></div>
<p><code>TP-1</code>:</p>
<p><code>verilog
addi    x1, x0, 1
addi    x2, x1, 2
addi    x3, x1, 3
addi    x4, x3, 4</code></p>
</blockquote>
<ol>
<li>
<p>对于 <code>TP-0</code>, 指令之间没有冲突, 因为没有上下两条指令的互相依赖</p>
<p>对于 <code>addi xi, xi, c</code> 指令, 在 <code>ID</code> 阶段取出 <code>xi</code> 中的值, <code>EX</code> 阶段与立即数相加, 并在 <code>WB</code> 阶段写回, 期间没有发生冲突</p>
<p>所以 <span class="arithmatex">\(Cycles = 12+5-1=16,Instruction=12\)</span></p>
<p><span class="arithmatex">\(CPI = 16/12=1.33\)</span></p>
</li>
<li>
<p>对于 <code>TP-1</code>, 第一条与第二条指令间有冲突, 使用 Forwarding 解决;</p>
</li>
</ol>
<p>第一条与第三条指令间有冲突, 使用 Forwarding 解决;</p>
<p>第三条与第四条指令间有冲突, 使用 Forwarding 解决;</p>
<p>所以 <span class="arithmatex">\(Cycles = 4+5-1=8,Instruction=4\)</span></p>
<pre><code>$CPI = 8/4=2$
</code></pre>
<blockquote>
<p>请根据你的实现，在 testbench 上仿真以下代码，给出仿真结果，并写出完成所有指令用了多少拍，必须给出的信号有 clk, IF-PC, ID-PC 以及所有用到的寄存器值。请务必注意调整数制为十六进制，缩放能够看到所有信号值
<div class="highlight"><pre><span></span><code><span class="n">addi</span><span class="w">    </span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">x0</span><span class="p">,</span><span class="w"> </span><span class="mh">1</span>
<span class="n">addi</span><span class="w">    </span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="mh">2</span>
<span class="n">addi</span><span class="w">    </span><span class="n">x3</span><span class="p">,</span><span class="w"> </span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="mh">3</span>
<span class="n">sw</span><span class="w">      </span><span class="n">x3</span><span class="p">,</span><span class="w"> </span><span class="mh">0</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
<span class="n">lw</span><span class="w">      </span><span class="n">x4</span><span class="p">,</span><span class="w"> </span><span class="mh">0</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
<span class="n">addi</span><span class="w">    </span><span class="n">x5</span><span class="p">,</span><span class="w"> </span><span class="n">x4</span><span class="p">,</span><span class="w"> </span><span class="mh">4</span>
<span class="n">addi</span><span class="w">    </span><span class="n">x6</span><span class="p">,</span><span class="w"> </span><span class="n">x4</span><span class="p">,</span><span class="w"> </span><span class="mh">5</span>
</code></pre></div></p>
</blockquote>
<p>仿真结果如下:</p>
<p><img alt="alt text" src="../../images/PCPU/image-6.png" /></p>
<p>一共用了 <span class="arithmatex">\(12\)</span> 拍, 其中第 <span class="arithmatex">\(7\)</span> 拍 stall 了 <span class="arithmatex">\(1\)</span> 拍, 因为遇到了 Load-Use 冲突</p>
<p>之后由于 Forwarding, 没有更多的 stall, 所以一共用了 <span class="arithmatex">\(5+7-1+1=12\)</span> 拍</p>
<h1 id="cache">Cache</h1>
<h2 id="_38">操作方法与实验步骤</h2>
<h3 id="_39">代码设计层次结构图及说明</h3>
<p><img alt="alt text" src="../../images/cache/image-2.png" /></p>
<h4 id="_40">组相联映射方式</h4>
<ol>
<li>主存和cache按同样大小划分成块。</li>
<li>主存和cache按同样大小划分成组。</li>
<li>主存容量是cache容量的整数倍，将主存空间按cache区的大小分成区，主存中每一区的组数与cache的组数相同。</li>
<li>当主存的数据调入cache时，主存与cache的组号应相等，也就是各区中的某一块只能存入cache的同组号的空间内，但组内各块地址之间则可以任意存放， 即从主存的组到cache的组之间采用直接映射方式；在两个对应的组内部采用全相联映射方式。</li>
</ol>
<h4 id="lru">LRU 替换算法</h4>
<p>依据各块使用的情况，总是选择那个最近最少使用的块被替换。这种方法比较好地反映了程序局部性规律，命中率最高。</p>
<h4 id="write-back">Write Back</h4>
<p>方法：在CPU执行写操作时，只写入cache，不写入主存, 在 miss 时将 dirty 的数据块写回</p>
<p>优点：速度较高</p>
<p>缺点：可靠性较差，控制操作比较复杂</p>
<h4 id="allocate">Allocate</h4>
<p>miss 时将 memory 中数据搬到 cache 中</p>
<h3 id="_41">源代码</h3>
<p><em>1. Data_ram 代码:</em></p>
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">Data_ram</span><span class="p">(</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="n">clk</span><span class="p">,</span><span class="w"> </span><span class="c1">// clock</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="n">en</span><span class="p">,</span><span class="w"> </span><span class="c1">// enable</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="n">rst</span><span class="p">,</span><span class="w"> </span><span class="c1">// reset</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="c1">// address</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">127</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">din</span><span class="p">,</span><span class="w"> </span><span class="c1">// data write in</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">127</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">dout</span><span class="w"> </span><span class="c1">// data read out</span>
<span class="w">    </span><span class="c1">// input wire [Index_width-1:0] addr, // address</span>
<span class="w">    </span><span class="c1">// input wire [Block_width-1:0] din, // data write in</span>
<span class="w">    </span><span class="c1">// output wire [Block_width-1:0] dout // data read out</span>
<span class="p">);</span>
<span class="k">parameter</span><span class="w"> </span><span class="n">NUM_of_sets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">128</span><span class="p">;</span>
<span class="k">parameter</span><span class="w"> </span><span class="n">Block_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">128</span><span class="p">;</span>
<span class="k">parameter</span><span class="w"> </span><span class="n">Index_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">7</span><span class="p">;</span>
<span class="c1">//cache line memory: data for way0</span>
<span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="n">Block_width</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">cache_data</span><span class="w"> </span><span class="p">[</span><span class="mh">0</span><span class="o">:</span><span class="n">NUM_of_sets</span><span class="o">-</span><span class="mh">1</span><span class="p">];</span>

<span class="c1">//Read and Write data to Cache</span>
<span class="k">integer</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">posedge</span><span class="w"> </span><span class="n">rst</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">rst</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mh">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">NUM_of_sets</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mh">1</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="n">cache_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">128</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">en</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="n">cache_data</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">din</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="n">cache_data</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">cache_data</span><span class="p">[</span><span class="n">addr</span><span class="p">];</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>
<span class="k">assign</span><span class="w"> </span><span class="n">dout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cache_data</span><span class="p">[</span><span class="n">addr</span><span class="p">];</span>
<span class="k">endmodule</span>
</code></pre></div>
<p>在 <code>Data_ram</code> 模块中, 实现了 <span class="arithmatex">\(128\)</span> 个长度为 <span class="arithmatex">\(128\)</span> 的寄存器，用于保存 cache 中的数据, 可以存储 <span class="arithmatex">\(4\)</span> 个 word</p>
<p>当 <code>rst = 1</code> 时，寄存器清零</p>
<p>当 <code>en = 1</code>时允许写入数据，否则不能写入</p>
<p><em>2. Tag_ram 代码:</em></p>
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">Tag_ram</span><span class="p">(</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="n">clk</span><span class="p">,</span><span class="w"> </span><span class="c1">// clock</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="n">en</span><span class="p">,</span><span class="w"> </span><span class="c1">// enable</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="n">rst</span><span class="p">,</span><span class="w"> </span><span class="c1">// reset</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="c1">// address</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">25</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">din</span><span class="p">,</span><span class="w"> </span><span class="c1">// data write in</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">25</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">dout</span><span class="w"> </span><span class="c1">// data read out</span>
<span class="p">);</span>
<span class="k">parameter</span><span class="w"> </span><span class="n">NUM_of_sets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">128</span><span class="p">;</span>
<span class="k">parameter</span><span class="w"> </span><span class="n">Index_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">7</span><span class="p">;</span>
<span class="k">parameter</span><span class="w"> </span><span class="n">TAG_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">23</span><span class="p">;</span>
<span class="k">parameter</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="k">parameter</span><span class="w"> </span><span class="n">U</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="k">parameter</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>

<span class="c1">//cache line memory: tag,V,U,D for way0</span>
<span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="n">TAG_width</span><span class="o">+</span><span class="n">V</span><span class="o">+</span><span class="n">U</span><span class="o">+</span><span class="n">D</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">cache_TAG</span><span class="w"> </span><span class="p">[</span><span class="mh">0</span><span class="o">:</span><span class="n">NUM_of_sets</span><span class="o">-</span><span class="mh">1</span><span class="p">];</span>
<span class="k">integer</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">posedge</span><span class="w"> </span><span class="n">rst</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">rst</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">rst</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mh">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">NUM_of_sets</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mh">1</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                </span><span class="n">cache_TAG</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">128</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">            </span><span class="k">end</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">en</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="n">cache_TAG</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">din</span><span class="p">;</span><span class="w">    </span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="n">cache_TAG</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">cache_TAG</span><span class="p">[</span><span class="n">addr</span><span class="p">];</span><span class="w">    </span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="c1">//Read and Write TAG to Cache</span>
<span class="k">end</span>

<span class="k">assign</span><span class="w"> </span><span class="n">dout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cache_TAG</span><span class="p">[</span><span class="n">addr</span><span class="p">];</span>
<span class="k">endmodule</span>
</code></pre></div>
<p>在 <code>Tag_ram</code> 模块中, 实现了 <span class="arithmatex">\(128\)</span> 个长度为 <span class="arithmatex">\(26\)</span> 的寄存器，用于保存 cache 中的标签与有效标记, 最高位存储 <code>V</code>， 表示是否有效; 第二位 <code>U</code> 表示是否最近使用; <code>D</code> 表示块中的数据是否被改变过, 即是否是脏位; 最后 <span class="arithmatex">\(23\)</span> 位存储标签</p>
<p>当 <code>rst = 1</code> 时，寄存器清零</p>
<p>当 <code>en = 1</code> 时允许写入数据，否则不能写入</p>
<p><em>3. Cache 代码:</em></p>
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">cache</span><span class="p">(</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="n">clk</span><span class="p">,</span><span class="w"> </span><span class="c1">// clock</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="n">rst</span><span class="p">,</span><span class="w"> </span><span class="c1">// reset</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">data_cpu_write</span><span class="p">,</span><span class="w"> </span><span class="c1">// data write in</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">data_mem_read</span><span class="p">,</span><span class="w"> </span><span class="c1">// data read in</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">addr_cpu</span><span class="p">,</span><span class="w"> </span><span class="c1">// cpu addr</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="n">wr_cpu</span><span class="p">,</span><span class="w"> </span><span class="c1">// cpu write enable</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="n">rd_cpu</span><span class="p">,</span><span class="w"> </span><span class="c1">// cpu read enable</span>
<span class="w">    </span><span class="k">input</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="n">ready_mem</span><span class="p">,</span><span class="w"> </span><span class="c1">// memory ready</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="n">wr_mem</span><span class="p">,</span><span class="w"> </span><span class="c1">// memory write enable // write back</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="n">rd_mem</span><span class="p">,</span><span class="w"> </span><span class="c1">// memory read enable </span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">data_mem_write</span><span class="p">,</span><span class="w"> </span><span class="c1">// data to mem // write back</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">data_cpu_read</span><span class="p">,</span><span class="w"> </span><span class="c1">// data to cpu</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">addr_mem</span><span class="w"> </span><span class="c1">// memory addr</span>
<span class="p">);</span>
<span class="k">parameter</span><span class="w"> </span><span class="n">NUM_of_sets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">128</span><span class="p">;</span>
<span class="k">parameter</span><span class="w"> </span><span class="n">Block_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">128</span><span class="p">;</span>
<span class="k">parameter</span><span class="w"> </span><span class="n">Index_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">7</span><span class="p">;</span>
<span class="k">parameter</span><span class="w"> </span><span class="n">TAG_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">23</span><span class="p">;</span>
<span class="k">parameter</span><span class="w"> </span><span class="n">tag_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">26</span><span class="p">;</span>
<span class="k">parameter</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="k">parameter</span><span class="w"> </span><span class="n">U</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="k">parameter</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="k">parameter</span><span class="w"> </span><span class="n">IDLE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="k">parameter</span><span class="w"> </span><span class="n">CompareTag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="k">parameter</span><span class="w"> </span><span class="n">Allocate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="p">;</span>
<span class="k">parameter</span><span class="w"> </span><span class="n">WriteBack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="p">;</span>

<span class="c1">// Cache Controller State Machine and Logic</span>
<span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">state</span><span class="p">;</span>
<span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">next_state</span><span class="p">;</span>
<span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="n">TAG_width</span><span class="o">+</span><span class="n">V</span><span class="o">+</span><span class="n">U</span><span class="o">+</span><span class="n">D</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">wtag0</span><span class="p">,</span><span class="w"> </span><span class="n">wtag1</span><span class="p">;</span>
<span class="kt">reg</span><span class="w"> </span><span class="n">ent0</span><span class="p">,</span><span class="w"> </span><span class="n">ent1</span><span class="p">,</span><span class="w"> </span><span class="n">en0</span><span class="p">,</span><span class="w"> </span><span class="n">en1</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="n">TAG_width</span><span class="o">+</span><span class="n">V</span><span class="o">+</span><span class="n">U</span><span class="o">+</span><span class="n">D</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rtag0</span><span class="p">,</span><span class="w"> </span><span class="n">rtag1</span><span class="p">;</span>
<span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="n">Block_width</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">wdata</span><span class="p">;</span>
<span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="n">Block_width</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">wdata_hit</span><span class="p">,</span><span class="w"> </span><span class="n">rdata_hit</span><span class="p">;</span>
<span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="n">Block_width</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">wdata_miss</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="n">Block_width</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rdata0</span><span class="p">,</span><span class="w"> </span><span class="n">rdata1</span><span class="p">,</span><span class="w"> </span><span class="n">rdata</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="n">TAG_width</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="n">tag0</span><span class="p">,</span><span class="w"> </span><span class="n">tag1</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="n">Index_width</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">index</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span>

<span class="kt">wire</span><span class="w"> </span><span class="n">hit</span><span class="p">,</span><span class="w"> </span><span class="n">hit0</span><span class="p">,</span><span class="w"> </span><span class="n">hit1</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="n">valid0</span><span class="p">,</span><span class="w"> </span><span class="n">valid1</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="n">cpu_req_valid</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">cpu_req_valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">wr_cpu</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">rd_cpu</span><span class="p">);</span>
<span class="k">assign</span><span class="w"> </span><span class="n">tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addr_cpu</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">9</span><span class="p">];</span>
<span class="k">assign</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addr_cpu</span><span class="p">[</span><span class="mh">8</span><span class="o">:</span><span class="mh">2</span><span class="p">];</span>
<span class="k">assign</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addr_cpu</span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
<span class="k">assign</span><span class="w"> </span><span class="n">valid0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rtag0</span><span class="p">[</span><span class="n">TAG_width</span><span class="o">+</span><span class="n">V</span><span class="o">+</span><span class="n">U</span><span class="o">+</span><span class="n">D</span><span class="o">-</span><span class="mh">1</span><span class="p">];</span>
<span class="k">assign</span><span class="w"> </span><span class="n">valid1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rtag1</span><span class="p">[</span><span class="n">TAG_width</span><span class="o">+</span><span class="n">V</span><span class="o">+</span><span class="n">U</span><span class="o">+</span><span class="n">D</span><span class="o">-</span><span class="mh">1</span><span class="p">];</span>
<span class="k">assign</span><span class="w"> </span><span class="n">tag0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rtag0</span><span class="p">[</span><span class="n">TAG_width</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
<span class="k">assign</span><span class="w"> </span><span class="n">tag1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rtag1</span><span class="p">[</span><span class="n">TAG_width</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
<span class="k">assign</span><span class="w"> </span><span class="n">hit0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">tag0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">tag</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">valid0</span><span class="p">);</span>
<span class="k">assign</span><span class="w"> </span><span class="n">hit1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">tag1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">tag</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">valid1</span><span class="p">);</span>
<span class="k">assign</span><span class="w"> </span><span class="n">hit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">hit0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">hit1</span><span class="p">);</span>
<span class="k">assign</span><span class="w"> </span><span class="n">rdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hit0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">rdata0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="n">hit1</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">rdata1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">128</span><span class="mb">&#39;b0</span><span class="p">);</span>
<span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mem_ready</span><span class="p">,</span><span class="w"> </span><span class="n">next_mem_ready</span><span class="p">;</span>
<span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="n">Block_width</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mem_data</span><span class="p">;</span>
<span class="kt">wire</span><span class="w"> </span><span class="n">dirty</span><span class="p">;</span>
<span class="k">assign</span><span class="w"> </span><span class="n">dirty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">rtag0</span><span class="p">[</span><span class="mh">24</span><span class="o">:</span><span class="mh">23</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b01</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">rtag1</span><span class="p">[</span><span class="mh">24</span><span class="o">:</span><span class="mh">23</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b01</span><span class="p">);</span>

<span class="k">always</span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">    </span><span class="k">case</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
<span class="w">        </span><span class="mh">2</span><span class="mi">&#39;d0</span><span class="o">:</span><span class="w"> </span><span class="n">rdata_hit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rdata</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
<span class="w">        </span><span class="mh">2</span><span class="mi">&#39;d1</span><span class="o">:</span><span class="w"> </span><span class="n">rdata_hit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rdata</span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">32</span><span class="p">];</span>
<span class="w">        </span><span class="mh">2</span><span class="mi">&#39;d2</span><span class="o">:</span><span class="w"> </span><span class="n">rdata_hit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rdata</span><span class="p">[</span><span class="mh">95</span><span class="o">:</span><span class="mh">64</span><span class="p">];</span>
<span class="w">        </span><span class="mh">2</span><span class="mi">&#39;d3</span><span class="o">:</span><span class="w"> </span><span class="n">rdata_hit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rdata</span><span class="p">[</span><span class="mh">127</span><span class="o">:</span><span class="mh">96</span><span class="p">];</span>
<span class="w">    </span><span class="k">endcase</span>
<span class="w">    </span><span class="k">case</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
<span class="w">        </span><span class="mh">2</span><span class="mi">&#39;d0</span><span class="o">:</span><span class="w"> </span><span class="n">wdata_hit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">rdata</span><span class="p">[</span><span class="mh">127</span><span class="o">:</span><span class="mh">32</span><span class="p">],</span><span class="w"> </span><span class="n">data_cpu_write</span><span class="p">};</span>
<span class="w">        </span><span class="mh">2</span><span class="mi">&#39;d1</span><span class="o">:</span><span class="w"> </span><span class="n">wdata_hit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">rdata</span><span class="p">[</span><span class="mh">127</span><span class="o">:</span><span class="mh">64</span><span class="p">],</span><span class="w"> </span><span class="n">data_cpu_write</span><span class="p">,</span><span class="w"> </span><span class="n">rdata</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]};</span>
<span class="w">        </span><span class="mh">2</span><span class="mi">&#39;d2</span><span class="o">:</span><span class="w"> </span><span class="n">wdata_hit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">rdata</span><span class="p">[</span><span class="mh">127</span><span class="o">:</span><span class="mh">96</span><span class="p">],</span><span class="w"> </span><span class="n">data_cpu_write</span><span class="p">,</span><span class="w"> </span><span class="n">rdata</span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">0</span><span class="p">]};</span>
<span class="w">        </span><span class="mh">2</span><span class="mi">&#39;d3</span><span class="o">:</span><span class="w"> </span><span class="n">wdata_hit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">data_cpu_write</span><span class="p">,</span><span class="w"> </span><span class="n">rdata</span><span class="p">[</span><span class="mh">95</span><span class="o">:</span><span class="mh">0</span><span class="p">]};</span>
<span class="w">    </span><span class="k">endcase</span>
<span class="k">end</span>

<span class="n">Data_ram</span><span class="w"> </span><span class="n">d0</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">addr</span><span class="p">(</span><span class="n">index</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">din</span><span class="p">(</span><span class="n">wdata</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">en</span><span class="p">(</span><span class="n">en0</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">dout</span><span class="p">(</span><span class="n">rdata0</span><span class="p">)</span>
<span class="p">);</span>
<span class="n">Data_ram</span><span class="w"> </span><span class="n">d1</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">addr</span><span class="p">(</span><span class="n">index</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">din</span><span class="p">(</span><span class="n">wdata</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">en</span><span class="p">(</span><span class="n">en1</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">dout</span><span class="p">(</span><span class="n">rdata1</span><span class="p">)</span>
<span class="p">);</span>
<span class="n">Tag_ram</span><span class="w"> </span><span class="n">t0</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">addr</span><span class="p">(</span><span class="n">index</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">din</span><span class="p">(</span><span class="n">wtag0</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">en</span><span class="p">(</span><span class="n">ent0</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">dout</span><span class="p">(</span><span class="n">rtag0</span><span class="p">)</span>
<span class="p">);</span>
<span class="n">Tag_ram</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">addr</span><span class="p">(</span><span class="n">index</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">din</span><span class="p">(</span><span class="n">wtag1</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">en</span><span class="p">(</span><span class="n">ent1</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">dout</span><span class="p">(</span><span class="n">rtag1</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">always</span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">posedge</span><span class="w"> </span><span class="n">rst</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">rst</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">        </span><span class="n">state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">IDLE</span><span class="p">;</span>
<span class="w">        </span><span class="n">mem_ready</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">3</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">        </span><span class="n">state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">next_state</span><span class="p">;</span>
<span class="w">        </span><span class="n">mem_ready</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">next_mem_ready</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>


<span class="k">always</span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">    </span><span class="k">case</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<span class="w">        </span><span class="nl">IDLE:</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="n">next_mem_ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">            </span><span class="n">en0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">            </span><span class="n">en1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">            </span><span class="n">ent0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">            </span><span class="n">ent1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">            </span><span class="n">wtag0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">            </span><span class="n">wtag1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">            </span><span class="n">wr_mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">            </span><span class="n">rd_mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">            </span><span class="n">data_mem_write</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">            </span><span class="c1">//data_cpu_read = 0;</span>
<span class="w">            </span><span class="n">addr_mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">cpu_req_valid</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                </span><span class="n">next_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CompareTag</span><span class="p">;</span><span class="w"> </span>
<span class="w">            </span><span class="k">end</span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                </span><span class="n">next_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IDLE</span><span class="p">;</span>
<span class="w">            </span><span class="k">end</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="nl">CompareTag:</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="n">mem_ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">hit</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                </span><span class="n">next_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IDLE</span><span class="p">;</span>
<span class="w">                </span><span class="n">ent0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">                </span><span class="n">ent1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">wr_cpu</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// write hit </span>
<span class="w">                    </span><span class="n">wdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wdata_hit</span><span class="p">;</span>
<span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="n">hit0</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                        </span><span class="n">en0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">                        </span><span class="n">en1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">                        </span><span class="n">wtag0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">3</span><span class="mb">&#39;b111</span><span class="p">,</span><span class="w"> </span><span class="n">rtag0</span><span class="p">[</span><span class="mh">22</span><span class="o">:</span><span class="mh">0</span><span class="p">]};</span><span class="w">    </span><span class="c1">// recently used, set dirty</span>
<span class="w">                        </span><span class="n">wtag1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">rtag1</span><span class="p">[</span><span class="mh">25</span><span class="p">],</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">,</span><span class="w"> </span><span class="n">rtag1</span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">0</span><span class="p">]};</span><span class="w">    </span><span class="c1">// not recently used</span>
<span class="w">                    </span><span class="k">end</span>
<span class="w">                    </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                        </span><span class="n">en0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">                        </span><span class="n">en1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">                        </span><span class="n">wtag0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">rtag0</span><span class="p">[</span><span class="mh">25</span><span class="p">],</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">,</span><span class="w"> </span><span class="n">rtag0</span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">0</span><span class="p">]};</span><span class="w">    </span><span class="c1">// not recently used</span>
<span class="w">                        </span><span class="n">wtag1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">3</span><span class="mb">&#39;b111</span><span class="p">,</span><span class="w"> </span><span class="n">rtag1</span><span class="p">[</span><span class="mh">22</span><span class="o">:</span><span class="mh">0</span><span class="p">]};</span><span class="w">    </span><span class="c1">// recently used, set dirty</span>
<span class="w">                    </span><span class="k">end</span>
<span class="w">                </span><span class="k">end</span>
<span class="w">                </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// read hit</span>
<span class="w">                    </span><span class="n">data_cpu_read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rdata_hit</span><span class="p">;</span>
<span class="w">                    </span><span class="n">en0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">                    </span><span class="n">en1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">                    </span><span class="n">wtag0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">rtag0</span><span class="p">[</span><span class="mh">25</span><span class="p">],</span><span class="w"> </span><span class="n">hit0</span><span class="p">,</span><span class="w"> </span><span class="n">rtag0</span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">0</span><span class="p">]};</span><span class="w">   </span>
<span class="w">                    </span><span class="n">wtag1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">rtag1</span><span class="p">[</span><span class="mh">25</span><span class="p">],</span><span class="w"> </span><span class="n">hit1</span><span class="p">,</span><span class="w"> </span><span class="n">rtag1</span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">0</span><span class="p">]};</span><span class="w">    </span>
<span class="w">                </span><span class="k">end</span>
<span class="w">            </span><span class="k">end</span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">dirty</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                    </span><span class="n">next_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WriteBack</span><span class="p">;</span>
<span class="w">                </span><span class="k">end</span>
<span class="w">                </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                    </span><span class="n">next_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Allocate</span><span class="p">;</span>
<span class="w">                </span><span class="k">end</span>
<span class="w">            </span><span class="k">end</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="nl">Allocate:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// read/write miss</span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">mem_ready</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">3</span><span class="mi">&#39;d4</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                </span><span class="n">rd_mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">                </span><span class="n">next_mem_ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">                </span><span class="n">next_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CompareTag</span><span class="p">;</span>
<span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">rtag0</span><span class="p">[</span><span class="mh">24</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w">   </span><span class="c1">// not recently used</span>
<span class="w">                    </span><span class="n">en0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">                    </span><span class="n">ent0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">                    </span><span class="n">en1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">                    </span><span class="n">ent1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">                    </span><span class="n">wtag0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">3</span><span class="mb">&#39;b110</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="p">};</span><span class="w">    </span><span class="c1">// recently used, set clean</span>
<span class="w">                    </span><span class="n">wdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mem_data</span><span class="p">;</span>
<span class="w">                </span><span class="k">end</span>
<span class="w">                </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                    </span><span class="n">en0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">                    </span><span class="n">ent0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">                    </span><span class="n">en1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">                    </span><span class="n">ent1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">                    </span><span class="n">wtag1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">3</span><span class="mb">&#39;b110</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="p">};</span><span class="w">    </span><span class="c1">// recently used, set clean</span>
<span class="w">                    </span><span class="n">wdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mem_data</span><span class="p">;</span>
<span class="w">                </span><span class="k">end</span>
<span class="w">            </span><span class="k">end</span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// get data from memory</span>
<span class="w">                </span><span class="n">en0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">                </span><span class="n">en1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">                </span><span class="n">ent0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">                </span><span class="n">ent1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">                </span><span class="n">rd_mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">                </span><span class="n">next_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Allocate</span><span class="p">;</span>
<span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">ready_mem</span><span class="p">)</span>
<span class="w">                    </span><span class="n">next_mem_ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mem_ready</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">                </span><span class="k">else</span><span class="w"> </span>
<span class="w">                    </span><span class="n">next_mem_ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mem_ready</span><span class="p">;</span>
<span class="w">                </span><span class="k">case</span><span class="p">(</span><span class="n">mem_ready</span><span class="p">)</span>
<span class="w">                    </span><span class="mh">3</span><span class="mi">&#39;d0</span><span class="o">:</span><span class="w"> </span><span class="n">mem_data</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data_mem_read</span><span class="p">;</span>
<span class="w">                    </span><span class="mh">3</span><span class="mi">&#39;d1</span><span class="o">:</span><span class="w"> </span><span class="n">mem_data</span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">32</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data_mem_read</span><span class="p">;</span>
<span class="w">                    </span><span class="mh">3</span><span class="mi">&#39;d2</span><span class="o">:</span><span class="w"> </span><span class="n">mem_data</span><span class="p">[</span><span class="mh">95</span><span class="o">:</span><span class="mh">64</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data_mem_read</span><span class="p">;</span>
<span class="w">                    </span><span class="mh">3</span><span class="mi">&#39;d3</span><span class="o">:</span><span class="w"> </span><span class="n">mem_data</span><span class="p">[</span><span class="mh">127</span><span class="o">:</span><span class="mh">96</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data_mem_read</span><span class="p">;</span>
<span class="w">                </span><span class="k">endcase</span>
<span class="w">            </span><span class="k">end</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="nl">WriteBack:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// carry dirty data to memory</span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">mem_ready</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">3</span><span class="mi">&#39;d4</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                </span><span class="n">wr_mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">                </span><span class="n">next_mem_ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">                </span><span class="n">en0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">                </span><span class="n">en1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">                </span><span class="n">ent0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">                </span><span class="n">ent1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">                </span><span class="n">next_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Allocate</span><span class="p">;</span>
<span class="w">            </span><span class="k">end</span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                </span><span class="n">wr_mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">                </span><span class="n">next_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WriteBack</span><span class="p">;</span>
<span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">ready_mem</span><span class="p">)</span>
<span class="w">                    </span><span class="n">next_mem_ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mem_ready</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">                </span><span class="k">else</span><span class="w"> </span>
<span class="w">                    </span><span class="n">next_mem_ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mem_ready</span><span class="p">;</span>

<span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">rtag0</span><span class="p">[</span><span class="mh">24</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w">   </span><span class="c1">// not recently used</span>
<span class="w">                    </span><span class="n">en0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">                    </span><span class="n">ent0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">                    </span><span class="n">en1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">                    </span><span class="n">ent1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">                    </span><span class="k">case</span><span class="p">(</span><span class="n">mem_ready</span><span class="p">)</span>
<span class="w">                        </span><span class="mh">3</span><span class="mi">&#39;d0</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">addr_mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">rtag0</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">};</span><span class="w"> </span><span class="n">data_mem_write</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rdata0</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span><span class="w"> </span><span class="k">end</span>
<span class="w">                        </span><span class="mh">3</span><span class="mi">&#39;d1</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">addr_mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">rtag0</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b01</span><span class="p">};</span><span class="w"> </span><span class="n">data_mem_write</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rdata0</span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">32</span><span class="p">];</span><span class="w"> </span><span class="k">end</span>
<span class="w">                        </span><span class="mh">3</span><span class="mi">&#39;d2</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">addr_mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">rtag0</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b10</span><span class="p">};</span><span class="w"> </span><span class="n">data_mem_write</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rdata0</span><span class="p">[</span><span class="mh">95</span><span class="o">:</span><span class="mh">64</span><span class="p">];</span><span class="w"> </span><span class="k">end</span>
<span class="w">                        </span><span class="mh">3</span><span class="mi">&#39;d3</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">addr_mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">rtag0</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b11</span><span class="p">};</span><span class="w"> </span><span class="n">data_mem_write</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rdata0</span><span class="p">[</span><span class="mh">127</span><span class="o">:</span><span class="mh">96</span><span class="p">];</span><span class="w"> </span><span class="k">end</span>
<span class="w">                    </span><span class="k">endcase</span>
<span class="w">                </span><span class="k">end</span>
<span class="w">                </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                    </span><span class="n">en0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">                    </span><span class="n">ent0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">                    </span><span class="n">en1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">                    </span><span class="n">ent1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">                    </span><span class="k">case</span><span class="p">(</span><span class="n">mem_ready</span><span class="p">)</span>
<span class="w">                        </span><span class="mh">3</span><span class="mi">&#39;d0</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">addr_mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">rtag1</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">};</span><span class="w"> </span><span class="n">data_mem_write</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rdata1</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span><span class="w"> </span><span class="k">end</span>
<span class="w">                        </span><span class="mh">3</span><span class="mi">&#39;d1</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">addr_mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">rtag1</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b01</span><span class="p">};</span><span class="w"> </span><span class="n">data_mem_write</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rdata1</span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">32</span><span class="p">];</span><span class="w"> </span><span class="k">end</span>
<span class="w">                        </span><span class="mh">3</span><span class="mi">&#39;d2</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">addr_mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">rtag1</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b10</span><span class="p">};</span><span class="w"> </span><span class="n">data_mem_write</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rdata1</span><span class="p">[</span><span class="mh">95</span><span class="o">:</span><span class="mh">64</span><span class="p">];</span><span class="w"> </span><span class="k">end</span>
<span class="w">                        </span><span class="mh">3</span><span class="mi">&#39;d3</span><span class="o">:</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="n">addr_mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">rtag1</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b11</span><span class="p">};</span><span class="w"> </span><span class="n">data_mem_write</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rdata1</span><span class="p">[</span><span class="mh">127</span><span class="o">:</span><span class="mh">96</span><span class="p">];</span><span class="w"> </span><span class="k">end</span>
<span class="w">                    </span><span class="k">endcase</span>
<span class="w">                </span><span class="k">end</span>

<span class="w">            </span><span class="k">end</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">next_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IDLE</span><span class="p">;</span>
<span class="w">    </span><span class="k">endcase</span>
<span class="k">end</span>

<span class="k">endmodule</span>
</code></pre></div>
<p>在 <code>cache</code> 模块中实现了 <span class="arithmatex">\(4\)</span> 个 <code>ram</code> 模块，存储两组数据与标签; 同时实现了 <code>cache controller</code> 的有限状态机：</p>
<p><img alt="alt text" src="../../images/cache/image-3.png" /></p>
<p>当产生了来自 <code>cpu</code> 的读写信号时, 从 <code>IDLE</code> 进入 <code>CompareTag</code> 状态，比较下标为 <code>index</code> 的组中是否有相同的 <code>tag</code>, 如果有则 <code>hit</code>, 那么就返回 <code>IDLE</code> 状态，更改<code>V, U</code> 标记位; 并且如果是写，就更改 <code>Dirty</code> 标记</p>
<p>如果是 <code>miss</code>，就需要将 memory 中的数据拿到 cache 中</p>
<p>如果当前这个 block 已经满了, 就需要替换掉最近没使用的那一块</p>
<p>如果这一块数据被更改过，需要先将原本的更改过的数据存回 memory，即 write back</p>
<p>再将数据从 memory 搬到 cache 中，即 allocate</p>
<p>搬完数据后重新比较标签, 此时变为 <code>hit</code>, 按照 <code>hit</code> 的方式处理即可</p>
<h3 id="_42">仿真关键步骤说明</h3>
<p><em>1. testbench 代码：</em></p>
<div class="highlight"><pre><span></span><code><span class="k">module</span><span class="w"> </span><span class="n">cache_tb</span><span class="p">();</span>

<span class="kt">reg</span><span class="w"> </span><span class="n">clk</span><span class="p">;</span><span class="w"> </span><span class="c1">// clock</span>
<span class="kt">reg</span><span class="w"> </span><span class="n">rst</span><span class="p">;</span><span class="w"> </span><span class="c1">// reset</span>
<span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">data_cpu_write</span><span class="p">;</span><span class="w"> </span><span class="c1">// data write in</span>
<span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">data_mem_read</span><span class="p">;</span><span class="w"> </span><span class="c1">// data read in</span>
<span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">addr_cpu</span><span class="p">;</span><span class="w"> </span><span class="c1">// cpu addr</span>
<span class="kt">reg</span><span class="w"> </span><span class="n">wr_cpu</span><span class="p">;</span><span class="w"> </span><span class="c1">// cpu write enable</span>
<span class="kt">reg</span><span class="w"> </span><span class="n">rd_cpu</span><span class="p">;</span><span class="w"> </span><span class="c1">// cpu read enable</span>
<span class="kt">reg</span><span class="w"> </span><span class="n">ready_mem</span><span class="p">;</span><span class="w"> </span><span class="c1">// memory ready</span>
<span class="kt">wire</span><span class="w"> </span><span class="n">wr_mem</span><span class="p">;</span><span class="w"> </span><span class="c1">// memory write enable // write back</span>
<span class="kt">wire</span><span class="w"> </span><span class="n">rd_mem</span><span class="p">;</span><span class="w"> </span><span class="c1">// memory read enable </span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">data_mem_write</span><span class="p">;</span><span class="w"> </span><span class="c1">// data to mem // write back</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">data_cpu_read</span><span class="p">;</span><span class="w"> </span><span class="c1">// data to cpu</span>
<span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">addr_mem</span><span class="p">;</span><span class="w"> </span><span class="c1">// memory addr</span>

<span class="n">cache</span><span class="w"> </span><span class="n">c</span><span class="p">(.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rst</span><span class="p">(</span><span class="n">rst</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">data_cpu_write</span><span class="p">(</span><span class="n">data_cpu_write</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="p">.</span><span class="n">data_mem_read</span><span class="p">(</span><span class="n">data_mem_read</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">addr_cpu</span><span class="p">(</span><span class="n">addr_cpu</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">wr_cpu</span><span class="p">(</span><span class="n">wr_cpu</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rd_cpu</span><span class="p">(</span><span class="n">rd_cpu</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">ready_mem</span><span class="p">(</span><span class="n">ready_mem</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">wr_mem</span><span class="p">(</span><span class="n">wr_mem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">rd_mem</span><span class="p">(</span><span class="n">rd_mem</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">data_mem_write</span><span class="p">(</span><span class="n">data_mem_write</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">data_cpu_read</span><span class="p">(</span><span class="n">data_cpu_read</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">addr_mem</span><span class="p">(</span><span class="n">addr_mem</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">initial</span><span class="w"> </span><span class="k">begin</span>
<span class="w">    </span><span class="n">wr_cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">rd_cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">clk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">rst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">ready_mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">#</span><span class="mh">60</span><span class="p">;</span>
<span class="w">    </span><span class="n">rst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">#</span><span class="mh">40</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//write miss</span>
<span class="w">    </span><span class="n">wr_cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mi">&#39;d1</span><span class="p">;</span>
<span class="w">    </span><span class="n">addr_cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32&#39;h00000207</span><span class="p">;</span>
<span class="w">    </span><span class="n">data_cpu_write</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32&#39;h19198100</span><span class="p">;</span>
<span class="w">    </span><span class="p">#</span><span class="mh">20</span><span class="p">;</span>
<span class="w">    </span><span class="p">#</span><span class="mh">20</span><span class="p">;</span>
<span class="w">    </span><span class="n">data_mem_read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32&#39;habababab</span><span class="p">;</span>
<span class="w">    </span><span class="p">#</span><span class="mh">20</span><span class="p">;</span>
<span class="w">    </span><span class="n">data_mem_read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32&#39;hcdcdcdcd</span><span class="p">;</span>
<span class="w">    </span><span class="p">#</span><span class="mh">20</span><span class="p">;</span>
<span class="w">    </span><span class="n">data_mem_read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32&#39;h12345678</span><span class="p">;</span>
<span class="w">    </span><span class="p">#</span><span class="mh">20</span><span class="p">;</span>
<span class="w">    </span><span class="n">data_mem_read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32&#39;h11451400</span><span class="p">;</span>
<span class="w">    </span><span class="p">#</span><span class="mh">200</span><span class="p">;</span>
<span class="w">    </span><span class="n">wr_cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//read hit</span>
<span class="w">    </span><span class="n">rd_cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mi">&#39;d1</span><span class="p">;</span>
<span class="w">    </span><span class="n">addr_cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32&#39;h00000207</span><span class="p">;</span>
<span class="w">    </span><span class="p">#</span><span class="mh">100</span><span class="p">;</span>
<span class="w">    </span><span class="n">rd_cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mi">&#39;d0</span><span class="p">;</span>



<span class="w">    </span><span class="c1">//write hit</span>
<span class="w">    </span><span class="n">wr_cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mi">&#39;d1</span><span class="p">;</span>
<span class="w">    </span><span class="n">addr_cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32&#39;h00000207</span><span class="p">;</span>
<span class="w">    </span><span class="n">data_cpu_write</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32&#39;hdeadbeef</span><span class="p">;</span>
<span class="w">    </span><span class="p">#</span><span class="mh">120</span><span class="p">;</span>
<span class="w">    </span><span class="n">wr_cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//read miss</span>
<span class="w">    </span><span class="n">rd_cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mi">&#39;d1</span><span class="p">;</span>
<span class="w">    </span><span class="n">addr_cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32&#39;h0000020A</span><span class="p">;</span>
<span class="w">    </span><span class="p">#</span><span class="mh">20</span><span class="p">;</span>
<span class="w">    </span><span class="p">#</span><span class="mh">20</span><span class="p">;</span>
<span class="w">    </span><span class="n">data_mem_read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32&#39;haaaaaaaa</span><span class="p">;</span>
<span class="w">    </span><span class="p">#</span><span class="mh">20</span><span class="p">;</span>
<span class="w">    </span><span class="n">data_mem_read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32&#39;hbbbbbbbb</span><span class="p">;</span>
<span class="w">    </span><span class="p">#</span><span class="mh">20</span><span class="p">;</span>
<span class="w">    </span><span class="n">data_mem_read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32&#39;hcccccccc</span><span class="p">;</span>
<span class="w">    </span><span class="p">#</span><span class="mh">20</span><span class="p">;</span>
<span class="w">    </span><span class="n">data_mem_read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32&#39;hdddddddd</span><span class="p">;</span>
<span class="w">    </span><span class="p">#</span><span class="mh">40</span><span class="p">;</span>
<span class="w">    </span><span class="n">rd_cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">    </span><span class="p">#</span><span class="mh">100</span><span class="p">;</span>

<span class="w">    </span><span class="c1">//read hit</span>
<span class="w">    </span><span class="n">rd_cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mi">&#39;d1</span><span class="p">;</span>
<span class="w">    </span><span class="n">addr_cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32&#39;h00000208</span><span class="p">;</span>
<span class="w">    </span><span class="p">#</span><span class="mh">40</span><span class="p">;</span>
<span class="w">    </span><span class="n">rd_cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">    </span><span class="p">#</span><span class="mh">100</span><span class="p">;</span>
<span class="k">end</span>
<span class="k">always</span><span class="w"> </span><span class="p">#</span><span class="mh">10</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">clk</span><span class="p">;</span>
<span class="k">endmodule</span>
</code></pre></div>
<p>对于 read/write, hit/miss 分别进行仿真</p>
<h2 id="_43">实验结果与分析</h2>
<h3 id="_44">仿真结果</h3>
<p><img alt="" src="../../images/cache/image.png" /></p>
<p><img alt="" src="../../images/cache/image-1.png" /></p>
<p><img alt="alt text" src="../../images/cache/image-4.png" /></p>
<p><img alt="alt text" src="../../images/cache/image-5.png" /></p>
<ol>
<li>
<p>初始 cache 为空</p>
<p>之后向 <code>207</code> 写入值 <code>19198100</code>, 由于原本 <code>207</code> 为空，所以需要与 memory 交互 <span class="arithmatex">\(4\)</span> 个周期, 获得 memory 中对应的 <span class="arithmatex">\(4\)</span> 个 word </p>
<p>再将 <span class="arithmatex">\(4\)</span> 个 word 写入 cache 中，完成 write back 阶段</p>
</li>
<li>
<p>之后再次对比标签，发现 <code>hit</code>, 所以将对应数据块中数据更改，并标记 <code>dirty = 1</code></p>
<p>最后数据块中的 <code>11451400</code> 被改为 <code>19198100</code>
3. 之后读取 <code>207</code> 地址的第 <span class="arithmatex">\(4\)</span> 个 word, 读取到了数据 <code>19198100</code>, 说明读 <code>hit</code>
4. 之后将 <code>207</code> 数据改成 <code>deadbeef</code>, 出现了写 <code>hit</code>
5. 之后换到地址 <code>20A</code> 并读取，出现读 <code>miss</code>, 所以与内存交互 <span class="arithmatex">\(4\)</span> 周期, 将数据写入 cache <br />
6. 之后重新进入 <code>CompareTag</code> 阶段，看到读 <code>hit</code>, 读出了数据 <code>cccccccc</code>
7. 再读 <code>208</code> 地址, 也出现读 <code>hit</code>, 读出数据 <code>aaaaaaaa</code>
8. 再写入 <code>10000207</code> 地址, <code>tag</code> 改变, 重新 <code>allocate</code>, 读取 <span class="arithmatex">\(4\)</span> 个 word 数据
9. 之后写 <code>hit</code>, 并且把第 <span class="arithmatex">\(0\)</span> 组的最近使用位 <code>U = 0</code>, 把第 <span class="arithmatex">\(1\)</span> 组的最近使用位 <code>U = 1, D = 1</code>, 并写入数据 <code>20241225</code>
10. 再写入 <code>20000207</code> 地址, 出现 <code>miss</code>, 由于 <span class="arithmatex">\(0, 1\)</span> 组已满，所以选择最近未使用的 <span class="arithmatex">\(0\)</span> 组进行 <code>write back</code>, 向 memory 写入 <span class="arithmatex">\(4\)</span> 个 word 数据
11. 之后进行 <code>allocate</code>, 读取 <span class="arithmatex">\(4\)</span> 个 word 数据
12. 最后出现写 <code>hit</code>, 写入 <code>07210721</code> 数据</p>
</li>
</ol>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2025 - 2077 AKonjac_
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.60a45f97.min.js"></script>
      
        <script src="../../javascripts/katex.js"></script>
      
        <script src="https://unpkg.com/katex@0/dist/katex.min.js"></script>
      
        <script src="https://unpkg.com/katex@0/dist/contrib/auto-render.min.js"></script>
      
    
  </body>
</html>