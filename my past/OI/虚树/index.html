<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>虚树 - My Docs</title>
        <link href="../../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../../css/brands.min.css" rel="stylesheet">
        <link href="../../../css/solid.min.css" rel="stylesheet">
        <link href="../../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../../..">My Docs</a>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#_1" class="nav-link">虚树</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="_1">虚树</h1>
<blockquote>
<p>模板</p>
</blockquote>
<pre><code class="language-cpp">void insert(int u) {
    int lca=getlca(u,stk[top]);
    while(top&gt;1 &amp;&amp; id[stk[top-1]]&gt;=id[lca]) add(stk[top],stk[top-1],1),add(stk[top-1],stk[top],1),--top;//dep[stk[top-1]]&gt;=dep[lca]也行
    if(lca!=stk[top]) add(stk[top],lca,1),add(lca,stk[top],1),stk[top]=lca;
    stk[++top]=u;
}
void build() {
    cnt[1]=-1;
    sort(a+1,a+m+1,cmp);
    stk[top=1]=a[1];
    for(int i=2; i&lt;=m; ++i) insert(a[i]);
    while(top&gt;1) add(stk[top],stk[top-1],1),add(stk[top-1],stk[top],1),--top;
    rt=stk[1];
}
</code></pre>
<blockquote>
<p>P6572</p>
</blockquote>
<p>树上差分+虚树</p>
<p>对于每个询问，建出虚树后，首先要找出深度最大的公共根，防止将不用的答案记在1（整棵树的根）上，导致出错</p>
<p>hack 数据便是第一个样例</p>
<pre><code class="language-cpp">6 3 2
1 3
2 3
3 4
6 4
4 5
4 1 3 2 5
2 6 3
2 3 2
</code></pre>
<p>方法：</p>
<pre><code class="language-cpp">void getroot(int u,int p){
    if(vis[u])siz[u]=1;
    else siz[u]=0;
    for(int i=head[u];~i;i=e[i].nxt){
        int v=e[i].v;
        if(i&gt;cnt)continue;
        if(v==p)continue;
        getroot(v,u);
        siz[u]+=siz[v];
    }
    if(root==1 &amp;&amp; siz[u]&gt;=s)root=u;//这一步的解释：如果一个点涵盖所有关键点且不是根，则它一定是最小的根（因为更新答案是在回溯时，所以按照从下往上的顺序）
    return;
}

</code></pre>
<p>之后每次深搜到一个点，就向差分数组记录一下，子节点与当前点之间所有的边+1，做完一组询问清零，最后差分数组加起来就是答案</p>
<blockquote>
<p>P3233</p>
</blockquote>
<p>~~关于虚树模板写假了调了一上午这件事~~</p>
<p>这道题及其~~恶心~~复杂,需要$6$次$dfs$。</p>
<ol>
<li>预处理$lca,dep,size$</li>
</ol>
<p>倍增处理$fa$，因为后面除了求$lca$还会用到。</p>
<ol>
<li>求出虚树中每个虚树节点子树中距离此节点最近的"关键节点"</li>
</ol>
<p>所有关键节点都在虚树上，所以第一遍从下而上$dfs$，可以求出每个节点在它子树中距离它最近的关键节点(可以是自己)。</p>
<ol>
<li>求出虚树中距离每个虚树节点最近的"关键节点"</li>
</ol>
<p>第二遍从上而下求出子树外贡献。</p>
<p>注意，我们维护的是一个二元组$g[u]$，第一关键字为距离，第二关键字为编号。</p>
<ol>
<li>求出虚树上每个节点距离最近的点编号，以及节点上的贡献。</li>
</ol>
<p>最近节点就是$num[u]=g[u].second$,而节点上的贡献是指：对于虚树节点$u$，其所有<strong>没有关键点</strong>的子树，都将归$num[u]$管理。</p>
<p>所以，我们遍历虚树时，可以用$u$所在的子树总结点数减去有关键点的子树大小。</p>
<p>有关键点的子树大小需要在原树上倍增求出对于$v$所在子树的根$up[v]$，这时$up[v]$在$u$下面，减掉$sz[up[v]]$即可。</p>
<ol>
<li>求出虚树上每条边的贡献 </li>
</ol>
<p>对于每条边两端点$u,v$，有两种情况：</p>
<p>一是$num[u]=num[v]$,这种情况这条边上所有节点都归$num[u]$管即可。</p>
<p>二是$num[u]\not =num[v]$,这种情况先求出中间点的深度，再从$v$倍增找出中间点标号即可。</p>
<p>具体地，从$num[u]$到$num[v]$的链长度$L$=$dep[num[v]]-dep[u]+g[u].first$.</p>
<p>那么中间点的深度=$\frac{dep[num[v]]-L} 2$.</p>
<ol>
<li>清空虚树及点标记</li>
</ol>
<p>需要清空$vis[i],ans[i],up[i],num[i]$.</p>
<p>至此，这道题才算做完。</p>
<pre><code class="language-cpp">#include&lt;iostream&gt;
#include&lt;cstdio&gt;
#include&lt;cstring&gt;
#include&lt;algorithm&gt;
#include&lt;utility&gt;
using namespace std;
typedef pair&lt;int,int&gt; PI;
const int N=3e5+10,K=20,INF=0x3f3f3f3f;
int fa[N][K],dep[N],head[2][N],vis[N],a[N],b[N],sz[N],stk[N],ans[N],id[N],num[N],up[N];
int n,q,u,v,cnt[2],tmp,m,top,tot,rt;
PI g[N];
struct edge {
    int v,nxt;
} e[2][N&lt;&lt;1];
void add(int u,int v,int i) {
    e[i][++cnt[i]].v=v,e[i][cnt[i]].nxt=head[i][u],head[i][u]=cnt[i];
}
bool cmp(int a,int b) {
    return id[a]&lt;id[b];
}
int read1(){
    int x=0;char ch=getchar();
    while(ch&lt;'0' || ch&gt;'9') ch=getchar();
    while(ch&gt;='0' &amp;&amp; ch&lt;='9') x=(x&lt;&lt;1)+(x&lt;&lt;3)+ch-'0',ch=getchar();
    return x;
}
void write1(int x){
    if(x&gt;9) write1(x/10);
    putchar(x%10+'0');  
}
void dfs0(int u,int p) {
    id[u]=++tot;fa[u][0]=p;sz[u]=1;
    for(int i=1; i&lt;K; ++i) fa[u][i]=fa[fa[u][i-1]][i-1];
    for(int i=head[0][u]; ~i; i=e[0][i].nxt) {
        int v=e[0][i].v;
        if(v==p) continue;
        dep[v]=dep[u]+1;
        dfs0(v,u);
        sz[u]+=sz[v];
    }
}
void dfs1(int u,int p) {
    if(vis[u]) g[u]=make_pair(0,u);
    else g[u]=make_pair(INF,0);
    for(int i=head[1][u]; ~i; i=e[1][i].nxt) {
        int v=e[1][i].v;
        if(v==p) continue;
        dfs1(v,u);
        g[u]=min(g[u],make_pair(g[v].first+dep[v]-dep[u],g[v].second));
    }
}
void dfs2(int u,int p,int d,int x) {
    PI tmp=make_pair(d,x);
    if(tmp&lt;g[u]) g[u]=tmp;
    else d=g[u].first,x=g[u].second;
    for(int i=head[1][u]; ~i; i=e[1][i].nxt) {
        int v=e[1][i].v;
        if(v==p) continue;
        dfs2(v,u,d+dep[v]-dep[u],x);
    }
}
void dfs3(int u,int p) {
    num[u]=g[u].second;
    ans[num[u]]+=sz[u];
    for(int i=head[1][u]; ~i; i=e[1][i].nxt) {
        int v=e[1][i].v;
        if(v==p) continue;
        int k=v;
        for(int j=K-1;j&gt;=0;--j) if(fa[k][j] &amp;&amp; dep[fa[k][j]]&gt;dep[u]) k=fa[k][j];
        ans[num[u]]-=sz[up[v]=k];
        dfs3(v,u);
    }
}
void dfs4(int u,int p){
    for(int i=head[1][u]; ~i; i=e[1][i].nxt) {
        int v=e[1][i].v;
        if(v==p) continue;
        if(num[v]==num[u]) ans[num[u]]+=(sz[up[v]]-sz[v]);
        else{
            int dis=dep[num[v]]+dep[u]-g[u].first;
            dis=dis&amp;1?dis+1&gt;&gt;1:(num[v]&lt;num[u]?dis&gt;&gt;1:(dis&gt;&gt;1)+1);
            int k=v;
            for(int j=K-1;j&gt;=0;--j) if(fa[k][j] &amp;&amp; dep[fa[k][j]]&gt;=dis) k=fa[k][j];
            ans[num[u]]+=sz[up[v]]-sz[k];
            ans[num[v]]+=sz[k]-sz[v];
        }
        dfs4(v,u);
    }
}
void dfs5(int u,int p){//clear
    up[u]=num[u]=0;
    for(int i=head[1][u]; ~i; i=e[1][i].nxt) {
        int v=e[1][i].v;
        if(v==p) continue;
        dfs5(v,u);
    }
    head[1][u]=-1;
}
int getlca(int u,int v) {
    if(dep[u]&lt;dep[v]) swap(u,v);
    int k=dep[u]-dep[v];
    for(int i=K-1; i&gt;=0; --i) if(k&amp;(1&lt;&lt;i)) u=fa[u][i];
    if(v==u) return u;
    for(int i=K-1; i&gt;=0; --i) if(fa[u][i]!=fa[v][i]) u=fa[u][i],v=fa[v][i];
    return fa[u][0];
}
void insert(int u) {
    int lca=getlca(u,stk[top]);
    while(top&gt;1 &amp;&amp; id[stk[top-1]]&gt;=id[lca]) add(stk[top],stk[top-1],1),add(stk[top-1],stk[top],1),--top;
    if(lca!=stk[top]) add(stk[top],lca,1),add(lca,stk[top],1),stk[top]=lca;
    stk[++top]=u;
}
void build() {
    cnt[1]=-1;
    sort(a+1,a+m+1,cmp);
    stk[top=1]=a[1];
    for(int i=2; i&lt;=m; ++i) insert(a[i]);
    while(top&gt;1) add(stk[top],stk[top-1],1),add(stk[top-1],stk[top],1),--top;
    rt=stk[1];
}
int main() {
    memset(head,-1,sizeof head);
    cnt[0]=-1;
    scanf(&quot;%d&quot;,&amp;n);
    for(int i=1; i&lt;n; ++i) scanf(&quot;%d%d&quot;,&amp;u,&amp;v),add(u,v,0),add(v,u,0);
    dfs0(1,0);
    scanf(&quot;%d&quot;,&amp;q);
    for(int i=1; i&lt;=q; ++i) {
        scanf(&quot;%d&quot;,&amp;m);
        for(int j=1; j&lt;=m; ++j) scanf(&quot;%d&quot;,&amp;a[j]),b[j]=a[j],vis[b[j]]=1;
        build();
        dfs1(rt,0);
        dfs2(rt,0,g[rt].first,g[rt].second);
        dfs3(rt,0);
        dfs4(rt,0);
        ans[num[rt]]+=sz[1]-sz[rt];
        for(int j=1; j&lt;=m; ++j) printf(&quot;%d &quot;,ans[b[j]]),ans[b[j]]=vis[b[j]]=0;printf(&quot;\n&quot;);
        dfs5(rt,0);
    }
    return 0;
}


</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../js/base.js"></script>
        <script src="../../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
